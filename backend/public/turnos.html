<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agendar Turno de Lavado de Autos en Reconquista | Reserva Online | Daytona Clean Service</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Agend√° tu turno de lavado de autos en Reconquista online. Reserva f√°cil y r√°pido para limpieza de veh√≠culos, tapizados y detailing. ¬°Servicio a domicilio!" />
  <meta name="keywords" content="agendar turno lavado autos Reconquista, reserva online lavado, turnos lavado autos, agendar limpieza tapizados, reserva detailing Reconquista, turnos servicio domicilio, agendar Daytona Clean Service" />
  <meta name="author" content="Daytona Clean Service - Benjam√≠n Gianneschi" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="Spanish" />
  <meta name="geo.region" content="AR-SF" />
  <meta name="geo.placename" content="Reconquista, Santa Fe, Argentina" />
  <meta name="geo.position" content="-29.153022;-59.639699" />
  <meta name="ICBM" content="-29.153022, -59.639699" />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Agendar Turno de Lavado de Autos en Reconquista" />
  <meta property="og:description" content="Agend√° tu turno de lavado de autos online. Reserva f√°cil para limpieza de veh√≠culos y tapizados en Reconquista." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://daytona.com.ar/turnos.html" />
  <meta property="og:site_name" content="Daytona Clean Service" />
  <meta property="og:locale" content="es_AR" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Agendar Turno Lavado de Autos Reconquista" />
  <meta name="twitter:description" content="Agend√° tu turno de lavado de autos online. Reserva f√°cil en Reconquista." />
  
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ReservationPage",
    "name": "Agendar Turno de Lavado de Autos",
    "description": "P√°gina para agendar turnos de lavado de autos y limpieza de tapizados en Reconquista",
    "provider": {
      "@type": "LocalBusiness",
      "name": "Daytona Clean Service",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Ituzaingo 1455",
        "addressLocality": "Reconquista",
        "addressRegion": "Santa Fe",
        "addressCountry": "AR"
      },
      "telephone": "+5493482588383"
    },
    "areaServed": "Reconquista, Santa Fe, Argentina",
    "serviceType": ["Lavado de Autos", "Limpieza de Tapizados", "Detailing"],
    "availableService": [
      {
        "@type": "Service",
        "name": "Limpieza Convencional",
        "price": "20000",
        "priceCurrency": "ARS"
      },
      {
        "@type": "Service",
        "name": "Limpieza Detallada",
        "price": "100000",
        "priceCurrency": "ARS"
      },
      {
        "@type": "Service",
        "name": "Limpieza de Tapizados",
        "price": "100000",
        "priceCurrency": "ARS"
      }
    ]
  }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/components/header.css" />
  <link rel="stylesheet" href="css/vehiculos.css">
  <link rel="stylesheet" href="css/tapizados.css">
  <link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
  <script src="js/turnos-service.js"></script>
  <style>
    body {
      background: #181818;
      color: #fff;
      font-family: 'Roboto', Arial, sans-serif;
      min-height: 100vh;
    }
    .wizard-step {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #fff;
      font-weight: 500;
      padding: 10px 0;
    }
    .wizard-step.active {
      color: #ff3b3f;
    }
    .wizard-bar {
      height: 4px;
      background: linear-gradient(90deg, #ff3b3f 0%, #b31217 100%);
      border-radius: 2px;
      margin-bottom: 30px;
    }
    .card-turno {
      background: #232323;
      border-radius: 12px;
      border: 1.5px solid #ff3b3f;
      margin-bottom: 24px;
      padding: 24px;
      color: #fff;
    }
    .servicio-card {
      background: #232323;
      border: 1.5px solid #ff3b3f;
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 18px;
      cursor: pointer;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .servicio-card.selected, .servicio-card:hover {
      border: 2.5px solid #ff3b3f;
      box-shadow: 0 0 12px #ff3b3f44;
    }
    .servicio-precio {
      color: #ff3b3f;
      font-weight: 700;
      font-size: 1.2rem;
    }
    .step-btn {
      background: #ff3b3f;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 28px;
      font-weight: 600;
      margin-top: 18px;
      transition: background 0.2s;
    }
    .step-btn:hover {
      background: #b31217;
    }
    .step-btn[disabled] {
      background: #444;
      color: #bbb;
      cursor: not-allowed;
    }
    .resumen-turno {
      background: #232323;
      border: 1.5px solid #ff3b3f;
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 18px;
    }
    .form-label {
      color: #fff;
      font-weight: 500;
    }
    .form-control, .form-select {
      background: #232323;
      color: #fff;
      border: 1px solid #444;
    }
    .form-control:focus, .form-select:focus {
      border-color: #ff3b3f;
      box-shadow: 0 0 0 0.2rem #ff3b3f33;
    }
    .wizard-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      gap: 10px;
    }
    @media (max-width: 600px) {
      .wizard-nav {
        flex-direction: column;
        gap: 8px;
      }
      .card-turno, .resumen-turno {
        padding: 12px 8px;
      }
      .container.py-5 {
        margin-top: 70px !important;
        padding-top: 20px !important;
      }
    }
    .wizard-progress-container {
      width: 100%;
      margin-bottom: 32px;
    }
    .wizard-bar-bg {
      width: 100%;
      height: 7px;
      background: #232323;
      border-radius: 4px;
      position: relative;
      margin-bottom: 18px;
      overflow: hidden;
    }
    .wizard-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff3b3f 0%, #b31217 100%);
      border-radius: 4px;
      width: 0%;
      transition: width 0.4s cubic-bezier(.4,1.3,.6,1);
    }
    .wizard-nav-modern {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      position: relative;
      z-index: 2;
    }
    .wizard-step-modern {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      color: #fff;
      font-weight: 500;
      font-size: 0.98rem;
      position: relative;
      z-index: 2;
    }
    .wizard-icon-circle {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #232323;
      border: 2.5px solid #b31217;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      margin-bottom: 6px;
      color: #ff3b3f;
      transition: border 0.3s, background 0.3s, color 0.3s;
    }
    .wizard-step-modern.active .wizard-icon-circle {
      background: #ff3b3f;
      color: #fff;
      border: 2.5px solid #ff3b3f;
      box-shadow: 0 0 8px #ff3b3f66;
    }
    .wizard-step-modern.completed .wizard-icon-circle {
      background: #b31217;
      color: #fff;
      border: 2.5px solid #b31217;
    }
    .wizard-step-modern span {
      font-size: 0.93rem;
      margin-top: 2px;
      color: #fff;
    }
    @media (max-width: 600px) {
      .wizard-nav-modern {
        flex-direction: column;
        gap: 10px;
      }
      .wizard-step-modern {
        flex-direction: row;
        gap: 10px;
        align-items: center;
        width: 100%;
        justify-content: flex-start;
      }
      .wizard-step-modern span {
        margin-top: 0;
      }
    }
    /* Contenedor visual moderno para el turnero */
    .turnero-contenedor-moderno {
      background: #232323;
      border-radius: 18px;
      padding: 32px 24px 80px 24px;
      margin: 0 auto 32px auto;
      position: relative;
      min-height: 600px;
      max-width: 500px;
    }
    .wizard-content-moderno {
      min-height: 320px;
    }
    .turnero-botones-fijos {
      /* position: absolute; */
      position: static;
      left: unset;
      right: unset;
      bottom: unset;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      background: linear-gradient(0deg, #181818 90%, #23232300 100%);
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      z-index: 10;
      min-height: 70px;
      margin-top: 32px;
    }
    .turnero-botones-fijos .btn,
    .turnero-botones-fijos .step-btn {
      min-width: 120px;
      margin: 0;
    }
    @media (max-width: 600px) {
      .turnero-contenedor-moderno {
        padding: 16px 4px 80px 4px;
        min-height: 400px;
        max-width: 100vw;
      }
      .turnero-botones-fijos {
        padding: 10px 6px;
        min-height: 60px;
      }
      .turnero-botones-fijos .btn,
      .turnero-botones-fijos .step-btn {
        min-width: 90px;
        font-size: 0.95rem;
      }
    }
    /* Dropdown de servicios con iconos */
    .servicio-dropdown {
      font-size: 1.1rem;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1.5px solid #ff3b3f;
      background: #232323;
      color: #fff;
      margin-bottom: 10px;
    }
    .servicio-dropdown:focus {
      border-color: #ff3b3f;
      box-shadow: 0 0 0 0.2rem #ff3b3f33;
    }
    
    /* Estilos para el selector de tipo de servicio */
    #tipo-servicio .btn {
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    #tipo-servicio .btn-outline-primary {
      border-color: #17a2b8;
      color: #17a2b8;
    }
    
    #tipo-servicio .btn-outline-primary:hover,
    #tipo-servicio .btn-check:checked + .btn-outline-primary {
      background-color: #17a2b8;
      border-color: #17a2b8;
      color: white;
    }
    
    #tipo-servicio .btn-outline-warning {
      border-color: #ffc107;
      color: #ffc107;
    }
    
    #tipo-servicio .btn-outline-warning:hover,
    #tipo-servicio .btn-check:checked + .btn-outline-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #212529;
    }
    
    /* Estilos para el detalle del servicio */
    #servicio-detalle .bg-dark {
      background: linear-gradient(135deg, #232323, #1a1a1a) !important;
      border: 1px solid #333;
    }
    
    #servicio-detalle .badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    /* Estilos para optgroup en el dropdown */
    .servicio-dropdown optgroup {
      font-weight: bold;
      color: #ff3b3f;
    }
    
    .servicio-dropdown option {
      padding: 8px;
    }
    #servicio-detalle {
      font-size: 1.05rem;
      background: #232323;
      border: 1.5px solid #ff3b3f;
      border-radius: 8px;
      margin-top: 8px;
      min-height: 48px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #servicio-detalle i {
      font-size: 1.5rem;
      color: #ff3b3f;
      margin-right: 10px;
    }
    /* Botones iguales y bien ubicados */
    .turnero-botones-fijos .btn,
    .turnero-botones-fijos .step-btn {
      min-width: 140px;
      max-width: 180px;
      font-size: 1.08rem;
      border-radius: 8px;
      padding: 12px 0;
      margin: 0;
      box-sizing: border-box;
    }
    .turnero-botones-fijos {
      justify-content: space-between;
    }

    /* Estilos para el selector de categor√≠as - REDUCIDO */
    .categoria-selector {
      margin-bottom: 1.5rem;
    }

    .categoria-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border: 2px solid #333;
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      height: 100%;
    }

    .categoria-card:hover {
      border-color: #ff3b3f;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 59, 63, 0.2);
    }

    .categoria-card.selected {
      border-color: #ff3b3f;
      background: linear-gradient(135deg, #ff3b3f 0%, #e63946 100%);
      color: white;
    }

    .categoria-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: #ff3b3f;
    }

    .categoria-card.selected .categoria-icon {
      color: white;
    }

    .categoria-card h5 {
      margin-bottom: 0.3rem;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .categoria-card p {
      margin-bottom: 0;
      font-size: 0.8rem;
      line-height: 1.2;
    }

    /* Estilos para las listas de servicios */
    .servicios-container {
      animation: fadeIn 0.3s ease-in;
    }

    .servicios-lista {
      max-height: 400px;
      overflow-y: auto;
    }

    .servicio-item {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border: 2px solid #333;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .servicio-item:hover {
      border-color: #ff3b3f;
      transform: translateX(5px);
    }

    .servicio-item.selected {
      border-color: #ff3b3f;
      background: linear-gradient(135deg, #ff3b3f 0%, #e63946 100%);
      color: white;
    }

    .servicio-info {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .servicio-icon {
      font-size: 1.2rem;
      margin-right: 1rem;
      color: #ff3b3f;
      width: 30px;
      text-align: center;
    }

    .servicio-item.selected .servicio-icon {
      color: white;
    }

    .servicio-details h6 {
      margin: 0;
      font-weight: 600;
      font-size: 1rem;
    }

    .servicio-details p {
      margin: 0;
      font-size: 0.85rem;
      color: #ccc;
    }

    .servicio-item.selected .servicio-details p {
      color: rgba(255, 255, 255, 0.8);
    }

    .servicio-precio {
      font-size: 1rem;
      font-weight: 700;
      color: #ff3b3f;
      text-align: right;
    }

    .servicio-item.selected .servicio-precio {
      color: white;
    }

    /* Animaciones */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Servicios seleccionados */
    .servicio-seleccionado {
      background: linear-gradient(135deg, #ff3b3f 0%, #e63946 100%);
      border: 2px solid #ff3b3f;
      border-radius: 8px;
      padding: 0.75rem;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .servicio-seleccionado .btn-remove {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .servicio-seleccionado .btn-remove:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div id="header-container"></div>
  <div class="container py-5" style="max-width: 600px; margin-top: 80px;">
    <div class="turnero-contenedor-moderno">
      <h1 class="fw-bold text-center mb-2" style="color: #fff;">Agenda tu Turno</h1>
      <p class="text-center mb-4" style="color: #fff;">Reserva tu cita de forma r√°pida y sencilla. Te confirmaremos por WhatsApp y te enviaremos recordatorios autom√°ticos.</p>
      
      <!-- Wizard Steps -->
      <div class="wizard-progress-container mb-4">
        <div class="wizard-bar-bg">
          <div class="wizard-bar-fill" id="wizard-bar-fill"></div>
        </div>
        <div class="wizard-nav-modern">
          <div class="wizard-step-modern" id="step-indicator-1">
            <div class="wizard-icon-circle"><i class="fas fa-cogs"></i></div>
            <span>Servicio</span>
          </div>
          <div class="wizard-step-modern" id="step-indicator-2">
            <div class="wizard-icon-circle"><i class="fas fa-user"></i></div>
            <span>Agente</span>
          </div>
          <div class="wizard-step-modern" id="step-indicator-3">
            <div class="wizard-icon-circle"><i class="fas fa-calendar-alt"></i></div>
            <span>Turno</span>
          </div>
          <div class="wizard-step-modern" id="step-indicator-4">
            <div class="wizard-icon-circle"><i class="fas fa-user-edit"></i></div>
            <span>Datos</span>
          </div>
          <div class="wizard-step-modern" id="step-indicator-5">
            <div class="wizard-icon-circle"><i class="fas fa-map-marker-alt"></i></div>
            <span>Ubicaci√≥n</span>
          </div>
          <div class="wizard-step-modern" id="step-indicator-6">
            <div class="wizard-icon-circle"><i class="fas fa-check-circle"></i></div>
            <span>Confirmar</span>
          </div>
        </div>
      </div>
      <!-- Fin Wizard Steps -->
      <div class="wizard-bar"></div>
      <!-- Wizard Content -->
      <div id="wizard-content">
        <!-- Paso 1: Seleccionar Servicio -->
        <div id="step-1">
          <h3 class="mb-4">¬øQu√© tipo de servicio necesitas?</h3>
          
          <!-- Selector de categor√≠a principal -->
          <div class="categoria-selector mb-4">
            <div class="row g-3">
              <div class="col-6">
                <div class="categoria-card" id="categoria-vehiculos" data-categoria="vehiculos">
                  <div class="categoria-icon">
                    <i class="fas fa-car"></i>
                  </div>
                  <h5>Veh√≠culos</h5>
                  <p class="text-muted">Lavado, limpieza y tapizado de autos, pickups y SUVs</p>
                </div>
              </div>
              <div class="col-6">
                <div class="categoria-card" id="categoria-tapizados" data-categoria="tapizados">
                  <div class="categoria-icon">
                    <i class="fas fa-couch"></i>
                  </div>
                  <h5>Tapizados</h5>
                  <p class="text-muted">Limpieza de sillones, sillas, colchones y alfombras</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Servicios de Veh√≠culos -->
          <div id="servicios-vehiculos" class="servicios-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4><i class="fas fa-car me-2"></i>Servicios de Veh√≠culos</h4>
              <button class="btn btn-outline-secondary btn-sm" onclick="cambiarCategoria()">
                <i class="fas fa-arrow-left me-1"></i>Cambiar categor√≠a
              </button>
            </div>
            
            <div class="servicios-lista" id="lista-servicios-vehiculos">
              <!-- Los servicios se cargar√°n din√°micamente desde la BD -->
            </div>
          </div>

          <!-- Servicios de Tapizados -->
          <div id="servicios-tapizados" class="servicios-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4><i class="fas fa-couch me-2"></i>Servicios de Tapizados</h4>
              <button class="btn btn-outline-secondary btn-sm" onclick="cambiarCategoria()">
                <i class="fas fa-arrow-left me-1"></i>Cambiar categor√≠a
              </button>
            </div>
            
            <div class="servicios-lista" id="lista-servicios-tapizados">
              <!-- Los servicios se cargar√°n din√°micamente desde la BD -->
            </div>
          </div>

          <!-- Servicios seleccionados -->
          <div id="servicios-seleccionados" class="mt-4" style="display: none;">
            <h5>Servicios seleccionados:</h5>
            <div id="lista-servicios" class="row g-2"></div>
          </div>

          <!-- Botones de tipo de sill√≥n (aparecen solo cuando se selecciona Limpieza de Sillones) -->
          <div id="sillon-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de sill√≥n:</strong></div>
            <div class="btn-group" role="group" id="sillon-tipos">
              <input type="radio" class="btn-check" name="sillon-tipo" id="sillon-1cuerpo" value="1 cuerpo" autocomplete="off">
              <label class="btn btn-outline-primary" for="sillon-1cuerpo">
                <i class="fas fa-couch me-1"></i>1 Cuerpo
              </label>
              
              <input type="radio" class="btn-check" name="sillon-tipo" id="sillon-2cuerpos" value="2 cuerpos" autocomplete="off">
              <label class="btn btn-outline-primary" for="sillon-2cuerpos">
                <i class="fas fa-couch me-1"></i>2 Cuerpos
              </label>
              
              <input type="radio" class="btn-check" name="sillon-tipo" id="sillon-3cuerpos" value="3 cuerpos" autocomplete="off">
              <label class="btn btn-outline-primary" for="sillon-3cuerpos">
                <i class="fas fa-couch me-1"></i>3 Cuerpos
              </label>
              

            </div>
          </div>

          <!-- Botones de tipo de silla (aparecen solo cuando se selecciona Limpieza de Sillas) -->
          <div id="silla-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de silla:</strong></div>
            <div class="btn-group" role="group" id="silla-tipos">
              <input type="radio" class="btn-check" name="silla-tipo" id="silla-simple" value="simple" autocomplete="off">
              <label class="btn btn-outline-primary" for="silla-simple">
                <i class="fas fa-chair me-1"></i>Simple
              </label>
              
              <input type="radio" class="btn-check" name="silla-tipo" id="silla-comedor" value="comedor" autocomplete="off">
              <label class="btn btn-outline-primary" for="silla-comedor">
                <i class="fas fa-chair me-1"></i>Comedor
              </label>
            </div>
          </div>

          <!-- Botones de tipo de colch√≥n (aparecen solo cuando se selecciona Limpieza de Colchones) -->
          <div id="colchon-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de colch√≥n:</strong></div>
            <div class="btn-group" role="group" id="colchon-tipos">
              <input type="radio" class="btn-check" name="colchon-tipo" id="colchon-1plaza" value="1 plaza" autocomplete="off">
              <label class="btn btn-outline-primary" for="colchon-1plaza">
                <i class="fas fa-bed me-1"></i>1 Plaza
              </label>
              
              <input type="radio" class="btn-check" name="colchon-tipo" id="colchon-2plazas" value="2 plazas" autocomplete="off">
              <label class="btn btn-outline-primary" for="colchon-2plazas">
                <i class="fas fa-bed me-1"></i>2 Plazas
              </label>
              

            </div>
          </div>

          <!-- Botones de tipo de veh√≠culo (aparecen solo cuando se selecciona Limpieza de Veh√≠culo) -->
          <div id="vehiculo-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de veh√≠culo:</strong></div>
            <div class="btn-group" role="group" id="vehiculo-tipos">
              <input type="radio" class="btn-check" name="vehiculo-tipo" id="vehiculo-auto" value="auto" autocomplete="off">
              <label class="btn btn-outline-primary" for="vehiculo-auto">
                <i class="fas fa-car me-1"></i>Auto
              </label>
              <input type="radio" class="btn-check" name="vehiculo-tipo" id="vehiculo-suv" value="suv" autocomplete="off">
              <label class="btn btn-outline-primary" for="vehiculo-suv">
                <i class="fas fa-car-side me-1"></i>SUV
              </label>
              <input type="radio" class="btn-check" name="vehiculo-tipo" id="vehiculo-pickup" value="pickup" autocomplete="off">
              <label class="btn btn-outline-primary" for="vehiculo-pickup">
                <i class="fas fa-truck-pickup me-1"></i>Pickup
              </label>
            </div>
          </div>

          <!-- Botones de tipo de tapizado de veh√≠culo (aparecen solo cuando se selecciona Limpieza de Tapizado de Veh√≠culo) -->
          <div id="tapizadovehiculo-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de veh√≠culo para tapizado:</strong></div>
            <div class="btn-group" role="group" id="tapizadovehiculo-tipos">
              <input type="radio" class="btn-check" name="tapizadovehiculo-tipo" id="tapizadovehiculo-auto" value="auto" autocomplete="off">
              <label class="btn btn-outline-primary" for="tapizadovehiculo-auto">
                <i class="fas fa-car me-1"></i>Auto
              </label>
              <input type="radio" class="btn-check" name="tapizadovehiculo-tipo" id="tapizadovehiculo-suv" value="suv" autocomplete="off">
              <label class="btn btn-outline-primary" for="tapizadovehiculo-suv">
                <i class="fas fa-car-side me-1"></i>SUV
              </label>
              <input type="radio" class="btn-check" name="tapizadovehiculo-tipo" id="tapizadovehiculo-pickup" value="pickup" autocomplete="off">
              <label class="btn btn-outline-primary" for="tapizadovehiculo-pickup">
                <i class="fas fa-truck-pickup me-1"></i>Pickup
              </label>
            </div>
          </div>
          <div id="tapizadovehiculos-seleccionados" class="mb-3"></div>
          <div id="tapizadovehiculos-total" class="fw-bold mt-3"></div>

          <!-- Botones de tipo de motor (aparecen solo cuando se selecciona Limpieza de Motor) -->
          <div id="motor-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de limpieza de motor:</strong></div>
            <div class="btn-group" role="group" id="motor-tipos">
              <input type="radio" class="btn-check" name="motor-tipo" id="motor-completa" value="completa" autocomplete="off">
              <label class="btn btn-outline-primary" for="motor-completa">
                <i class="fas fa-gears me-1"></i>Completa
              </label>
              
              <input type="radio" class="btn-check" name="motor-tipo" id="motor-detallada" value="detallada" autocomplete="off">
              <label class="btn btn-outline-primary" for="motor-detallada">
                <i class="fas fa-gears me-1"></i>Detallada
              </label>
            </div>
          </div>

          <!-- Campo para ingresar metros cuadrados -->
          <div id="metros-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Ingres√° los metros cuadrados:</strong></div>
            <div class="input-group">
              <input type="number" class="form-control" id="metros-input" placeholder="Ej: 6" min="1" step="0.1">
              <span class="input-group-text">m¬≤</span>
            </div>
            <small class="text-muted">Ejemplo: 2m x 3m = 6m¬≤</small>
          </div>

          <!-- Botones de tipo de puff (aparecen solo cuando se selecciona Limpieza de Puff) -->
          <div id="puff-tipos-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de puff:</strong></div>
            <div class="btn-group" role="group" id="puff-tipos">
              <input type="radio" class="btn-check" name="puff-tipo" id="puff-simple" value="simple" autocomplete="off">
              <label class="btn btn-outline-primary" for="puff-simple">
                <i class="fas fa-couch me-1"></i>Simple
              </label>
              
              <input type="radio" class="btn-check" name="puff-tipo" id="puff-grande" value="grande" autocomplete="off">
              <label class="btn btn-outline-primary" for="puff-grande">
                <i class="fas fa-couch me-1"></i>Grande
              </label>
              
              <input type="radio" class="btn-check" name="puff-tipo" id="puff-especial" value="especial" autocomplete="off">
              <label class="btn btn-outline-primary" for="puff-especial">
                <i class="fas fa-couch me-1"></i>Especial
              </label>
            </div>
          </div>

          <!-- Selecci√≥n de tipo de servicio (Est√°ndar/Especial) -->
          <div id="tipo-servicio-container" style="display:none;" class="mb-3">
            <div class="mb-2"><strong>Eleg√≠ el tipo de servicio:</strong></div>
            <div class="btn-group w-100" role="group" id="tipo-servicio">
              <input type="radio" class="btn-check" name="tipo-servicio" id="tipo-estandar" value="estandar" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="tipo-estandar">
                <i class="fas fa-star me-1"></i>Est√°ndar
              </label>
              
              <input type="radio" class="btn-check" name="tipo-servicio" id="tipo-especial" value="especial" autocomplete="off">
              <label class="btn btn-outline-warning" for="tipo-especial">
                <i class="fas fa-crown me-1"></i>Especial
              </label>
            </div>
          </div>

          <!-- Detalle del servicio seleccionado -->
          <div id="servicio-detalle" class="mb-3" style="display:none;">
            <!-- El contenido se genera din√°micamente -->
          </div>

          <!-- Cards de sillones seleccionados -->
          <div id="sillones-seleccionados" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>

          <!-- Cards de sillas seleccionadas -->
          <div id="sillas-seleccionadas" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>

          <!-- Cards de colchones seleccionados -->
          <div id="colchones-seleccionados" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>

          <!-- Cards de veh√≠culos seleccionados -->
          <div id="vehiculos-seleccionados" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>

          <!-- Cards de motores seleccionados -->
          <div id="motores-seleccionados" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>

          <!-- Cards de alfombras seleccionadas -->
          <div id="alfombras-seleccionadas" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>

          <!-- Cards de puffs seleccionados -->
          <div id="puffs-seleccionados" class="mb-3">
            <!-- Las cards se generan din√°micamente -->
          </div>
          
          <div id="sillones-total" class="fw-bold mt-3"></div>
          <div id="sillas-total" class="fw-bold mt-3"></div>
          <div id="colchones-total" class="fw-bold mt-3"></div>
          <div id="vehiculos-total" class="fw-bold mt-3"></div>
          <div id="motores-total" class="fw-bold mt-3"></div>
          <div id="alfombras-total" class="fw-bold mt-3"></div>
          <div id="puffs-total" class="fw-bold mt-3"></div>
          
          <!-- Resumen final de todos los servicios -->
          <div id="resumen-final" class="mt-4" style="display:none; margin-bottom: 1.5rem;">
            <div class="card-turno">
              <h5 class="mb-3">
                <i class="fas fa-list-ul me-2 text-danger"></i>
                Resumen de Servicios
              </h5>
              <div id="lista-servicios" class="mb-3">
                <!-- Los servicios se mostrar√°n aqu√≠ -->
              </div>
              <hr style="border-color: #ff3b3f;">
              <div class="d-flex justify-content-between align-items-center">
                <strong class="text-white">Total General:</strong>
                <strong class="text-danger fs-4" id="total-general">$0</strong>
              </div>
            </div>
          </div>
        </div>
        <!-- Paso 2: Seleccionar Profesional -->
        <div id="step-2" style="display:none;">
          <h3 class="mb-3">Seleccionar Profesional</h3>
          <div class="servicio-card selected" id="profesional-benjamin" data-nombre="Benjam√≠n Gianneschi">
            <div class="d-flex align-items-center">
              <i class="fas fa-user-circle fa-2x me-3"></i>
              <div>
                <strong>Benjam√≠n Gianneschi</strong>
                <div class="text-muted small">Especialista en limpieza profesional</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Paso 3: Seleccionar Fecha y Hora -->
        <div id="step-3" style="display:none;">
          <h3 class="mb-3">Seleccionar Fecha y Hora</h3>
          
          <!-- Informaci√≥n sobre turnos separados -->
          <div id="info-turnos-separados" class="alert alert-info mb-4" style="display:none; background: #232323; color: #fff; border: 1.5px solid #17a2b8;">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Turnos Separados:</strong> Has seleccionado servicios de diferentes categor√≠as. 
            Los servicios de veh√≠culos y tapizados se realizar√°n en turnos separados para optimizar el tiempo y la calidad del servicio.
          </div>
          
          <!-- Turno para Veh√≠culos -->
          <div id="turno-vehiculos" style="display:none;">
            <div class="card-turno mb-4">
              <h5 class="mb-3">
                <i class="fas fa-car me-2 text-danger"></i>
                Turno para Servicios de Veh√≠culos
              </h5>
              <div id="servicios-vehiculos-resumen" class="mb-3"></div>
              <form id="fecha-hora-vehiculos-form">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="fecha-vehiculos" class="form-label">Fecha *</label>
                    <input type="date" class="form-control" id="fecha-vehiculos" min="" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="hora-vehiculos" class="form-label">Hora *</label>
                    <select class="form-select" id="hora-vehiculos" required>
                      <option value="">Selecciona una hora</option>
                      <option>09:00</option>
                      <option>10:00</option>
                      <option>11:00</option>
                      <option>12:00</option>
                      <option>13:00</option>
                      <option>14:00</option>
                      <option>15:00</option>
                      <option>16:00</option>
                      <option>17:00</option>
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Turno para Tapizados -->
          <div id="turno-tapizados" style="display:none;">
            <div class="card-turno mb-4">
              <h5 class="mb-3">
                <i class="fas fa-couch me-2 text-danger"></i>
                Turno para Servicios de Tapizados
              </h5>
              <div id="servicios-tapizados-resumen" class="mb-3"></div>
              <form id="fecha-hora-tapizados-form">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="fecha-tapizados" class="form-label">Fecha *</label>
                    <input type="date" class="form-control" id="fecha-tapizados" min="" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="hora-tapizados" class="form-label">Hora *</label>
                    <select class="form-select" id="hora-tapizados" required>
                      <option value="">Selecciona una hora</option>
                      <option>09:00</option>
                      <option>10:00</option>
                      <option>11:00</option>
                      <option>12:00</option>
                      <option>13:00</option>
                      <option>14:00</option>
                      <option>15:00</option>
                      <option>16:00</option>
                      <option>17:00</option>
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Turno √∫nico (cuando solo hay una categor√≠a) -->
          <div id="turno-unico" style="display:none;">
            <form id="fecha-hora-form">
              <div class="mb-3">
                <label for="fecha" class="form-label">Fecha *</label>
                <input type="date" class="form-control" id="fecha" min="" required />
              </div>
              <div class="mb-3">
                <label for="hora" class="form-label">Hora *</label>
                <select class="form-select" id="hora" required>
                  <option value="">Selecciona una hora</option>
                  <option>09:00</option>
                  <option>10:00</option>
                  <option>11:00</option>
                  <option>12:00</option>
                  <option>13:00</option>
                  <option>14:00</option>
                  <option>15:00</option>
                  <option>16:00</option>
                  <option>17:00</option>
                </select>
              </div>
            </form>
          </div>
        </div>
        <!-- Paso 4: Datos Personales -->
        <div id="step-4" style="display:none;">
          <h3 class="mb-3">Datos Personales</h3>
          
          <!-- Mensaje para usuarios logueados -->
          <div id="usuario-logueado-info" class="alert alert-info mb-4" style="display:none; background: #232323; color: #fff; border: 1.5px solid #17a2b8;">
            <i class="fas fa-user-check me-2"></i>
            <strong>¬°Bienvenido de vuelta!</strong> Tus datos han sido auto-completados desde tu cuenta. 
            Puedes modificarlos si es necesario.
          </div>
          
          <form id="datos-personales-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label">Nombre *</label>
                <input type="text" class="form-control" id="nombre" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="apellido" class="form-label">Apellido *</label>
                <input type="text" class="form-control" id="apellido" required />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="telefono" class="form-label">Tel√©fono *</label>
                <input type="tel" class="form-control" id="telefono" placeholder="+54 9 3482 123456" required />
                <small class="text-muted">Para confirmar tu turno por WhatsApp</small>
              </div>
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="tu@email.com" />
                <small class="text-muted">Opcional - Para enviarte recordatorios</small>
              </div>
            </div>
          </form>
        </div>
        
        <!-- Paso 5: Ubicaci√≥n del Servicio -->
        <div id="step-5" style="display:none;">
          <h3 class="mb-3">Ubicaci√≥n del Servicio</h3>
          
          <!-- Ubicaci√≥n para Veh√≠culos -->
          <div id="ubicacion-vehiculos" style="display:none;">
            <div class="card-turno mb-4">
              <h5 class="mb-3">
                <i class="fas fa-car me-2 text-danger"></i>
                Ubicaci√≥n para Servicios de Veh√≠culos
              </h5>
              <div id="ubicacion-vehiculos-container">
                <!-- Los campos se mostrar√°n din√°micamente -->
              </div>
            </div>
          </div>
          
          <!-- Ubicaci√≥n para Tapizados -->
          <div id="ubicacion-tapizados" style="display:none;">
            <div class="card-turno mb-4">
              <h5 class="mb-3">
                <i class="fas fa-couch me-2 text-danger"></i>
                Ubicaci√≥n para Servicios de Tapizados
              </h5>
              <div id="ubicacion-tapizados-container">
                <!-- Los campos se mostrar√°n din√°micamente -->
              </div>
            </div>
          </div>
          
          <!-- Ubicaci√≥n √∫nica (cuando solo hay una categor√≠a) -->
          <div id="ubicacion-unica" style="display:none;">
            <div id="ubicacion-container">
              <!-- Los campos se mostrar√°n din√°micamente seg√∫n el tipo de servicio -->
            </div>
          </div>
        </div>
        <!-- Paso 6: Confirmar -->
        <div id="step-6" style="display:none;">
          <h3 class="mb-3">Confirmar Turnos</h3>
          
          <!-- Resumen de turnos separados -->
          <div id="resumen-turnos-separados" style="display:none;">
            <div class="card-turno mb-4">
              <h5 class="mb-3">
                <i class="fas fa-car me-2 text-danger"></i>
                Turno para Servicios de Veh√≠culos
              </h5>
              <div id="resumen-turno-vehiculos"></div>
            </div>
            
            <div class="card-turno mb-4">
              <h5 class="mb-3">
                <i class="fas fa-couch me-2 text-danger"></i>
                Turno para Servicios de Tapizados
              </h5>
              <div id="resumen-turno-tapizados"></div>
            </div>
          </div>
          
          <!-- Resumen de turno √∫nico -->
          <div id="resumen-turno-unico" style="display:none;">
            <div class="resumen-turno" id="resumen-turno"></div>
          </div>
          
          <div id="resumen-final" class="mt-4" style="display:block; margin-bottom: 1.5rem;"></div>
        </div>
        <!-- Mensaje de √©xito -->
        <div id="turno-exito" style="display:none;">
          <div class="alert alert-success mt-4" style="background: #232323; color: #fff; border: 1.5px solid #28a745;">
            <h4 class="mb-2">¬°Turno guardado exitosamente!</h4>
            <p>Tu turno ha sido guardado en nuestro historial. Te contactaremos pronto para coordinar los detalles de tu servicio.</p>
            <p class="mb-0"><small>üìã El turno qued√≥ registrado en nuestro sistema para seguimiento.</small></p>
            <div id="botones-exito" class="mt-3">
              <!-- Los botones se agregar√°n din√°micamente -->
            </div>
          </div>
        </div>
      </div>
      <!-- Botonera fija inferior -->
      <div class="turnero-botones-fijos">
        <button type="button" class="btn btn-secondary" id="btn-anterior-fijo" style="display:none;">Anterior</button>
        <button type="button" class="step-btn" id="btn-siguiente-fijo" style="display:none;">Siguiente</button>
        <button type="button" class="step-btn" id="btn-confirmar-fijo" style="display:none;">Confirmar Turno</button>
      </div>
    </div>
  </div>
  <footer>
    <p>¬© 2025 Daytona - Todos los derechos reservados
      <a href="https://www.instagram.com/daytona_clean_service" target="_blank" title="Instagram Daytona">
        <i class="fab fa-instagram fa-lg"></i> @daytona_clean_service
      </a>
    </p>
  </footer>

  <!-- Modal de Confirmaci√≥n -->
  <div class="modal fade" id="confirmacionModal" tabindex="-1" aria-labelledby="confirmacionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="confirmacionModalLabel">
            <i class="fas fa-check-circle me-2"></i>¬°Turno Confirmado!
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="confirmacionMensaje"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Error -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="errorModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Error
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="errorMensaje"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS debe ir primero para que los dropdowns funcionen -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/api-service.js"></script>
  <script src="js/include-header.js"></script>
  <script src="js/include-footer.js"></script>
  <script>
  // Sistema de Turnos - Daytona Clean Service
  class TurnosApp {
    constructor() {
      this.currentStep = 1;
      this.selectedServices = [];
      this.appointmentData = {
        services: [],
        date: null,
        time: null,
        clientName: '',
        clientPhone: '',
        clientEmail: '',
        serviceLocation: '',
        totalAmount: 0
      };
      this.services = [];
      this.init();
    }

    async init() {
      console.log('üöÄ Iniciando sistema de turnos...');
      await this.loadServices();
      this.setupEventListeners();
      this.showStep(1);
      this.setMinDate();
    }

    setMinDate() {
      const fechaInput = document.getElementById('fecha');
      if (fechaInput) {
        const today = new Date().toISOString().split('T')[0];
        fechaInput.min = today;
      }
    }

    async loadServices() {
      try {
        console.log('üì° Cargando servicios desde la API...');
        const response = await fetch('/api/appointments/services');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìã Respuesta de la API:', data);
        
        if (data.success && data.services) {
          this.services = data.services;
          console.log('‚úÖ Servicios cargados:', this.services.length);
          this.renderServices();
        } else {
          console.error('‚ùå Error en la respuesta de la API:', data.message);
          this.showError('Error cargando servicios: ' + (data.message || 'Respuesta inv√°lida'));
        }
      } catch (error) {
        console.error('‚ùå Error cargando servicios:', error);
        this.showError('Error de conexi√≥n: ' + error.message);
      }
    }

    showError(message) {
      const container = document.querySelector('.step-content');
      if (container) {
        container.innerHTML = `
          <div class="alert alert-danger">
            <h4>Error</h4>
            <p>${message}</p>
            <button class="btn btn-primary" onclick="location.reload()">Reintentar</button>
          </div>
        `;
      }
    }

    renderServices() {
      console.log('üé® Renderizando servicios...');
      
      const vehiculosContainer = document.getElementById('lista-servicios-vehiculos');
      const tapizadosContainer = document.getElementById('lista-servicios-tapizados');
      
      if (vehiculosContainer) {
        vehiculosContainer.innerHTML = '';
        const vehiculosServices = this.services.filter(s => s.category === 'vehiculos');
        console.log('üöó Servicios de veh√≠culos:', vehiculosServices.length);
        vehiculosServices.forEach(service => this.createServiceElement(service, vehiculosContainer));
      }
      
      if (tapizadosContainer) {
        tapizadosContainer.innerHTML = '';
        const tapizadosServices = this.services.filter(s => s.category === 'tapizados');
        console.log('üõãÔ∏è Servicios de tapizados:', tapizadosServices.length);
        tapizadosServices.forEach(service => this.createServiceElement(service, tapizadosContainer));
      }
    }

    createServiceElement(service, container) {
      const element = document.createElement('div');
      element.className = 'service-item';
      element.dataset.serviceId = service.id;
      element.dataset.name = service.name;
      element.dataset.price = service.price;
      element.dataset.duration = service.duration;
      
      element.innerHTML = `
        <div class="service-info">
          <div class="service-icon">
            <i class="fas ${this.getServiceIcon(service.name)}"></i>
          </div>
          <div class="servicio-details">
            <h6>${service.name}</h6>
            <p>${service.description || 'Servicio de limpieza profesional'}</p>
          </div>
        </div>
        <div class="servicio-precio">
          $${service.price.toLocaleString()}
        </div>
      `;
      
      element.addEventListener('click', () => {
        console.log('üñ±Ô∏è Click en servicio:', service.name);
        this.toggleService(service, element);
      });
      
      container.appendChild(element);
    }

    getServiceIcon(serviceName) {
      const name = serviceName.toLowerCase();
      if (name.includes('auto') || name.includes('car')) return 'fa-car';
      if (name.includes('pickup')) return 'fa-truck-pickup';
      if (name.includes('suv')) return 'fa-car-side';
      if (name.includes('motor')) return 'fa-cog';
      if (name.includes('sill√≥n') || name.includes('sillon')) return 'fa-couch';
      if (name.includes('silla')) return 'fa-chair';
      if (name.includes('colch√≥n') || name.includes('colchon')) return 'fa-bed';
      if (name.includes('alfombra')) return 'fa-rug';
      if (name.includes('puff')) return 'fa-couch';
      return 'fa-cog';
    }

    toggleService(service, element) {
      console.log('üîÑ Alternando servicio:', service.name);
      
      const existingIndex = this.selectedServices.findIndex(s => s.service_id === service.id);
      
      if (existingIndex >= 0) {
        // Deseleccionar
        this.selectedServices.splice(existingIndex, 1);
        element.classList.remove('selected');
        console.log('‚ùå Servicio deseleccionado:', service.name);
      } else {
        // Seleccionar
        this.selectedServices.push({
          service_id: service.id,
          name: service.name,
          price: service.price,
          duration: service.duration,
          quantity: 1
        });
        element.classList.add('selected');
        console.log('‚úÖ Servicio seleccionado:', service.name);
      }
      
      this.updateSelectedServicesDisplay();
      this.updateNextButton();
    }

    updateSelectedServicesDisplay() {
      const container = document.getElementById('servicios-seleccionados');
      const listContainer = document.getElementById('lista-servicios');
      
      if (!container || !listContainer) {
        console.log('‚ùå Contenedores de servicios no encontrados');
        return;
      }
      
      if (this.selectedServices.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      listContainer.innerHTML = '';
      
      let total = 0;
      this.selectedServices.forEach(service => {
        const item = document.createElement('div');
        item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-dark rounded';
        item.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="fas ${this.getServiceIcon(service.name)} me-2"></i>
            <span>${service.name} x${service.quantity}</span>
          </div>
          <div class="d-flex align-items-center">
            <span class="me-3">$${service.price.toLocaleString()}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="turnosApp.removeService(${service.service_id})">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        listContainer.appendChild(item);
        total += service.price * service.quantity;
      });
      
      // Actualizar total
      const totalElement = document.getElementById('total-general');
      if (totalElement) {
        totalElement.textContent = `$${total.toLocaleString()}`;
      }
      
      this.appointmentData.totalAmount = total;
      console.log('üí∞ Total actualizado:', total);
    }

    removeService(serviceId) {
      console.log('üóëÔ∏è Removiendo servicio ID:', serviceId);
      this.selectedServices = this.selectedServices.filter(s => s.service_id !== serviceId);
      this.updateSelectedServicesDisplay();
      this.updateNextButton();
      
      // Actualizar UI
      const element = document.querySelector(`[data-service-id="${serviceId}"]`);
      if (element) {
        element.classList.remove('selected');
      }
    }

    updateNextButton() {
      const btnSiguiente = document.getElementById('btn-siguiente-fijo');
      if (btnSiguiente) {
        const shouldShow = this.selectedServices.length > 0;
        btnSiguiente.style.display = shouldShow ? 'block' : 'none';
        console.log('üîò Bot√≥n siguiente:', shouldShow ? 'visible' : 'oculto');
      }
    }

    setupEventListeners() {
      console.log('üîß Configurando event listeners...');
      
      // Bot√≥n siguiente
      const btnSiguiente = document.getElementById('btn-siguiente-fijo');
      if (btnSiguiente) {
        btnSiguiente.addEventListener('click', () => {
          console.log('‚û°Ô∏è Bot√≥n siguiente clickeado');
          this.nextStep();
        });
      }
      
      // Bot√≥n anterior
      const btnAnterior = document.getElementById('btn-anterior-fijo');
      if (btnAnterior) {
        btnAnterior.addEventListener('click', () => {
          console.log('‚¨ÖÔ∏è Bot√≥n anterior clickeado');
          this.previousStep();
        });
      }
      
      // Categor√≠as
      const categoriaVehiculos = document.getElementById('categoria-vehiculos');
      const categoriaTapizados = document.getElementById('categoria-tapizados');
      
      if (categoriaVehiculos) {
        categoriaVehiculos.addEventListener('click', () => {
          console.log('üöó Categor√≠a veh√≠culos seleccionada');
          this.selectCategory('vehiculos');
        });
      }
      
      if (categoriaTapizados) {
        categoriaTapizados.addEventListener('click', () => {
          console.log('üõãÔ∏è Categor√≠a tapizados seleccionada');
          this.selectCategory('tapizados');
        });
      }
      
      console.log('‚úÖ Event listeners configurados');
    }

    selectCategory(category) {
      console.log('üìÇ Seleccionando categor√≠a:', category);
      
      // Ocultar categor√≠as
      const categoriaVehiculos = document.getElementById('categoria-vehiculos');
      const categoriaTapizados = document.getElementById('categoria-tapizados');
      
      if (categoriaVehiculos) categoriaVehiculos.style.display = 'none';
      if (categoriaTapizados) categoriaTapizados.style.display = 'none';
      
      // Mostrar servicios de la categor√≠a
      const serviciosContainer = document.getElementById(`servicios-${category}`);
      if (serviciosContainer) {
        serviciosContainer.style.display = 'block';
        console.log('‚úÖ Mostrando servicios de:', category);
      }
      
      // Mostrar bot√≥n siguiente
      this.updateNextButton();
    }

    changeCategory() {
      console.log('üîÑ Cambiando categor√≠a...');
      
      // Limpiar selecciones
      this.selectedServices = [];
      this.updateSelectedServicesDisplay();
      
      // Ocultar contenedores de servicios
      const serviciosVehiculos = document.getElementById('servicios-vehiculos');
      const serviciosTapizados = document.getElementById('servicios-tapizados');
      
      if (serviciosVehiculos) serviciosVehiculos.style.display = 'none';
      if (serviciosTapizados) serviciosTapizados.style.display = 'none';
      
      // Mostrar categor√≠as
      const categoriaVehiculos = document.getElementById('categoria-vehiculos');
      const categoriaTapizados = document.getElementById('categoria-tapizados');
      
      if (categoriaVehiculos) categoriaVehiculos.style.display = 'block';
      if (categoriaTapizados) categoriaTapizados.style.display = 'block';
      
      // Ocultar bot√≥n siguiente
      const btnSiguiente = document.getElementById('btn-siguiente-fijo');
      if (btnSiguiente) {
        btnSiguiente.style.display = 'none';
      }
    }

    nextStep() {
      console.log('‚û°Ô∏è Siguiente paso:', this.currentStep);
      
      if (this.currentStep === 1) {
        if (this.selectedServices.length === 0) {
          alert('Por favor, selecciona al menos un servicio.');
          return;
        }
        this.appointmentData.services = this.selectedServices;
        this.currentStep = 2;
        
      } else if (this.currentStep === 2) {
        const fecha = document.getElementById('fecha')?.value;
        const hora = document.getElementById('hora')?.value;
        
        if (!fecha || !hora) {
          alert('Por favor, selecciona fecha y hora.');
          return;
        }
        
        this.appointmentData.date = fecha;
        this.appointmentData.time = hora;
        this.currentStep = 3;
        
      } else if (this.currentStep === 3) {
        const nombre = document.getElementById('nombre')?.value;
        const apellido = document.getElementById('apellido')?.value;
        const telefono = document.getElementById('telefono')?.value;
        
        if (!nombre || !apellido || !telefono) {
          alert('Por favor, completa todos los campos obligatorios.');
          return;
        }
        
        this.appointmentData.clientName = `${nombre} ${apellido}`.trim();
        this.appointmentData.clientPhone = telefono;
        this.appointmentData.clientEmail = document.getElementById('email')?.value || '';
        this.currentStep = 4;
        
      } else if (this.currentStep === 4) {
        const direccion = document.getElementById('direccion')?.value;
        
        if (!direccion) {
          alert('Por favor, ingresa la direcci√≥n del servicio.');
          return;
        }
        
        this.appointmentData.serviceLocation = direccion;
        this.currentStep = 5;
        this.showResumen();
        
      } else if (this.currentStep === 5) {
        this.confirmAppointment();
        return;
      }
      
      this.showStep(this.currentStep);
    }

    previousStep() {
      if (this.currentStep > 1) {
        this.currentStep--;
        this.showStep(this.currentStep);
      }
    }

    showStep(step) {
      console.log('üìã Mostrando paso:', step);
      
      // Ocultar todos los pasos
      for (let i = 1; i <= 5; i++) {
        const stepDiv = document.getElementById(`step-${i}`);
        if (stepDiv) {
          stepDiv.style.display = 'none';
        }
      }
      
      // Mostrar paso actual
      const currentStepDiv = document.getElementById(`step-${step}`);
      if (currentStepDiv) {
        currentStepDiv.style.display = 'block';
      }
      
      // Actualizar barra de progreso
      this.updateProgressBar(step);
      
      // Actualizar botones
      this.updateButtons(step);
      
      // L√≥gica espec√≠fica por paso
      if (step === 3) {
        this.autoFillUserData();
      }
    }

    updateProgressBar(step) {
      const percent = ((step - 1) / 4) * 100;
      const barFill = document.getElementById('wizard-bar-fill');
      if (barFill) {
        barFill.style.width = percent + '%';
      }
      
      // Actualizar indicadores
      for (let i = 1; i <= 5; i++) {
        const indicator = document.getElementById(`step-indicator-${i}`);
        if (indicator) {
          indicator.classList.remove('active', 'completed');
          if (i < step) {
            indicator.classList.add('completed');
          } else if (i === step) {
            indicator.classList.add('active');
          }
        }
      }
    }

    updateButtons(step) {
      const btnAnterior = document.getElementById('btn-anterior-fijo');
      const btnSiguiente = document.getElementById('btn-siguiente-fijo');
      
      if (btnAnterior) {
        btnAnterior.style.display = step > 1 ? 'block' : 'none';
      }
      
      if (btnSiguiente) {
        btnSiguiente.style.display = step < 5 ? 'block' : 'none';
        if (step === 5) {
          btnSiguiente.textContent = 'Confirmar Turno';
        } else {
          btnSiguiente.textContent = 'Siguiente';
        }
      }
    }

    autoFillUserData() {
      const token = localStorage.getItem('token');
      const userData = localStorage.getItem('userData');
      
      if (token && userData) {
        try {
          const user = JSON.parse(userData);
          
          // Separar nombre completo
          const nombres = user.name ? user.name.split(' ') : [];
          const nombre = nombres[0] || '';
          const apellido = nombres.slice(1).join(' ') || '';
          
          // Buscar tel√©fono
          const telefono = user.phone || user.telefono || user.phonenumber || user.celular || user.phoneNumber || '';
          
          // Auto-completar campos
          const nombreInput = document.getElementById('nombre');
          const apellidoInput = document.getElementById('apellido');
          const telefonoInput = document.getElementById('telefono');
          const emailInput = document.getElementById('email');
          
          if (nombreInput) nombreInput.value = nombre;
          if (apellidoInput) apellidoInput.value = apellido;
          if (telefonoInput) telefonoInput.value = telefono;
          if (emailInput) emailInput.value = user.email || '';
          
          console.log('‚úÖ Datos de usuario auto-completados');
          
        } catch (error) {
          console.error('‚ùå Error auto-completando datos:', error);
        }
      }
    }

    showResumen() {
      const resumenContainer = document.getElementById('resumen-turno');
      if (!resumenContainer) return;
      
      let html = '';
      let total = 0;
      
      this.selectedServices.forEach(service => {
        const subtotal = service.price * service.quantity;
        total += subtotal;
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>${service.name} x${service.quantity}</span>
            <span>$${subtotal.toLocaleString()}</span>
          </div>
        `;
      });
      
      html += `
        <hr>
        <div class="d-flex justify-content-between align-items-center">
          <strong>Total:</strong>
          <strong>$${total.toLocaleString()}</strong>
        </div>
        <hr>
        <div><strong>Fecha:</strong> ${this.appointmentData.date}</div>
        <div><strong>Hora:</strong> ${this.appointmentData.time}</div>
        <div><strong>Cliente:</strong> ${this.appointmentData.clientName}</div>
        <div><strong>Tel√©fono:</strong> ${this.appointmentData.clientPhone}</div>
        <div><strong>Direcci√≥n:</strong> ${this.appointmentData.serviceLocation}</div>
      `;
      
      resumenContainer.innerHTML = html;
    }

    async confirmAppointment() {
      console.log('üéØ Confirmando turno:', this.appointmentData);
      
      try {
        // Preparar datos para el backend
        const appointmentData = {
          appointmentDate: this.appointmentData.date,
          appointmentTime: this.appointmentData.time,
          services: this.appointmentData.services.map(s => ({
            service_id: s.service_id,
            quantity: s.quantity
          })),
          serviceLocation: this.appointmentData.serviceLocation,
          clientName: this.appointmentData.clientName,
          clientPhone: this.appointmentData.clientPhone,
          clientEmail: this.appointmentData.clientEmail,
          service_type: this.appointmentData.services.map(s => s.name).join(', '),
          totalAmount: this.appointmentData.totalAmount
        };
        
        // Agregar userId si el usuario est√° logueado
        const userData = localStorage.getItem('userData');
        if (userData) {
          const user = JSON.parse(userData);
          appointmentData.userId = user.id;
        }
        
        console.log('üì§ Enviando turno al backend:', appointmentData);
        
        // Enviar al backend
        const response = await fetch('/api/appointments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(appointmentData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('‚úÖ Turno creado exitosamente:', result);
          this.showSuccess();
        } else {
          console.error('‚ùå Error creando turno:', result.message);
          alert(`Error: ${result.message}`);
        }
        
      } catch (error) {
        console.error('‚ùå Error en confirmAppointment:', error);
        alert('Error al crear el turno. Por favor, intenta nuevamente.');
      }
    }

    showSuccess() {
      // Ocultar todos los pasos
      for (let i = 1; i <= 5; i++) {
        const stepDiv = document.getElementById(`step-${i}`);
        if (stepDiv) {
          stepDiv.style.display = 'none';
        }
      }
      
      // Mostrar mensaje de √©xito
      const successDiv = document.getElementById('turno-exito');
      if (successDiv) {
        successDiv.style.display = 'block';
      }
      
      // Ocultar botones
      const btnAnterior = document.getElementById('btn-anterior-fijo');
      const btnSiguiente = document.getElementById('btn-siguiente-fijo');
      
      if (btnAnterior) btnAnterior.style.display = 'none';
      if (btnSiguiente) btnSiguiente.style.display = 'none';
    }
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üåê DOM cargado, iniciando TurnosApp...');
    window.turnosApp = new TurnosApp();
  });

  // Funci√≥n global para cambiar categor√≠a (compatibilidad)
  window.cambiarCategoria = function() {
    if (window.turnosApp) {
      window.turnosApp.changeCategory();
    }
  };
  
  console.log('üß™ Para probar auto-completado, ejecuta: testAutoCompletado()');
  
  // Funci√≥n para limpiar datos de prueba
  window.limpiarDatosPrueba = function() {
    console.log('üßπ Limpiando datos de prueba...');
    localStorage.removeItem('token');
    localStorage.removeItem('userData');
    console.log('‚úÖ Datos de prueba eliminados');
    console.log('üîÑ Recarga la p√°gina para ver el estado sin login');
  };
  
  console.log('üßπ Para limpiar datos de prueba, ejecuta: limpiarDatosPrueba()');
  
  // Funci√≥n para verificar datos del usuario actual
  window.verificarDatosUsuario = function() {
    console.log('üîç Verificando datos del usuario actual...');
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('userData');
    
    console.log('Token:', token ? 'Presente' : 'Ausente');
    console.log('UserData:', userData);
    
    if (userData) {
      try {
        const user = JSON.parse(userData);
        console.log('üë§ Datos del usuario:', user);
        console.log('üìû Tel√©fono disponible:', user.phone || user.telefono || user.phonenumber || user.celular || user.phoneNumber || 'NO ENCONTRADO');
      } catch (error) {
        console.error('‚ùå Error parseando userData:', error);
      }
    }
  };
  
  console.log('üîç Para verificar datos del usuario actual, ejecuta: verificarDatosUsuario()');
  
  // Funci√≥n para agregar tel√©fono al usuario actual (para pruebas)
  window.agregarTelefonoUsuario = function(telefono) {
    console.log('üìû Agregando tel√©fono al usuario actual...');
    const userData = localStorage.getItem('userData');
    
    if (userData) {
      try {
        const user = JSON.parse(userData);
        user.phone = telefono;
        localStorage.setItem('userData', JSON.stringify(user));
        console.log('‚úÖ Tel√©fono agregado:', telefono);
        console.log('üîÑ Recarga la p√°gina para que tome efecto');
      } catch (error) {
        console.error('‚ùå Error actualizando userData:', error);
      }
    } else {
      console.error('‚ùå No hay datos de usuario');
    }
  };
  
  console.log('üìû Para agregar tel√©fono al usuario actual, ejecuta: agregarTelefonoUsuario("3482123456")');
  
  // Agregar tel√©fono autom√°ticamente al usuario actual si no lo tiene
  window.agregarTelefonoAutomaticamente = function() {
    console.log('üîß Verificando tel√©fono del usuario...');
    const userData = localStorage.getItem('userData');
    
    if (userData) {
      try {
        const user = JSON.parse(userData);
        if (!user.phone) {
          // No agregar tel√©fono autom√°ticamente, dejar que el usuario lo complete
          console.log('‚ÑπÔ∏è El usuario no tiene tel√©fono guardado. Deber√° completarlo manualmente.');
          return false;
        } else {
          console.log('‚ÑπÔ∏è El usuario ya tiene tel√©fono:', user.phone);
          return true;
        }
      } catch (error) {
        console.error('‚ùå Error verificando userData:', error);
        return false;
      }
    } else {
      console.error('‚ùå No hay datos de usuario');
      return false;
    }
  };
  
  console.log('üîß Para agregar tel√©fono autom√°ticamente, ejecuta: agregarTelefonoAutomaticamente()');
  
  // Funci√≥n para obtener el tel√©fono real del usuario desde el backend
  window.obtenerTelefonoReal = async function() {
    console.log('üìû Obteniendo tel√©fono real del usuario...');
    const token = localStorage.getItem('token');
    
    if (!token) {
      console.error('‚ùå No hay token de autenticaci√≥n');
      return null;
    }
    
    try {
      // Primero intentar obtener del localStorage (pero verificar que no sea el gen√©rico)
      const userData = localStorage.getItem('userData');
      if (userData) {
        const user = JSON.parse(userData);
        if (user.phone && user.phone !== '3482123456') {
          console.log('‚úÖ Tel√©fono encontrado en localStorage:', user.phone);
          return user.phone;
        }
      }
      
      // Si no est√° en localStorage o es gen√©rico, intentar obtener del backend
      console.log('üîÑ Buscando tel√©fono en el backend...');
      const response = await fetch(`${window.getApiUrl ? window.getApiUrl() : 'https://daytona-clean-service.onrender.com/api'}/users/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.user && data.user.phone) {
          console.log('‚úÖ Tel√©fono obtenido del backend:', data.user.phone);
          // Actualizar localStorage con el tel√©fono real
          if (userData) {
            const user = JSON.parse(userData);
            user.phone = data.user.phone;
            localStorage.setItem('userData', JSON.stringify(user));
            console.log('‚úÖ localStorage actualizado con tel√©fono real');
          }
          return data.user.phone;
        }
      }
      
      console.log('‚ÑπÔ∏è No se encontr√≥ tel√©fono guardado');
      return null;
    } catch (error) {
      console.error('‚ùå Error obteniendo tel√©fono:', error);
      return null;
    }
  };
  
  console.log('üìû Para obtener tel√©fono real, ejecuta: obtenerTelefonoReal()');
  
  // Funci√≥n para limpiar el tel√©fono gen√©rico y usar el real
  window.limpiarTelefonoGenerico = function() {
    console.log('üßπ Limpiando tel√©fono gen√©rico...');
    const userData = localStorage.getItem('userData');
    
    if (userData) {
      try {
        const user = JSON.parse(userData);
        if (user.phone === '3482123456') {
          // Eliminar el tel√©fono gen√©rico
          delete user.phone;
          localStorage.setItem('userData', JSON.stringify(user));
          console.log('‚úÖ Tel√©fono gen√©rico eliminado');
          console.log('üîÑ Recarga la p√°gina para que tome efecto');
          return true;
        } else {
          console.log('‚ÑπÔ∏è No hay tel√©fono gen√©rico para limpiar');
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error limpiando tel√©fono:', error);
        return false;
      }
    } else {
      console.error('‚ùå No hay datos de usuario');
      return false;
    }
  };
  
  console.log('üßπ Para limpiar tel√©fono gen√©rico, ejecuta: limpiarTelefonoGenerico()');
  
  // Funci√≥n para forzar la actualizaci√≥n del tel√©fono desde el backend
  window.actualizarTelefonoDesdeBackend = async function() {
    console.log('üîÑ Forzando actualizaci√≥n del tel√©fono desde el backend...');
    const telefono = await obtenerTelefonoReal();
    if (telefono) {
      console.log('‚úÖ Tel√©fono actualizado:', telefono);
      console.log('üîÑ Recarga la p√°gina para ver el cambio en el formulario');
      return telefono;
    } else {
      console.log('‚ùå No se pudo obtener el tel√©fono del backend');
      return null;
    }
  };
  
  console.log('üîÑ Para forzar actualizaci√≥n del tel√©fono, ejecuta: actualizarTelefonoDesdeBackend()');
  


  // Variables globales para servicios
  let sillonesAgregados = [];
  let sillasAgregadas = [];
  let colchonesAgregados = [];
  let vehiculosAgregados = [];
  let tapizadoVehiculosAgregados = [];
  let motoresAgregados = [];
  let alfombrasAgregadas = [];
  let puffsAgregados = [];

  // Variables para manejar turnos separados (hacerlas globales)
  window.turnosSeparados = {
    vehiculos: {
      servicios: [],
      fecha: null,
      hora: null,
      direccion: null,
      detalles: null
    },
    tapizados: {
      servicios: [],
      fecha: null,
      hora: null,
      direccion: null,
      detalles: null
    }
  };

  // Variables globales para servicios (manejadas por turnos-app.js)
  let serviciosBD = [];
  let serviciosPorCategoria = {};

  // Funci√≥n para obtener precio desde BD por nombre y tipo
  function getPrecioDesdeBD(nombreServicio, tipo = null) {
    const servicio = serviciosBD.find(s => {
      if (tipo) {
        return s.name.toLowerCase().includes(nombreServicio.toLowerCase()) && 
               s.name.toLowerCase().includes(tipo.toLowerCase());
      }
      return s.name.toLowerCase().includes(nombreServicio.toLowerCase());
    });
    
    return servicio ? servicio.price : 0;
  }

  // Funciones helper para obtener precios (solo desde BD)
  function getPrecioVehiculo(tipo) {
    return getPrecioDesdeBD('veh√≠culo', tipo);
  }

  function getPrecioTapizadoVehiculo(tipo) {
    return getPrecioDesdeBD('tapizado veh√≠culo', tipo);
  }

  function getPrecioMotor(tipo) {
    return getPrecioDesdeBD('motor', tipo);
  }

  function getPrecioSillon(tipo) {
    return getPrecioDesdeBD('sill√≥n', tipo);
  }

  function getPrecioSilla(tipo) {
    return getPrecioDesdeBD('silla', tipo);
  }

  function getPrecioColchon(tipo) {
    return getPrecioDesdeBD('colch√≥n', tipo);
  }

  function getPrecioAlfombra(tipo) {
    return getPrecioDesdeBD('alfombra', tipo);
  }

  function getPrecioPuff(tipo) {
    return getPrecioDesdeBD('puff', tipo);
  }

  // Definir funciones antes del DOMContentLoaded
  // Variable global para servicios disponibles
  let serviciosDisponibles = [];

  // Funci√≥n para cargar servicios desde el backend
  async function cargarServiciosDisponibles() {
    try {
      const response = await fetch('https://daytona-clean-service.onrender.com/api/services');
      const data = await response.json();
      if (data.success) {
        serviciosDisponibles = data.services;
        console.log('‚úÖ Servicios cargados desde BD:', serviciosDisponibles);
      } else {
        throw new Error('Error en respuesta del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error cargando servicios desde BD:', error);
      // Usar duraciones por defecto en lugar de mostrar error
      serviciosDisponibles = [
        { id: 1, name: 'Limpieza de Auto', duration: 180 },
        { id: 2, name: 'Limpieza de Tapizado de Auto', duration: 1440 },
        { id: 3, name: 'Motor Detallada', duration: 240 },
        { id: 4, name: 'Sill√≥n 1 cuerpo', duration: 120 },
        { id: 5, name: 'Colch√≥n de 1 plaza', duration: 90 },
        { id: 6, name: 'Puff chico', duration: 45 }
      ];
      console.log('‚ö†Ô∏è Usando duraciones por defecto');
    }
  }

  // Funci√≥n para calcular duraci√≥n total de servicios
  function calcularDuracionServicios(servicios) {
    let duracionTotal = 0;
    
    if (!serviciosDisponibles || serviciosDisponibles.length === 0) {
      console.warn('‚ö†Ô∏è Servicios no cargados, usando duraci√≥n por defecto');
      return 120; // duraci√≥n por defecto
    }
    
    servicios.forEach(servicio => {
      // Buscar la duraci√≥n del servicio en la lista de servicios disponibles
      const servicioEncontrado = serviciosDisponibles.find(s => s.id === servicio.service_id);
      if (servicioEncontrado) {
        duracionTotal += servicioEncontrado.duration * servicio.cantidad;
        console.log(`üìÖ Servicio: ${servicioEncontrado.name} - Duraci√≥n: ${servicioEncontrado.duration}min x ${servicio.cantidad} = ${servicioEncontrado.duration * servicio.cantidad}min`);
      } else {
        console.warn(`‚ö†Ô∏è Servicio con ID ${servicio.service_id} no encontrado en BD`);
        duracionTotal += 120 * servicio.cantidad; // duraci√≥n por defecto
      }
    });
    
    console.log(`‚è±Ô∏è Duraci√≥n total calculada: ${duracionTotal} minutos (${Math.round(duracionTotal/60*10)/10} horas)`);
    return duracionTotal;
  }

  // Funci√≥n para obtener disponibilidad de horarios
  async function obtenerDisponibilidad(fecha, duracion = null) {
    try {
      const response = await apiService.getAvailability(fecha, duracion);
      
      if (response.success) {
        return response.data;
      } else {
        throw new Error(response.message);
      }
    } catch (error) {
      console.error('Error obteniendo disponibilidad:', error);
      // Retornar disponibilidad por defecto en caso de error
      return {
        isWorkingDay: true,
        availableSlots: [
          { startTime: '08:00', endTime: '10:00', available: true },
          { startTime: '10:00', endTime: '12:00', available: true },
          { startTime: '12:00', endTime: '14:00', available: true },
          { startTime: '14:00', endTime: '16:00', available: true },
          { startTime: '16:00', endTime: '18:00', available: true }
        ]
      };
    }
  }

  // Funci√≥n para actualizar disponibilidad en el paso 3 (simplificada)
  async function actualizarDisponibilidadPaso3() {
    console.log('üîÑ Actualizando disponibilidad para paso 3...');
    
    try {
      // Calcular duraci√≥n total de servicios seleccionados
      let duracion = 120; // duraci√≥n por defecto
      
      if (serviciosSeleccionados && serviciosSeleccionados.length > 0) {
        duracion = serviciosSeleccionados.reduce((total, servicio) => {
          return total + (servicio.duracion || 120);
        }, 0);
      }
      
      console.log(`‚è±Ô∏è Duraci√≥n calculada: ${duracion} minutos`);
      
    } catch (error) {
      console.error('‚ùå Error actualizando disponibilidad:', error);
    }
  }

  // Cargar servicios al iniciar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    cargarServiciosDesdeBD();
    cargarServiciosDisponibles(); // Cargar servicios para calcular duraciones
  });

  // Funci√≥n para categorizar servicios (simplificada)
  function categorizarServicios() {
    return {
      hayVehiculos: serviciosSeleccionados.some(s => s.nombre.toLowerCase().includes('auto') || 
                                                   s.nombre.toLowerCase().includes('pickup') || 
                                                   s.nombre.toLowerCase().includes('suv') || 
                                                   s.nombre.toLowerCase().includes('motor')),
      hayTapizados: serviciosSeleccionados.some(s => s.nombre.toLowerCase().includes('sill√≥n') || 
                                                    s.nombre.toLowerCase().includes('silla') || 
                                                    s.nombre.toLowerCase().includes('colch√≥n') || 
                                                    s.nombre.toLowerCase().includes('alfombra') || 
                                                    s.nombre.toLowerCase().includes('puff')),
      necesitaTurnosSeparados: false
    };
  }

  // Funci√≥n para actualizar el resumen final (simplificada)
  function actualizarResumenFinal() {
    const resumenFinal = document.getElementById('resumen-final');
    const listaServicios = document.getElementById('lista-servicios');
    const totalGeneral = document.getElementById('total-general');
    
    if (!resumenFinal || !listaServicios || !totalGeneral) {
      console.warn('‚ö†Ô∏è Elementos del resumen no encontrados');
      return;
    }
    
    if (serviciosSeleccionados && serviciosSeleccionados.length > 0) {
      resumenFinal.style.display = 'block';
      
      listaServicios.innerHTML = '';
      let totalCalculado = 0;
      
      serviciosSeleccionados.forEach(servicio => {
        const subtotal = servicio.precio * servicio.cantidad;
        totalCalculado += subtotal;
        
        const item = document.createElement('div');
        item.className = 'd-flex justify-content-between align-items-center mb-2';
        item.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="fas ${servicio.icono} me-2 text-white"></i>
            <span class="text-white">${servicio.nombre} x${servicio.cantidad}</span>
          </div>
          <div class="text-end">
            <div class="text-white small">$${servicio.precio.toLocaleString('es-AR')} c/u</div>
            <div class="fw-bold text-white">$${subtotal.toLocaleString('es-AR')}</div>
          </div>
        `;
        listaServicios.appendChild(item);
      });
      
      totalGeneral.textContent = `$${totalCalculado.toLocaleString('es-AR')}`;
    } else {
      resumenFinal.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Limpiar tel√©fono gen√©rico y obtener el real
    setTimeout(() => {
      limpiarTelefonoGenerico();
      agregarTelefonoAutomaticamente();
    }, 1000);
    
    // Wizard navigation logic
    let step = 1;
    let turno = {
      servicio: null,
      duracion: null,
      precio: null,
      profesional: 'Benjam√≠n Gianneschi',
      fecha: null,
      hora: null,
      nombre: null,
      apellido: null,
      telefono: null,
      email: null,
      ubicacion: null,
      tipoServicio: null,
      retiroEntrega: null,
      direccionRetiro: null,
      direccionEntrega: null,
      direccionDomicilio: null,
      detallesUbicacion: null
    };
    function updateWizardBar(step) {
      const percent = ((step - 1) / 5) * 100;
      document.getElementById('wizard-bar-fill').style.width = percent + '%';
      for (let i = 1; i <= 6; i++) {
        const el = document.getElementById('step-indicator-' + i);
        el.classList.remove('active', 'completed');
        if (i < step) el.classList.add('completed');
        if (i === step) el.classList.add('active');
      }
    }
    function showStep(n) {
      for (let i = 1; i <= 6; i++) {
        const stepDiv = document.getElementById('step-' + i);
        if (stepDiv) stepDiv.style.display = (i === n) ? '' : 'none';
      }
      updateWizardBar(n);
      
      // L√≥gica espec√≠fica para cada paso
      if (n === 3) {
        mostrarTurnosSeparados();
      } else if (n === 4) {
        console.log('üéØ Llegando al paso 4 - Datos Personales');
        autoCompletarDatosUsuario();
      } else if (n === 5) {
        mostrarCamposUbicacion();
      } else if (n === 6) {
        mostrarResumenTurnosSeparados();
      }
    }
    
    function mostrarTurnosSeparados() {
      const categorias = categorizarServicios();
      
      // Ocultar todos los contenedores
      document.getElementById('turno-vehiculos').style.display = 'none';
      document.getElementById('turno-tapizados').style.display = 'none';
      document.getElementById('turno-unico').style.display = 'none';
      document.getElementById('info-turnos-separados').style.display = 'none';
      
      if (categorias.necesitaTurnosSeparados) {
        // Mostrar turnos separados
        document.getElementById('info-turnos-separados').style.display = 'block';
        document.getElementById('turno-vehiculos').style.display = 'block';
        document.getElementById('turno-tapizados').style.display = 'block';
        
        // Mostrar resumen de servicios
        mostrarResumenServiciosVehiculos();
        mostrarResumenServiciosTapizados();
      } else if (categorias.hayVehiculos) {
        // Solo servicios de veh√≠culos
        document.getElementById('turno-vehiculos').style.display = 'block';
        mostrarResumenServiciosVehiculos();
      } else if (categorias.hayTapizados) {
        // Solo servicios de tapizados
        document.getElementById('turno-tapizados').style.display = 'block';
        mostrarResumenServiciosTapizados();
      } else {
        // Turno √∫nico (fallback)
        document.getElementById('turno-unico').style.display = 'block';
      }
    }
    
    function mostrarResumenServiciosVehiculos() {
      const container = document.getElementById('servicios-vehiculos-resumen');
      const servicios = turnosSeparados.vehiculos.servicios;
      
      if (servicios.length === 0) {
        container.innerHTML = '<div class="text-muted">No hay servicios de veh√≠culos seleccionados.</div>';
        return;
      }
      
      let html = '<div class="mb-3"><strong>Servicios seleccionados:</strong></div>';
      let total = 0;
      
      servicios.forEach(servicio => {
        const subtotal = servicio.precio * servicio.cantidad;
        total += subtotal;
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>${servicio.nombre} x${servicio.cantidad}</span>
            <span class="fw-bold">$${subtotal.toLocaleString('es-AR')}</span>
          </div>
        `;
      });
      
      html += `<hr><div class="d-flex justify-content-between align-items-center"><strong>Total:</strong> <strong class="text-danger">$${total.toLocaleString('es-AR')}</strong></div>`;
      container.innerHTML = html;
    }
    
    function mostrarResumenServiciosTapizados() {
      const container = document.getElementById('servicios-tapizados-resumen');
      const servicios = turnosSeparados.tapizados.servicios;
      
      if (servicios.length === 0) {
        container.innerHTML = '<div class="text-muted">No hay servicios de tapizados seleccionados.</div>';
        return;
      }
      
      let html = '<div class="mb-3"><strong>Servicios seleccionados:</strong></div>';
      let total = 0;
      
      servicios.forEach(servicio => {
        const subtotal = servicio.precio * servicio.cantidad;
        total += subtotal;
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>${servicio.nombre} x${servicio.cantidad}</span>
            <span class="fw-bold">$${subtotal.toLocaleString('es-AR')}</span>
          </div>
        `;
      });
      
      html += `<hr><div class="d-flex justify-content-between align-items-center"><strong>Total:</strong> <strong class="text-danger">$${total.toLocaleString('es-AR')}</strong></div>`;
      container.innerHTML = html;
    }
    // Inicializar barra al cargar
    updateWizardBar(step);
    // Servicios actualizados con opciones est√°ndar/especiales
    const servicios = {
      // VEH√çCULOS
      'Lavado de Auto': {
        icon: 'fa-car',
        duracion: 210,
        precio: 20000,
        precioEspecial: 65000,
        desc: 'Lavado completo exterior e interior profesional',
        descEspecial: 'Lavado premium con tratamientos especializados',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      'Lavado de Pickup': {
        icon: 'fa-truck-pickup',
        duracion: 210,
        precio: 25000,
        precioEspecial: 65000,
        desc: 'Limpieza profesional incluyendo caja de carga',
        descEspecial: 'Lavado premium para pickup con limpieza profunda',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      'Lavado de SUV': {
        icon: 'fa-car-side',
        duracion: 240,
        precio: 30000,
        precioEspecial: 75000,
        desc: 'Limpieza profesional para veh√≠culos grandes',
        descEspecial: 'Lavado premium para SUV con limpieza profunda',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      'Limpieza de Motor': {
        icon: 'fa-gears',
        duracion: 90,
        precio: 45000,
        precioEspecial: 65000,
        desc: 'Limpieza y mantenimiento del compartimento',
        descEspecial: 'Limpieza premium de motor con protecci√≥n avanzada',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      'Tapizado de Auto': {
        icon: 'fa-car-side',
        duracion: 1440,
        precio: 120000,
        precioEspecial: 170000,
        desc: 'Limpieza profunda de tapizados y alfombras',
        descEspecial: 'Limpieza premium con m√°quina de inyecci√≥n-extracci√≥n',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      'Tapizado de Pickup': {
        icon: 'fa-truck-pickup',
        duracion: 1440,
        precio: 140000,
        precioEspecial: 190000,
        desc: 'Limpieza profunda incluyendo caja de carga',
        descEspecial: 'Limpieza premium con m√°quina de inyecci√≥n-extracci√≥n',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      'Tapizado de SUV': {
        icon: 'fa-car-side',
        duracion: 1800,
        precio: 160000,
        precioEspecial: 220000,
        desc: 'Limpieza profunda para veh√≠culos grandes',
        descEspecial: 'Limpieza premium con m√°quina de inyecci√≥n-extracci√≥n',
        tipo: 'vehiculo',
        domicilio: true,
        taller: true,
        categoria: 'vehiculos'
      },
      
      // TAPIZADOS
      'Sill√≥n 1 Cuerpo': {
        icon: 'fa-couch',
        duracion: 120,
        precio: 85000,
        precioEspecial: 150000,
        desc: 'Limpieza profunda de sill√≥n individual',
        descEspecial: 'Limpieza premium con m√°quina de inyecci√≥n-extracci√≥n',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Sill√≥n 2 Cuerpos': {
        icon: 'fa-couch',
        duracion: 180,
        precio: 120000,
        precioEspecial: 150000,
        desc: 'Limpieza profunda de sill√≥n doble',
        descEspecial: 'Limpieza premium con m√°quina de inyecci√≥n-extracci√≥n',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Sill√≥n 3 Cuerpos': {
        icon: 'fa-couch',
        duracion: 240,
        precio: 150000,
        precioEspecial: 185000,
        desc: 'Limpieza profunda de sill√≥n triple',
        descEspecial: 'Limpieza premium con m√°quina de inyecci√≥n-extracci√≥n',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Silla Simple': {
        icon: 'fa-chair',
        duracion: 60,
        precio: 15000,
        precioEspecial: 35000,
        desc: 'Limpieza profunda de silla individual',
        descEspecial: 'Limpieza premium con protecci√≥n antimanchas',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Silla Comedor': {
        icon: 'fa-chair',
        duracion: 60,
        precio: 25000,
        precioEspecial: 45000,
        desc: 'Limpieza profunda de silla de comedor',
        descEspecial: 'Limpieza premium con protecci√≥n antimanchas',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Colch√≥n 1 Plaza': {
        icon: 'fa-bed',
        duracion: 120,
        precio: 70000,
        precioEspecial: 130000,
        desc: 'Limpieza profunda y desinfecci√≥n',
        descEspecial: 'Limpieza premium con desinfecci√≥n y tratamiento anti-√°caros',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Colch√≥n 2 Plazas': {
        icon: 'fa-bed',
        duracion: 180,
        precio: 130000,
        precioEspecial: 180000,
        desc: 'Limpieza profunda y desinfecci√≥n',
        descEspecial: 'Limpieza premium con desinfecci√≥n y tratamiento anti-√°caros',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Limpieza de Alfombra': {
        icon: 'fa-rug',
        duracion: 30,
        precio: 30000,
        precioEspecial: 55000,
        desc: 'Limpieza profunda por metro cuadrado',
        descEspecial: 'Limpieza premium con tratamiento impermeabilizante',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados',
        porMetro: true
      },
      'Puff Simple': {
        icon: 'fa-couch',
        duracion: 60,
        precio: 20000,
        precioEspecial: 45000,
        desc: 'Limpieza profunda de puff individual',
        descEspecial: 'Limpieza premium con protecci√≥n impermeabilizante',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Puff Grande': {
        icon: 'fa-couch',
        duracion: 90,
        precio: 30000,
        precioEspecial: 55000,
        desc: 'Limpieza profunda de puff grande',
        descEspecial: 'Limpieza premium con protecci√≥n impermeabilizante',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados'
      },
      'Respaldo de Cama': {
        icon: 'fa-bed',
        duracion: 60,
        precio: 25000,
        precioEspecial: 50000,
        desc: 'Limpieza profunda por metro cuadrado',
        descEspecial: 'Limpieza premium con protecci√≥n impermeabilizante',
        tipo: 'domicilio',
        domicilio: true,
        taller: false,
        categoria: 'tapizados',
        porMetro: true
      }
    };
    const selectServicio = document.getElementById('servicio-select');
    const detalleServicio = document.getElementById('servicio-detalle');
    const sillonesOpciones = document.getElementById('sillones-opciones');
    
    // Funci√≥n para auto-completar datos del usuario logueado
    async function autoCompletarDatosUsuario() {
      const token = localStorage.getItem('token');
      const userData = localStorage.getItem('userData');
      
      console.log('üîç Verificando datos de usuario...');
      console.log('Token:', token ? 'Presente' : 'Ausente');
      console.log('UserData:', userData);
      
      if (token && userData) {
        try {
          const user = JSON.parse(userData);
          console.log('üë§ Datos del usuario parseados:', user);
          
          // Mostrar mensaje de bienvenida
          document.getElementById('usuario-logueado-info').style.display = 'block';
          
          // Separar nombre completo en nombre y apellido
          let nombre = '';
          let apellido = '';
          
          if (user.name) {
            const nombres = user.name.split(' ');
            nombre = nombres[0] || '';
            apellido = nombres.slice(1).join(' ') || '';
          }
          
          // Buscar tel√©fono en varias propiedades posibles
          let telefono = user.phone || user.telefono || user.phonenumber || user.celular || user.phoneNumber || '';
          
          // Si no hay tel√©fono en localStorage, intentar obtenerlo del backend
          if (!telefono) {
            console.log('üîÑ No hay tel√©fono en localStorage, buscando en el backend...');
            telefono = await obtenerTelefonoReal();
          }
          
          // Auto-completar campos
          document.getElementById('nombre').value = nombre;
          document.getElementById('apellido').value = apellido;
          document.getElementById('telefono').value = telefono;
          document.getElementById('email').value = user.email || '';
          
          // Guardar datos en el objeto turno
          turno.nombre = nombre;
          turno.apellido = apellido;
          turno.telefono = telefono;
          turno.email = user.email || '';
          
          console.log('‚úÖ Datos auto-completados:', {
            nombre: nombre,
            apellido: apellido,
            telefono: telefono,
            email: user.email
          });
          
          // Si no hay tel√©fono, mostrar advertencia
          if (!telefono) {
            console.warn('‚ö†Ô∏è El usuario no tiene tel√©fono guardado. Deber√° completarlo manualmente.');
            document.getElementById('telefono').placeholder = 'Ingresa tu tel√©fono (requerido)';
          }
          
        } catch (error) {
          console.error('‚ùå Error parseando datos de usuario:', error);
          document.getElementById('usuario-logueado-info').style.display = 'none';
        }
      } else {
        // Ocultar mensaje si no est√° logueado
        document.getElementById('usuario-logueado-info').style.display = 'none';
        console.log('‚ÑπÔ∏è Usuario no logueado, no se auto-completan datos');
      }
    }

    // Funci√≥n para guardar turno en el historial (disponible globalmente)
    window.guardarTurnoEnHistorial = async function() {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('Usuario no logueado, no se guarda en historial');
        return { success: false, message: 'Usuario no logueado' };
      }

      try {
        // Obtener datos del formulario
        const nombre = document.getElementById('nombre')?.value || '';
        const apellido = document.getElementById('apellido')?.value || '';
        const telefono = document.getElementById('telefono')?.value || '';
        const email = document.getElementById('email')?.value || '';

        // Validar que el tel√©fono est√© presente
        if (!telefono || telefono.trim() === '') {
          console.error('‚ùå Error: El tel√©fono es requerido');
          return { success: false, message: 'El tel√©fono es requerido para crear el turno' };
        }

        const categorias = categorizarServicios();
        const turnosParaGuardar = [];
    
        // Preparar datos del turno
        const datosTurno = {
          clientName: `${nombre} ${apellido}`.trim(),
          clientPhone: telefono,
          clientEmail: email,
          status: 'pending',
          notes: 'Turno creado desde el formulario web'
        };

        // Agregar userId si el usuario est√° logueado
        const userData = localStorage.getItem('userData');
        if (userData) {
          const user = JSON.parse(userData);
          datosTurno.userId = user.id;
        }

        if (categorias.necesitaTurnosSeparados) {
          // Guardar turno de veh√≠culos
          if (window.turnosSeparados.vehiculos.servicios.length > 0) {
            const nombresServiciosVehiculos = window.turnosSeparados.vehiculos.servicios.map(s => s.nombre || s.name).filter(Boolean).join(', ');
            console.log("Servicios seleccionados (veh√≠culos):", window.turnosSeparados.vehiculos.servicios);
            console.log("Nombres de servicios (veh√≠culos):", nombresServiciosVehiculos);
            if (!nombresServiciosVehiculos) {
              alert("Error: No se detect√≥ ning√∫n servicio v√°lido de veh√≠culos para guardar el turno.");
              return;
            }
            const turnoVehiculos = {
              ...datosTurno,
              appointmentDate: window.turnosSeparados.vehiculos.fecha,
              appointmentTime: window.turnosSeparados.vehiculos.hora,
              serviceLocation: window.turnosSeparados.vehiculos.direccion ? 
                (typeof window.turnosSeparados.vehiculos.direccion === 'object' ? 
                  `Retiro: ${window.turnosSeparados.vehiculos.direccion.retiro} | Entrega: ${window.turnosSeparados.vehiculos.direccion.entrega}` : 
                  window.turnosSeparados.vehiculos.direccion) : 'A confirmar',
              services: armarServiciosParaBackend(window.turnosSeparados.vehiculos.servicios),
              totalAmount: Number(window.turnosSeparados.vehiculos.servicios.reduce((sum, s) => sum + (s.precio * s.cantidad), 0)),
              service_type: nombresServiciosVehiculos
            };
            turnosParaGuardar.push(turnoVehiculos);
          }

          // Guardar turno de tapizados
          if (window.turnosSeparados.tapizados.servicios.length > 0) {
            const nombresServiciosTapizados = window.turnosSeparados.tapizados.servicios.map(s => s.nombre || s.name).filter(Boolean).join(', ');
            console.log("Servicios seleccionados (tapizados):", window.turnosSeparados.tapizados.servicios);
            console.log("Nombres de servicios (tapizados):", nombresServiciosTapizados);
            if (!nombresServiciosTapizados) {
              alert("Error: No se detect√≥ ning√∫n servicio v√°lido de tapizados para guardar el turno.");
              return;
            }
            const turnoTapizados = {
              ...datosTurno,
              appointmentDate: window.turnosSeparados.tapizados.fecha,
              appointmentTime: window.turnosSeparados.tapizados.hora,
              serviceLocation: window.turnosSeparados.tapizados.direccion || 'A confirmar',
              services: armarServiciosParaBackend(window.turnosSeparados.tapizados.servicios),
              totalAmount: Number(window.turnosSeparados.tapizados.servicios.reduce((sum, s) => sum + (s.precio * s.cantidad), 0)),
              service_type: nombresServiciosTapizados
            };
            turnosParaGuardar.push(turnoTapizados);
          }
        } else {
          // Turno √∫nico
          let servicios = [];
          let fecha = '';
          let hora = '';
          let direccion = '';
          let tipo = '';

          if (categorias.hayVehiculos) {
            servicios = window.turnosSeparados.vehiculos.servicios;
            fecha = window.turnosSeparados.vehiculos.fecha;
            hora = window.turnosSeparados.vehiculos.hora;
            tipo = servicios.map(s => s.nombre || s.name).filter(Boolean).join(', ');
            if (window.turnosSeparados.vehiculos.direccion) {
              if (typeof window.turnosSeparados.vehiculos.direccion === 'object') {
                direccion = `Retiro: ${window.turnosSeparados.vehiculos.direccion.retiro} | Entrega: ${window.turnosSeparados.vehiculos.direccion.entrega}`;
              } else {
                direccion = window.turnosSeparados.vehiculos.direccion;
              }
            } else {
              direccion = 'El cliente lleva el veh√≠culo a la instalaci√≥n';
            }
          } else if (categorias.hayTapizados) {
            servicios = window.turnosSeparados.tapizados.servicios;
            fecha = window.turnosSeparados.tapizados.fecha;
            hora = window.turnosSeparados.tapizados.hora;
            direccion = window.turnosSeparados.tapizados.direccion;
            tipo = servicios.map(s => s.nombre || s.name).filter(Boolean).join(', ');
          }

          console.log("Servicios seleccionados (√∫nico):", servicios);
          console.log("Nombres de servicios (√∫nico):", tipo);
          if (!tipo) {
            alert("Error: No se detect√≥ ning√∫n servicio v√°lido para guardar el turno.");
            return;
          }

          const turnoUnico = {
            ...datosTurno,
            appointmentDate: fecha,
            appointmentTime: hora,
            serviceLocation: direccion || 'A confirmar',
            services: armarServiciosParaBackend(servicios),
            totalAmount: Number(servicios.reduce((sum, s) => sum + (s.precio * s.cantidad), 0)),
            service_type: tipo
          };
          turnosParaGuardar.push(turnoUnico);
        }

        // Guardar cada turno en el backend
        const resultados = [];
        for (const turnoData of turnosParaGuardar) {
          console.log('üöÄ Enviando turno al backend:', turnoData);
          try {
            const response = await apiService.createAppointment(turnoData);
            if (response.success) {
              resultados.push({ success: true, data: response.data });
            } else {
              resultados.push({ success: false, message: response.message });
            }
          } catch (error) {
            console.error('Error guardando turno:', error);
            resultados.push({ success: false, message: error.message });
          }
        }

        console.log('üìã Turnos guardados en historial:', resultados);
        return { success: true, data: resultados };

      } catch (error) {
        console.error('Error en guardarTurnoEnHistorial:', error);
        return { success: false, message: error.message };
      }
    }
    
    // Funci√≥n para mostrar campos de ubicaci√≥n seg√∫n el tipo de servicio
    function mostrarCamposUbicacion() {
      const categorias = categorizarServicios();
      
      // Ocultar todos los contenedores
      document.getElementById('ubicacion-vehiculos').style.display = 'none';
      document.getElementById('ubicacion-tapizados').style.display = 'none';
      document.getElementById('ubicacion-unica').style.display = 'none';
      
      if (categorias.necesitaTurnosSeparados) {
        // Mostrar ubicaciones separadas
        mostrarUbicacionVehiculos();
        mostrarUbicacionTapizados();
        document.getElementById('ubicacion-vehiculos').style.display = 'block';
        document.getElementById('ubicacion-tapizados').style.display = 'block';
      } else if (categorias.hayVehiculos) {
        // Solo servicios de veh√≠culos
        mostrarUbicacionVehiculos();
        document.getElementById('ubicacion-vehiculos').style.display = 'block';
      } else if (categorias.hayTapizados) {
        // Solo servicios de tapizados
        mostrarUbicacionTapizados();
        document.getElementById('ubicacion-tapizados').style.display = 'block';
      } else {
        // Ubicaci√≥n √∫nica (fallback)
        document.getElementById('ubicacion-unica').style.display = 'block';
        const ubicacionContainer = document.getElementById('ubicacion-container');
        ubicacionContainer.innerHTML = '<div class="alert alert-warning">No se seleccionaron servicios.</div>';
      }
    }
    
    function mostrarUbicacionVehiculos() {
      const container = document.getElementById('ubicacion-vehiculos-container');
      container.innerHTML = `
        <div class="mb-4">
          <label class="form-label">¬øNecesit√°s retiro y entrega del veh√≠culo?</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="retiro-entrega-vehiculos" id="si-retiro-vehiculos" value="si">
            <label class="form-check-label" for="si-retiro-vehiculos">S√≠, necesito retiro y entrega</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="retiro-entrega-vehiculos" id="no-retiro-vehiculos" value="no" checked>
            <label class="form-check-label" for="no-retiro-vehiculos">No, lo llevo y retiro yo mismo</label>
          </div>
        </div>
        <div class="mb-3" id="direccion-retiro-vehiculos" style="display:none;">
          <label for="direccion-retiro-input-vehiculos" class="form-label">Direcci√≥n de retiro *</label>
          <textarea class="form-control" id="direccion-retiro-input-vehiculos" rows="2" placeholder="Ingresa la direcci√≥n completa donde retirar el veh√≠culo"></textarea>
        </div>
        <div class="mb-3" id="direccion-entrega-vehiculos" style="display:none;">
          <label for="direccion-entrega-input-vehiculos" class="form-label">Direcci√≥n de entrega *</label>
          <textarea class="form-control" id="direccion-entrega-input-vehiculos" rows="2" placeholder="Ingresa la direcci√≥n completa donde entregar el veh√≠culo"></textarea>
        </div>
      `;
      
      // Event listeners para retiro y entrega de veh√≠culos
      const radioSiRetiro = document.getElementById('si-retiro-vehiculos');
      const radioNoRetiro = document.getElementById('no-retiro-vehiculos');
      const direccionRetiro = document.getElementById('direccion-retiro-vehiculos');
      const direccionEntrega = document.getElementById('direccion-entrega-vehiculos');
      
      if (radioSiRetiro && radioNoRetiro) {
        radioSiRetiro.addEventListener('change', function() {
          direccionRetiro.style.display = 'block';
          direccionEntrega.style.display = 'block';
        });
        radioNoRetiro.addEventListener('change', function() {
          direccionRetiro.style.display = 'none';
          direccionEntrega.style.display = 'none';
        });
      }
    }
    
    function mostrarUbicacionTapizados() {
      const container = document.getElementById('ubicacion-tapizados-container');
      container.innerHTML = `
        <div class="alert alert-info" style="background: #232323; color: #fff; border: 1.5px solid #17a2b8;">
          <i class="fas fa-info-circle me-2"></i>
          Este servicio se realiza a domicilio. Por favor, proporciona la direcci√≥n donde se realizar√° el trabajo.
        </div>
        <div class="mb-3">
          <label for="direccion-domicilio-input-tapizados" class="form-label">Direcci√≥n donde se realizar√° el servicio</label>
          <textarea class="form-control" id="direccion-domicilio-input-tapizados" rows="2" placeholder="Ingresa la direcci√≥n completa" required></textarea>
        </div>
      `;
    }
    
    // Funci√≥n para mostrar el resumen de turnos separados
    function mostrarResumenTurnosSeparados() {
      const categorias = categorizarServicios();
      
      // Ocultar todos los contenedores de resumen
      document.getElementById('resumen-turnos-separados').style.display = 'none';
      document.getElementById('resumen-turno-unico').style.display = 'none';
      
      if (categorias.necesitaTurnosSeparados) {
        // Mostrar resumen de turnos separados
        document.getElementById('resumen-turnos-separados').style.display = 'block';
        mostrarResumenTurnoVehiculos();
        mostrarResumenTurnoTapizados();
      } else {
        // Mostrar resumen √∫nico
        document.getElementById('resumen-turno-unico').style.display = 'block';
        mostrarResumenTurnoUnico();
      }
    }
    
    function mostrarResumenTurnoVehiculos() {
      const container = document.getElementById('resumen-turno-vehiculos');
      const servicios = turnosSeparados.vehiculos.servicios;
      
      let html = `
        <div style="background:#232323;border-radius:10px;overflow:hidden;">
          <div style="background:#ff3b3f;color:#fff;padding:10px 18px;font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:8px;">
            <i class='fas fa-car'></i> Servicios de Veh√≠culos
          </div>
          <div style="padding:18px 18px 10px 18px;">
      `;
      
      let total = 0;
      servicios.forEach(servicio => {
        const subtotal = servicio.precio * servicio.cantidad;
        total += subtotal;
        html += `
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <i class='fas fa-${getIconForService(servicio.service_id)}'></i>
              <span>${servicio.nombre} x${servicio.cantidad}</span>
            </div>
            <div style="text-align:right;min-width:110px;">
              <span style='font-size:0.95em;color:#ccc;'>$${servicio.precio.toLocaleString('es-AR')} c/u</span><br>
              <span style='font-weight:700;'>$${subtotal.toLocaleString('es-AR')}</span>
            </div>
          </div>
        `;
      });
      
      // Informaci√≥n del turno
      html += `<hr style='border:0;border-top:1.5px solid #ff3b3f;margin:18px 0 10px 0;'>`;
      html += `<div style='font-size:1.3rem;font-weight:700;display:flex;justify-content:space-between;align-items:center;'><span>Total:</span> <span style='color:#fff;'>$${total.toLocaleString('es-AR')}</span></div>`;
      html += `<div style='margin-top:10px;'><strong>Fecha:</strong> ${turnosSeparados.vehiculos.fecha} - <strong>Hora:</strong> ${turnosSeparados.vehiculos.hora}</div>`;
      
      if (turnosSeparados.vehiculos.direccion) {
        if (typeof turnosSeparados.vehiculos.direccion === 'object') {
          html += `<div style='margin-top:5px;'><strong>Retiro:</strong> ${turnosSeparados.vehiculos.direccion.retiro}</div>`;
          html += `<div style='margin-top:5px;'><strong>Entrega:</strong> ${turnosSeparados.vehiculos.direccion.entrega}</div>`;
        } else {
          html += `<div style='margin-top:5px;'><strong>Direcci√≥n:</strong> ${turnosSeparados.vehiculos.direccion}</div>`;
        }
      }
      
      html += `</div></div>`;
      container.innerHTML = html;
    }
    
    function mostrarResumenTurnoTapizados() {
      const container = document.getElementById('resumen-turno-tapizados');
      const servicios = turnosSeparados.tapizados.servicios;
      
      let html = `
        <div style="background:#232323;border-radius:10px;overflow:hidden;">
          <div style="background:#ff3b3f;color:#fff;padding:10px 18px;font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:8px;">
            <i class='fas fa-couch'></i> Servicios de Tapizados
          </div>
          <div style="padding:18px 18px 10px 18px;">
      `;
      
      let total = 0;
      servicios.forEach(servicio => {
        const subtotal = servicio.precio * servicio.cantidad;
        total += subtotal;
        html += `
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <i class='fas fa-${getIconForService(servicio.tipo)}'></i>
              <span>${servicio.nombre} x${servicio.cantidad}</span>
            </div>
            <div style="text-align:right;min-width:110px;">
              <span style='font-size:0.95em;color:#ccc;'>$${servicio.precio.toLocaleString('es-AR')} c/u</span><br>
              <span style='font-weight:700;'>$${subtotal.toLocaleString('es-AR')}</span>
            </div>
          </div>
        `;
      });
      
      // Informaci√≥n del turno
      html += `<hr style='border:0;border-top:1.5px solid #ff3b3f;margin:18px 0 10px 0;'>`;
      html += `<div style='font-size:1.3rem;font-weight:700;display:flex;justify-content:space-between;align-items:center;'><span>Total:</span> <span style='color:#fff;'>$${total.toLocaleString('es-AR')}</span></div>`;
      html += `<div style='margin-top:10px;'><strong>Fecha:</strong> ${turnosSeparados.tapizados.fecha} - <strong>Hora:</strong> ${turnosSeparados.tapizados.hora}</div>`;
      html += `<div style='margin-top:5px;'><strong>Direcci√≥n:</strong> ${turnosSeparados.tapizados.direccion}</div>`;
      if (turnosSeparados.tapizados.detalles) {
        html += `<div style='margin-top:5px;'><strong>Detalles:</strong> ${turnosSeparados.tapizados.detalles}</div>`;
      }
      
      html += `</div></div>`;
      container.innerHTML = html;
    }
    
    function mostrarResumenTurnoUnico() {
      const resumenTurno = document.getElementById('resumen-turno');
      
      let html = `
        <div style="background:#232323;border-radius:10px;overflow:hidden;">
          <div style="background:#ff3b3f;color:#fff;padding:10px 18px;font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:8px;">
            <i class='fas fa-list-ul'></i> Resumen del Servicio
          </div>
          <div style="padding:18px 18px 10px 18px;">
      `;
      
      const servicio = servicios[turno.servicio];
      const tipoBadge = turno.tipo === 'especial' ? 
        '<span class="badge bg-warning text-dark">Especial</span>' : 
        '<span class="badge bg-primary">Est√°ndar</span>';
      
      html += `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <i class='fas fa-${servicio.icon}'></i>
            <span>${turno.servicio} ${tipoBadge}</span>
          </div>
          <div style="text-align:right;min-width:110px;">
            <span style='font-size:0.95em;color:#ccc;'>$${servicio.precio.toLocaleString('es-AR')} ${servicio.porMetro ? 'por m¬≤' : ''}</span><br>
            <span style='font-weight:700;'>$${turno.precio.toLocaleString('es-AR')}</span>
          </div>
        </div>
      `;

      // L√≠nea separadora
      html += `<hr style='border:0;border-top:1.5px solid #ff3b3f;margin:18px 0 10px 0;'>`;

      // Total general
      html += `<div style='font-size:1.3rem;font-weight:700;display:flex;justify-content:space-between;align-items:center;'><span>Total:</span> <span style='color:#fff;'>$${turno.precio.toLocaleString('es-AR')}</span></div>`;

      html += `</div></div>`;

      resumenTurno.innerHTML = html;
    }
    
    function getIconForService(serviceId) {
      // Obtener el servicio por ID para determinar el tipo
      const servicio = getServicioPorId(serviceId);
      if (!servicio) return 'cog';
      
      const nombre = servicio.name.toLowerCase();
      if (nombre.includes('veh√≠culo') || nombre.includes('auto') || nombre.includes('suv') || nombre.includes('pickup')) return 'car';
      if (nombre.includes('tapizado') && nombre.includes('veh√≠culo')) return 'car-side';
      if (nombre.includes('motor')) return 'gears';
      if (nombre.includes('sill√≥n')) return 'couch';
      if (nombre.includes('silla')) return 'chair';
      if (nombre.includes('colch√≥n')) return 'bed';
      if (nombre.includes('alfombra')) return 'rug';
      if (nombre.includes('puff')) return 'couch';
      
      return 'cog';
    }


    
    // Event listeners para tipo de servicio
    document.querySelectorAll('input[name="tipo-servicio"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const servicioSeleccionado = document.getElementById('servicio-select').value;
        if (servicioSeleccionado) {
          actualizarDetalleServicio(servicioSeleccionado, this.value);
        }
      });
    });
    
    // Event listener para metros
    document.getElementById('metros-input').addEventListener('input', function() {
      const servicioSeleccionado = document.getElementById('servicio-select').value;
      const tipoSeleccionado = document.querySelector('input[name="tipo-servicio"]:checked').value;
      if (servicioSeleccionado) {
        actualizarDetalleServicio(servicioSeleccionado, tipoSeleccionado);
      }
    });
    
    // Configurar el bot√≥n siguiente
    const btnSiguiente = document.getElementById('btn-siguiente-fijo');
    
    btnSiguiente.onclick = function() {
      console.log('üîÑ Bot√≥n siguiente clickeado, paso actual:', step);
      
      if (step === 1) {
        // Validar que se haya seleccionado al menos un servicio
        if (!serviciosSeleccionados || serviciosSeleccionados.length === 0) {
          alert('Por favor, selecciona al menos un servicio.');
          return;
        }
        
        console.log('‚úÖ Servicios seleccionados:', serviciosSeleccionados);
        
        // Guardar los servicios seleccionados en el objeto turno
        turno.servicios = serviciosSeleccionados;
        turno.categoria = categoriaSeleccionada;
        
        step = 2;
        showStep(step);
        
      } else if (step === 2) {
        // Paso 2: Seleccionar Profesional
        step = 3;
        showStep(step);
        
      } else if (step === 3) {
        // Paso 3: Seleccionar Fecha y Hora
        // Simplificar la l√≥gica - solo validar que haya fecha y hora
        const fechaInput = document.querySelector('input[type="date"]');
        const horaSelect = document.querySelector('select');
        
        if (!fechaInput || !fechaInput.value) {
          alert('Por favor, selecciona una fecha.');
          return;
        }
        
        if (!horaSelect || !horaSelect.value) {
          alert('Por favor, selecciona una hora.');
          return;
        }
        
        turno.fecha = fechaInput.value;
        turno.hora = horaSelect.value;
        
        step = 4;
        showStep(step);
        
      } else if (step === 4) {
        // Paso 4: Datos Personales
        const nombre = document.getElementById('nombre')?.value;
        const apellido = document.getElementById('apellido')?.value;
        const telefono = document.getElementById('telefono')?.value;
        
        if (!nombre || !apellido || !telefono) {
          alert('Por favor, completa todos los campos obligatorios.');
          return;
        }
        
        turno.nombre = nombre;
        turno.apellido = apellido;
        turno.telefono = telefono;
        
        step = 5;
        showStep(step);
        
      } else if (step === 5) {
        // Paso 5: Ubicaci√≥n
        const ubicacion = document.getElementById('ubicacion')?.value;
        const direccion = document.getElementById('direccion')?.value;
        
        if (!ubicacion || !direccion) {
          alert('Por favor, completa la ubicaci√≥n y direcci√≥n.');
          return;
        }
        
        turno.ubicacion = ubicacion;
        turno.direccion = direccion;
        
        step = 6;
        showStep(step);
        
      } else if (step === 6) {
        // Paso 6: Confirmaci√≥n
        console.log('üéØ Confirmando turno:', turno);
        
        // Aqu√≠ ir√≠a la l√≥gica para enviar al backend
        alert('¬°Turno confirmado! Te contactaremos pronto.');
      }
    };
       
       if (categorias.necesitaTurnosSeparados) {
         // Validar ubicaciones separadas
         const direccionTapizados = document.getElementById('direccion-domicilio-input-tapizados')?.value;
         
         if (!direccionTapizados) {
           alert('Por favor, ingresa la direcci√≥n para los servicios de tapizados.');
           return;
         }
         
         turnosSeparados.tapizados.direccion = direccionTapizados;
         turnosSeparados.tapizados.detalles = document.getElementById('detalles-ubicacion-tapizados')?.value;
         
         // Para veh√≠culos, verificar retiro y entrega
         const retiroEntrega = document.querySelector('input[name="retiro-entrega-vehiculos"]:checked');
         if (retiroEntrega && retiroEntrega.value === 'si') {
           const direccionRetiro = document.getElementById('direccion-retiro-input-vehiculos')?.value;
           const direccionEntrega = document.getElementById('direccion-entrega-input-vehiculos')?.value;
           
           if (!direccionRetiro || !direccionEntrega) {
             alert('Por favor, completa las direcciones de retiro y entrega para veh√≠culos.');
             return;
           }
           
           turnosSeparados.vehiculos.direccion = { retiro: direccionRetiro, entrega: direccionEntrega };
         } else {
           // Cliente lleva el veh√≠culo
           turnosSeparados.vehiculos.direccion = 'El cliente lleva el veh√≠culo a la instalaci√≥n';
         }
         
       } else if (categorias.hayVehiculos) {
         // Solo servicios de veh√≠culos
         const retiroEntrega = document.querySelector('input[name="retiro-entrega-vehiculos"]:checked');
         if (retiroEntrega && retiroEntrega.value === 'si') {
           const direccionRetiro = document.getElementById('direccion-retiro-input-vehiculos')?.value;
           const direccionEntrega = document.getElementById('direccion-entrega-input-vehiculos')?.value;
           
           if (!direccionRetiro || !direccionEntrega) {
             alert('Por favor, completa las direcciones de retiro y entrega.');
             return;
           }
           
           turnosSeparados.vehiculos.direccion = { retiro: direccionRetiro, entrega: direccionEntrega };
         } else {
           // Cliente lleva el veh√≠culo
           turnosSeparados.vehiculos.direccion = 'El cliente lleva el veh√≠culo a la instalaci√≥n';
         }
         
       } else if (categorias.hayTapizados) {
         // Solo servicios de tapizados
         const direccionTapizados = document.getElementById('direccion-domicilio-input-tapizados')?.value;
         
         if (!direccionTapizados) {
           alert('Por favor, ingresa la direcci√≥n donde se realizar√° el servicio.');
           return;
         }
         
         turnosSeparados.tapizados.direccion = direccionTapizados;
         turnosSeparados.tapizados.detalles = document.getElementById('detalles-ubicacion-tapizados')?.value;
       }
       
       step = 6;
       showStep(step);
     }
   };
   document.getElementById('btn-confirmar-fijo').onclick = async function() {
     // Usar la nueva funci√≥n que maneja el backend y pago
     await confirmarTurnoConBackend();
   }

   // L√≥gica para mostrar/ocultar y mover los botones fijos seg√∫n el paso
   function actualizarBotoneraFija() {
     const anterior = document.getElementById('btn-anterior-fijo');
     const siguiente = document.getElementById('btn-siguiente-fijo');
     const confirmar = document.getElementById('btn-confirmar-fijo');
     anterior.style.display = (step > 1 && step < 7) ? '' : 'none';
     siguiente.style.display = (step >= 1 && step < 6) ? '' : 'none';
     confirmar.style.display = (step === 6) ? '' : 'none';
   }
   // Ocultar los botones originales de cada paso
   function ocultarBotonesOriginales() {
     const ids = [
       'to-step-2', 'to-step-3', 'back-to-1', 'back-to-2', 'back-to-3', 'back-to-4',
       'confirmar-turno'
     ];
     ids.forEach(id => {
       const btn = document.getElementById(id);
       if (btn) btn.style.display = 'none';
     });
   }
   // Eventos para los botones fijos
   document.getElementById('btn-anterior-fijo').onclick = function() {
     if (step === 2) step = 1;
     else if (step === 3) step = 2;
     else if (step === 4) step = 3;
     else if (step === 5) step = 4;
     else if (step === 6) step = 5;
     showStep(step);
     actualizarBotoneraFija();
     ocultarBotonesOriginales();
   };
   // Al mostrar cada paso, actualizar la botonera fija y ocultar los botones originales
   const oldShowStep = showStep;
   showStep = function(n) {
     oldShowStep(n);
     actualizarBotoneraFija();
     ocultarBotonesOriginales();
   };
   // Inicializar botonera fija al cargar
   actualizarBotoneraFija();
   ocultarBotonesOriginales();
   // L√≥gica para mostrar opciones de sillones con botones de tipo y controles de cantidad
   // Event listeners para los botones de tipo de sill√≥n
   const sillonTipos = document.querySelectorAll('input[name="sillon-tipo"]');
   const sillonesSeleccionados = document.getElementById('sillones-seleccionados');
   const totalSpan = document.getElementById('sillones-total');

   // Cuando se selecciona un tipo de sill√≥n
   sillonTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       
       // Verificar si ya existe este tipo
       const existe = sillonesAgregados.find(s => s.nombre === armarNombreServicio('sillon', tipoSeleccionado));
       if (existe) {
         // Si ya existe, aumentar cantidad
         existe.cantidad++;
       } else {
         // Si no existe, agregar nuevo usando la funci√≥n centralizada
         agregarServicioSeleccionado('sillon', tipoSeleccionado, 1);
       }
       
       renderSillonesCards();
       actualizarTotalSillones();
       
       // Desmarcar el radio button para poder seleccionar otro tipo
       this.checked = false;
     });
   });

   // Event listeners para los botones de tipo de silla
   const sillaTipos = document.querySelectorAll('input[name="silla-tipo"]');
   const sillasSeleccionadas = document.getElementById('sillas-seleccionadas');
   const totalSillasSpan = document.getElementById('sillas-total');

   // Cuando se selecciona un tipo de silla
   sillaTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       
       // Verificar si ya existe este tipo
       const existe = sillasAgregadas.find(s => s.nombre === armarNombreServicio('silla', tipoSeleccionado));
       if (existe) {
         // Si ya existe, aumentar cantidad
         existe.cantidad++;
       } else {
         // Si no existe, agregar nuevo usando la funci√≥n centralizada
         agregarServicioSeleccionado('silla', tipoSeleccionado, 1);
       }
       
       renderSillasCards();
       actualizarTotalSillas();
       
       // Desmarcar el radio button para poder seleccionar otro tipo
       this.checked = false;
     });
   });

   // Event listeners para los botones de tipo de colch√≥n
   const colchonTipos = document.querySelectorAll('input[name="colchon-tipo"]');
   const colchonesSeleccionados = document.getElementById('colchones-seleccionados');
   const totalColchonesSpan = document.getElementById('colchones-total');

   // Cuando se selecciona un tipo de colch√≥n
   colchonTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       
       // Verificar si ya existe este tipo
       const existe = colchonesAgregados.find(c => c.nombre === armarNombreServicio('colchon', tipoSeleccionado));
       if (existe) {
         // Si ya existe, aumentar cantidad
         existe.cantidad++;
       } else {
         // Si no existe, agregar nuevo usando la funci√≥n centralizada
         agregarServicioSeleccionado('colchon', tipoSeleccionado, 1);
       }
       
       renderColchonesCards();
       actualizarTotalColchones();
       
       // Desmarcar el radio button para poder seleccionar otro tipo
       this.checked = false;
     });
   });

   // Event listeners para los botones de tipo de veh√≠culo
   const vehiculoTipos = document.querySelectorAll('input[name="vehiculo-tipo"]');
   const vehiculosSeleccionados = document.getElementById('vehiculos-seleccionados');
   const totalVehiculosSpan = document.getElementById('vehiculos-total');

   // Cuando se selecciona un tipo de veh√≠culo
   vehiculoTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       
       // Verificar si ya existe este tipo
       const existe = vehiculosAgregados.find(v => v.nombre === armarNombreServicio('vehiculo', tipoSeleccionado));
       if (existe) {
         // Si ya existe, aumentar cantidad
         existe.cantidad++;
       } else {
         // Si no existe, agregar nuevo usando la funci√≥n centralizada
         agregarServicioSeleccionado('vehiculo', tipoSeleccionado, 1);
       }
       
       renderVehiculosCards();
       actualizarTotalVehiculos();
       
       // Desmarcar el radio button para poder seleccionar otro tipo
       this.checked = false;
     });
   });

   // Event listeners para los botones de tipo de motor
   const motorTipos = document.querySelectorAll('input[name="motor-tipo"]');
   const motoresSeleccionados = document.getElementById('motores-seleccionados');
   const totalMotoresSpan = document.getElementById('motores-total');

   // Cuando se selecciona un tipo de motor
   motorTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       
       // Verificar si ya existe este tipo
       const existe = motoresAgregados.find(m => m.nombre === armarNombreServicio('motor', tipoSeleccionado));
       if (existe) {
         // Si ya existe, aumentar cantidad
         existe.cantidad++;
       } else {
         // Si no existe, agregar nuevo usando la funci√≥n centralizada
         agregarServicioSeleccionado('motor', tipoSeleccionado, 1);
       }
       
       renderMotoresCards();
       actualizarTotalMotores();
       
       // Desmarcar el radio button para poder seleccionar otro tipo
       this.checked = false;
     });
   });

   // Event listener para el input de metros cuadrados de alfombra
   const alfombraMetrosInput = document.getElementById('alfombra-metros');
   const alfombrasSeleccionadas = document.getElementById('alfombras-seleccionadas');
   const totalAlfombrasSpan = document.getElementById('alfombras-total');

   // Cuando se ingresa metros cuadrados de alfombra
   if (alfombraMetrosInput) {
     alfombraMetrosInput.addEventListener('input', function() {
     const metrosCuadrados = parseFloat(this.value) || 0;
     
     if (metrosCuadrados > 0) {
       // Limpiar alfombras existentes
       alfombrasAgregadas.length = 0;
       
       // Agregar nueva alfombra con metros cuadrados
       const serviceId = obtenerIdServicio('Limpieza de Alfombra (por m¬≤)');
       alfombrasAgregadas.push({
         service_id: serviceId,
         nombre: `Limpieza de Alfombra (${metrosCuadrados} m¬≤)`,
         metrosCuadrados: metrosCuadrados
       });
       
       renderAlfombrasCards();
       actualizarTotalAlfombras();
     } else {
       // Si no hay metros, limpiar alfombras
       alfombrasAgregadas.length = 0;
       renderAlfombrasCards();
       actualizarTotalAlfombras();
     }
   });
   }

   // Event listeners para los botones de tipo de puff
   const puffTipos = document.querySelectorAll('input[name="puff-tipo"]');
   const puffsSeleccionados = document.getElementById('puffs-seleccionados');
   const totalPuffsSpan = document.getElementById('puffs-total');

   // Cuando se selecciona un tipo de puff
   if (puffTipos.length > 0) {
     puffTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       
       // Verificar si ya existe este tipo
       const existe = puffsAgregados.find(p => p.nombre === armarNombreServicio('puff', tipoSeleccionado));
       if (existe) {
         // Si ya existe, aumentar cantidad
         existe.cantidad++;
       } else {
         // Si no existe, agregar nuevo usando la funci√≥n centralizada
         agregarServicioSeleccionado('puff', tipoSeleccionado, 1);
       }
       
       renderPuffsCards();
       actualizarTotalPuffs();
       
       // Desmarcar el radio button para poder seleccionar otro tipo
       this.checked = false;
     });
   });
   }

   // Event listeners para los botones de tipo de tapizado de veh√≠culo
   const tapizadovehiculoTipos = document.querySelectorAll('input[name="tapizadovehiculo-tipo"]');
   const tapizadovehiculosSeleccionados = document.getElementById('tapizadovehiculos-seleccionados');
   const totalTapizadoVehiculosSpan = document.getElementById('tapizadovehiculos-total');

   // Cuando se selecciona un tipo de tapizado de veh√≠culo
   if (tapizadovehiculoTipos.length > 0) {
     tapizadovehiculoTipos.forEach(radio => {
     radio.addEventListener('change', function() {
       const tipoSeleccionado = this.value;
       // Verificar si ya existe este tipo
       const existe = tapizadoVehiculosAgregados.find(tv => tv.nombre === armarNombreServicio('tapizadoVehiculo', tipoSeleccionado));
       if (existe) {
         existe.cantidad++;
       } else {
         agregarServicioSeleccionado('tapizadoVehiculo', tipoSeleccionado, 1);
       }
       renderTapizadoVehiculosCards();
       actualizarTotalTapizadoVehiculos();
       this.checked = false;
     });
   });
   }

  // ===== INTEGRACI√ìN CON BACKEND =====

  // Funci√≥n para crear turno en el backend
  async function crearTurnoEnBackend(datosTurno) {
    try {
      const response = await apiService.createAppointment(datosTurno);
      
      if (response.success) {
        return response.data;
      } else {
        throw new Error(response.message);
      }
    } catch (error) {
      console.error('Error creando turno:', error);
      throw error;
    }
  }

  // Funci√≥n para actualizar el paso 3 con disponibilidad real (ELIMINADA - DUPLICADA)

  // Funci√≥n para cargar horarios disponibles
  async function cargarHorariosDisponibles(fecha, selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Cargando horarios...</option>';
    
    try {
      // Calcular duraci√≥n de servicios seg√∫n la categor√≠a
      let duracion = 120; // duraci√≥n por defecto
      const categorizacion = categorizarServicios();
      
      if (selectId === 'hora-vehiculos' && categorizacion.hayVehiculos) {
        const serviciosVehiculos = turnosSeparados.vehiculos.servicios;
        duracion = calcularDuracionServicios(serviciosVehiculos);
      } else if (selectId === 'hora-tapizados' && categorizacion.hayTapizados) {
        const serviciosTapizados = turnosSeparados.tapizados.servicios;
        duracion = calcularDuracionServicios(serviciosTapizados);
      } else if (selectId === 'hora') {
        // Para turno √∫nico, calcular duraci√≥n de todos los servicios
        const todosLosServicios = carrito.map(item => ({
          service_id: item.service_id,
          cantidad: item.cantidad
        }));
        duracion = calcularDuracionServicios(todosLosServicios);
      }
      
      console.log(`Calculando disponibilidad para ${selectId} con duraci√≥n: ${duracion} minutos`);
      
      // Mostrar informaci√≥n de duraci√≥n al usuario
      const horas = Math.floor(duracion / 60);
      const minutos = duracion % 60;
      const tiempoTexto = horas > 0 ? `${horas}h ${minutos}min` : `${minutos}min`;
      
      // Actualizar el texto del select para mostrar la duraci√≥n
      const select = document.getElementById(selectId);
      if (select) {
        const optionActual = select.querySelector('option[selected]');
        if (optionActual) {
          optionActual.textContent += ` (${tiempoTexto})`;
        }
      }
      
      const disponibilidad = await obtenerDisponibilidad(fecha, duracion);
      
      if (!disponibilidad.isWorkingDay) {
        select.innerHTML = '<option value="">No hay horarios disponibles</option>';
        return;
      }
      
      if (disponibilidad.isBlocked) {
        select.innerHTML = `<option value="">D√≠a bloqueado: ${disponibilidad.reason}</option>`;
        return;
      }
      
      const opciones = disponibilidad.availableSlots
        .filter(slot => slot.available)
        .map(slot => `<option value="${slot.startTime}">${slot.startTime} - ${slot.endTime}</option>`)
        .join('');
      
      select.innerHTML = opciones || '<option value="">No hay horarios disponibles</option>';
      
    } catch (error) {
      select.innerHTML = '<option value="">Error cargando horarios</option>';
      console.error('Error cargando horarios:', error);
    }
  }

  // Funci√≥n para confirmar turno con backend
  async function confirmarTurnoConBackend() {
    // Confirmar turno y abrir WhatsApp
    let mensaje = `¬°Hola! Quiero reservar turno en Daytona Clean Service:%0A%0A`;
    mensaje += `Cliente: ${turno.nombre} ${turno.apellido}%0A`;
    mensaje += `Tel√©fono: ${turno.telefono}%0A`;
    mensaje += `Email: ${turno.email}%0A%0A`;
    mensaje += `Servicio: ${turno.servicio}%0A`;
    mensaje += `Tipo: ${turno.tipo === 'especial' ? 'Especial' : 'Est√°ndar'}%0A`;
    mensaje += `Precio: $${turno.precio.toLocaleString('es-AR')}%0A`;
    mensaje += `Fecha: ${turno.fecha}%0A`;
    mensaje += `Hora: ${turno.hora}%0A`;
    mensaje += `Direcci√≥n: ${turno.direccion || 'A confirmar'}%0A%0A`;
    
    // --- NUEVO: Armar datos para backend ---
    let turnoParaBackend = {};
    const servicio = servicios[turno.servicio];
    const serviceId = obtenerIdServicio(turno.servicio, turno.tipo);
    
    // Armar objeto para backend
    turnoParaBackend = {
      clientName: turno.nombre + ' ' + turno.apellido,
      clientPhone: turno.telefono,
      clientEmail: turno.email,
      appointmentDate: turno.fecha,
      appointmentTime: turno.hora,
      services: [{
        service_id: serviceId,
        quantity: 1
      }],
      serviceLocation: turno.direccion || 'A confirmar',
      service_type: turno.categoria || 'general'
    };
    // Si el usuario est√° logueado, agregar userId
    const userData = localStorage.getItem('userData');
    if (userData) {
      const user = JSON.parse(userData);
      turnoParaBackend.userId = user.id;
    }
    // --- FIN NUEVO ---
    // --- Enviar al backend ---
    console.log('Turno enviado al backend:', turnoParaBackend);
    let appointmentId;
    try {
      const response = await fetch('https://daytona-clean-service.onrender.com/api/appointments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(localStorage.getItem('token') ? { 'Authorization': `Bearer ${localStorage.getItem('token')}` } : {})
        },
        body: JSON.stringify(turnoParaBackend)
      });
      const data = await response.json();
      if (!data.success) {
        mostrarError('Error al guardar el turno: ' + (data.message || '')); 
        return;
      }
      appointmentId = data.appointmentId;
    } catch (err) {
      mostrarError('Error de conexi√≥n al guardar el turno');
      return;
    }

    // --- Crear preferencia de pago ---
    try {
      const paymentData = {
        appointmentId: appointmentId,
        amount: turno.precio,
        title: `${turno.servicio} ${turno.tipo === 'especial' ? 'Especial' : 'Est√°ndar'} - Daytona Clean Service`,
        description: `${turno.servicio} (${turno.tipo === 'especial' ? 'Servicio Especial' : 'Servicio Est√°ndar'})`
      };

      // Verificar si el usuario est√° autenticado
      const token = localStorage.getItem('token');
      let paymentResult;
      
      if (token) {
        // Usar ruta autenticada
        paymentResult = await window.apiService.createPaymentPreference(paymentData);
      } else {
        // Usar ruta p√∫blica
        paymentResult = await window.apiService.createPaymentPreferencePublic(paymentData);
      }
      
      if (!paymentResult.success) {
        mostrarError('Error al crear el pago: ' + (paymentResult.message || ''));
        return;
      }

      // --- Redirigir a Mercado Pago ---
      const initPoint = paymentResult.data.initPoint || paymentResult.data.sandboxInitPoint;
      if (initPoint) {
        window.location.href = initPoint;
      } else {
        mostrarError('Error al obtener el enlace de pago');
      }

    } catch (err) {
      console.error('Error creando pago:', err);
      mostrarError('Error al procesar el pago: ' + (err.message || ''));
      return;
    }
  }

  // Funci√≥n para obtener ID del servicio por nombre
  function obtenerIdServicio(nombre, tipo) {
    const mapeoServicios = {
      // VEH√çCULOS
      'Lavado de Auto': tipo === 'especial' ? 2 : 1,
      'Lavado de Pickup': tipo === 'especial' ? 4 : 3,
      'Lavado de SUV': tipo === 'especial' ? 6 : 5,
      'Limpieza de Motor': tipo === 'especial' ? 8 : 7,
      'Tapizado de Auto': tipo === 'especial' ? 10 : 9,
      'Tapizado de Pickup': tipo === 'especial' ? 12 : 11,
      'Tapizado de SUV': tipo === 'especial' ? 14 : 13,
      
      // TAPIZADOS
      'Sill√≥n 1 Cuerpo': tipo === 'especial' ? 16 : 15,
      'Sill√≥n 2 Cuerpos': tipo === 'especial' ? 18 : 17,
      'Sill√≥n 3 Cuerpos': tipo === 'especial' ? 20 : 19,
      'Silla Simple': tipo === 'especial' ? 22 : 21,
      'Silla Comedor': tipo === 'especial' ? 24 : 23,
      'Colch√≥n 1 Plaza': tipo === 'especial' ? 26 : 25,
      'Colch√≥n 2 Plazas': tipo === 'especial' ? 28 : 27,
      'Limpieza de Alfombra': tipo === 'especial' ? 30 : 29,
      'Puff Simple': tipo === 'especial' ? 32 : 31,
      'Puff Grande': tipo === 'especial' ? 34 : 33,
      'Respaldo de Cama': tipo === 'especial' ? 36 : 35
    };
    
    return mapeoServicios[nombre] || 1;
  }

  // Funci√≥n para mostrar confirmaci√≥n
  function mostrarConfirmacion(mensaje) {
    const modal = new bootstrap.Modal(document.getElementById('confirmacionModal'));
    document.getElementById('confirmacionMensaje').textContent = mensaje;
    modal.show();
  }

  // Funci√≥n para mostrar error
  function mostrarError(mensaje) {
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    document.getElementById('errorMensaje').textContent = mensaje;
    modal.show();
  }

  // Funci√≥n para generar mensaje de confirmaci√≥n
  function generarMensajeConfirmacion(turno) {
    const servicios = turno.services.map(s => `${s.service_name} x${s.quantity}`).join(', ');
    return `¬°Hola! Tu turno ha sido confirmado:

üìÖ Fecha: ${turno.appointment_date}
‚è∞ Hora: ${turno.appointment_time}
üë§ Cliente: ${turno.client_name}
üìû Tel√©fono: ${turno.client_phone}
üìç Direcci√≥n: ${turno.address || 'A confirmar'}
üõ†Ô∏è Servicios: ${servicios}
üí∞ Total: $${turno.total_amount}

¬°Gracias por elegir Daytona Clean Service! üöó‚ú®`;
  }

  // Funci√≥n para generar mensaje de confirmaci√≥n separado
  function generarMensajeConfirmacionSeparado(turnoVehiculos, turnoTapizados) {
    const serviciosVehiculos = turnoVehiculos.services.map(s => `${s.service_name} x${s.quantity}`).join(', ');
    const serviciosTapizados = turnoTapizados.services.map(s => `${s.service_name} x${s.quantity}`).join(', ');
    
    return `¬°Hola! Tus turnos han sido confirmados:

üöó TURNO VEH√çCULOS:
üìÖ Fecha: ${turnoVehiculos.appointment_date}
‚è∞ Hora: ${turnoVehiculos.start_time}
üõ†Ô∏è Servicios: ${serviciosVehiculos}
üí∞ Total: $${turnoVehiculos.total_amount}

üõãÔ∏è TURNO TAPIZADOS:
üìÖ Fecha: ${turnoTapizados.appointment_date}
‚è∞ Hora: ${turnoTapizados.start_time}
üõ†Ô∏è Servicios: ${serviciosTapizados}
üí∞ Total: $${turnoTapizados.total_amount}

üë§ Cliente: ${turnoVehiculos.client_name}
üìû Tel√©fono: ${turnoVehiculos.client_phone}

¬°Gracias por elegir Daytona Clean Service! üöó‚ú®`;
  }

  // Mostrar/ocultar campos seg√∫n el tipo de servicio seleccionado
  function actualizarCamposDireccion() {
    const hayVehiculos = window.categorias && window.categorias.hayVehiculos;
    const hayTapizados = window.categorias && window.categorias.hayTapizados;
    document.getElementById('direccion-vehiculo-group').style.display = hayVehiculos ? 'block' : 'none';
    document.getElementById('direccion-tapizado-group').style.display = hayTapizados ? 'block' : 'none';
  }
  // Llamar esta funci√≥n cada vez que se cambia el tipo de servicio
  // ... existing code ...
  // L√≥gica para armar el campo serviceLocation en confirmarTurnoConBackend
  // ... dentro de confirmarTurnoConBackend ...

  });

  // Funci√≥n para obtener el paso actual
  function obtenerPasoActual() {
    return window.step || 1;
  }
  
  // Funci√≥n para ir al siguiente paso
  function siguientePaso() {
    const currentStep = window.step || 1;
    if (currentStep < 6) {
      window.step = currentStep + 1;
      // Usar la funci√≥n showStep que ya existe en el scope
      if (typeof showStep === 'function') {
        showStep(window.step);
      } else {
        console.warn('‚ö†Ô∏è Funci√≥n showStep no disponible');
      }
    }
  }

  // Actualizar la funci√≥n del bot√≥n siguiente para usar el backend
    const btnSiguiente = document.getElementById('btn-siguiente-fijo');
    if (btnSiguiente) {
      btnSiguiente.addEventListener('click', async function() {
        const pasoActual = obtenerPasoActual();
        
        if (pasoActual === 2) {
          // Al pasar al paso 3, actualizar disponibilidad
        if (typeof actualizarDisponibilidadPaso3 === 'function') {
          await actualizarDisponibilidadPaso3();
        } else {
          console.warn('‚ö†Ô∏è Funci√≥n actualizarDisponibilidadPaso3 no disponible');
        }
        }
        
        siguientePaso();
      });
    }

    // El bot√≥n confirmar ya est√° configurado arriba con btn-confirmar-fijo

    // Restringir fechas pasadas en los inputs de fecha
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    const minDate = `${yyyy}-${mm}-${dd}`;
    const inputsFecha = [
      document.getElementById('fecha-vehiculos'),
      document.getElementById('fecha-tapizados'),
      document.getElementById('fecha')
    ];
    inputsFecha.forEach(input => { if (input) input.setAttribute('min', minDate); });

    // L√≥gica para deshabilitar horarios ocupados en veh√≠culos y tapizados
    async function actualizarHorariosDisponibles(fecha, selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      // Habilitar todos los horarios primero
      Array.from(select.options).forEach(opt => { opt.disabled = false; });
      if (!fecha) return;
      try {
        const disponibilidad = await obtenerDisponibilidad(fecha);
        if (disponibilidad && Array.isArray(disponibilidad.ocupados)) {
          disponibilidad.ocupados.forEach(horaOcupada => {
            const opt = Array.from(select.options).find(o => o.value === horaOcupada);
            if (opt) opt.disabled = true;
          });
        }
      } catch (e) {
        console.error('Error consultando disponibilidad:', e);
      }
    }
    // Event listeners para fechas
    document.getElementById('fecha-vehiculos')?.addEventListener('change', async function() {
      await actualizarDisponibilidadPaso3();
    });
    document.getElementById('fecha-tapizados')?.addEventListener('change', async function() {
      await actualizarDisponibilidadPaso3();
    });

  // --- L√≥gica profesional de armado de nombres y b√∫squeda de precios ---

  function armarNombreServicio(tipo, subtipo) {
    if (tipo === "vehiculo") {
      if (subtipo === 'auto') return 'Limpieza de Auto';
      if (subtipo === 'pickup') return 'Limpieza de Pickup';
      if (subtipo === 'suv') return 'Limpieza de SUV';
      return '';
    }
    if (tipo === "tapizadoVehiculo") {
      // Mapear subtipo a nombre exacto de la BD
      if (subtipo === 'auto') return 'Limpieza de Tapizado de Auto';
      if (subtipo === 'suv') return 'Limpieza de Tapizado de SUV';
      if (subtipo === 'pickup') return 'Limpieza de Tapizado de Pickup';
      return '';
    }
    if (tipo === "motor") {
      // Mapear subtipo a nombre exacto de la BD
      if (subtipo === 'completa') return 'Motor Completa';
      if (subtipo === 'detallada') return 'Motor Detallada';
      return '';
    }
    if (tipo === "sillon") return `Sill√≥n ${subtipo}`;
    if (tipo === "silla") return `Silla ${subtipo}`;
    if (tipo === "colchon") return `Colch√≥n de ${subtipo}`;
    if (tipo === "puff") {
      // Mapear subtipo a nombre exacto de la BD
      if (subtipo === 'simple') return 'Puff Simple';
      if (subtipo === 'grande') return 'Puff Grande';
      if (subtipo === 'especial') return 'Puff Especial';
      return '';
    }
    if (tipo === "tapizadoSilla") return `Limpieza de Tapizado de Silla`;
    if (tipo === "tapizadoAlfombra") return `Limpieza de Tapizado de Alfombra`;
    return "";
  }

  function capitalizarPrimeraLetra(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  }

  function getPrecioDesdeBD(tipo, subtipo) {
    const nombre = armarNombreServicio(tipo, subtipo);
    const servicio = serviciosBD.find(s => s.name === nombre);
    return servicio ? servicio.price : 0;
  }

  // Reemplazar en TODO el archivo cualquier referencia a precios hardcodeados o funciones viejas de precios
  // Usar SIEMPRE getPrecioDesdeBD(tipo, subtipo) para mostrar precios en cards, resumen, confirmaci√≥n, etc.
  // Ejemplo de uso:
  // const precio = getPrecioDesdeBD('vehiculo', 'SUV');
  // const precio = getPrecioDesdeBD('sillon', '2 cuerpos');
  // ... existing code ...

  // --- Refactor profesional: trabajar siempre con service_id ---

  function getServicioPorId(serviceId) {
    return serviciosBD.find(s => s.id === serviceId);
  }

  // Al agregar un servicio, buscar el objeto en serviciosBD y guardar el id
  function agregarServicioSeleccionado(tipo, subtipo, cantidad) {
    // Buscar el servicio en la BD por nombre exacto
    let nombre = armarNombreServicio(tipo, subtipo);
    let servicio = serviciosBD.find(s => s.name === nombre);
    if (!servicio) {
      console.error('No se encontr√≥ el servicio en la BD:', nombre);
      return;
    }
    // Agregar al array correspondiente
    let obj = {
      service_id: servicio.id,
      nombre: servicio.name,
      cantidad: cantidad,
      precio: servicio.price
    };
    
    // Agregar al array correspondiente seg√∫n el tipo
    switch(tipo) {
      case 'sillon':
        sillonesAgregados.push(obj);
        break;
      case 'silla':
        sillasAgregadas.push(obj);
        break;
      case 'colchon':
        colchonesAgregados.push(obj);
        break;
      case 'vehiculo':
        vehiculosAgregados.push(obj);
        break;
      case 'tapizadoVehiculo':
        tapizadoVehiculosAgregados.push(obj);
        break;
      case 'motor':
        motoresAgregados.push(obj);
        break;
      case 'alfombra':
        alfombrasAgregadas.push(obj);
        break;
      case 'puff':
        puffsAgregados.push(obj);
        break;
      default:
        console.error('Tipo de servicio no reconocido:', tipo);
        return;
    }
    
    console.log(`‚úÖ Servicio agregado: ${nombre} (ID: ${servicio.id})`);
  }

  // Para mostrar el precio en cards y resumen:
  function getPrecioPorId(serviceId) {
    const servicio = getServicioPorId(serviceId);
    return servicio ? servicio.price : 0;
  }

  // Al armar el request al backend:
  function armarServiciosParaBackend(arrayServicios) {
    return arrayServicios.map(s => ({
      service_id: s.service_id,
      quantity: s.cantidad
    }));
  }
  // ... existing code ...

  // Inicializar servicio de turnos
  const turnosService = new TurnosService();

  // Variables globales para el sistema de servicios
  let categoriaSeleccionada = null;
  let serviciosSeleccionados = [];

  // Funci√≥n para seleccionar categor√≠a
  function seleccionarCategoria(categoria) {
    categoriaSeleccionada = categoria;
    
    // Ocultar selector de categor√≠as
    document.querySelector('.categoria-selector').style.display = 'none';
    
    // Mostrar servicios de la categor√≠a seleccionada
    document.getElementById(`servicios-${categoria}`).style.display = 'block';
    
    // Actualizar bot√≥n siguiente
    document.getElementById('btn-siguiente-fijo').style.display = 'block';
  }

  // Funci√≥n para cambiar de categor√≠a
  function cambiarCategoria() {
    categoriaSeleccionada = null;
    serviciosSeleccionados = [];
    
    // Ocultar todos los contenedores de servicios
    document.querySelectorAll('.servicios-container').forEach(container => {
      container.style.display = 'none';
    });
    
    // Mostrar selector de categor√≠as
    document.querySelector('.categoria-selector').style.display = 'block';
    
    // Ocultar servicios seleccionados
    document.getElementById('servicios-seleccionados').style.display = 'none';
    
    // Ocultar bot√≥n siguiente
    document.getElementById('btn-siguiente-fijo').style.display = 'none';
    
    // Limpiar selecciones
    document.querySelectorAll('.servicio-card.selected').forEach(card => {
      card.classList.remove('selected');
    });
  }

  // Funci√≥n para seleccionar servicio
  function seleccionarServicio(servicioItem) {
    const servicioId = servicioItem.dataset.servicioId;
    const nombre = servicioItem.dataset.nombre;
    const precio = servicioItem.dataset.precio;
    const duracion = servicioItem.dataset.duracion;
    
    // Verificar si ya est√° seleccionado
    const yaSeleccionado = serviciosSeleccionados.find(s => s.service_id === parseInt(servicioId));
    
    if (yaSeleccionado) {
      // Deseleccionar
      servicioItem.classList.remove('selected');
      serviciosSeleccionados = serviciosSeleccionados.filter(s => s.service_id !== parseInt(servicioId));
    } else {
      // Seleccionar
      servicioItem.classList.add('selected');
      serviciosSeleccionados.push({
        service_id: parseInt(servicioId),
        nombre,
        precio: parseFloat(precio),
        duracion: parseInt(duracion),
        cantidad: 1
      });
    }
    
    // Actualizar lista de servicios seleccionados
    actualizarListaServicios();
    
    // Mostrar/ocultar bot√≥n siguiente
    const btnSiguiente = document.getElementById('btn-siguiente-fijo');
    if (serviciosSeleccionados.length > 0) {
      btnSiguiente.style.display = 'block';
    } else {
      btnSiguiente.style.display = 'none';
    }
  }

  // Funci√≥n para actualizar la lista de servicios seleccionados
  function actualizarListaServicios() {
    const container = document.getElementById('lista-servicios');
    const contenedor = document.getElementById('servicios-seleccionados');
    
    if (serviciosSeleccionados.length === 0) {
      contenedor.style.display = 'none';
      return;
    }
    
    contenedor.style.display = 'block';
    container.innerHTML = '';
    
    serviciosSeleccionados.forEach((servicio, index) => {
      const servicioElement = document.createElement('div');
      servicioElement.className = 'col-12';
      servicioElement.innerHTML = `
        <div class="servicio-seleccionado">
          <div>
            <strong>${servicio.nombre}</strong>
            <br>
            <small>$${servicio.precio.toLocaleString()}</small>
          </div>
          <button class="btn-remove" onclick="removerServicio(${index})">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      container.appendChild(servicioElement);
    });
  }

  // Funci√≥n para remover servicio
  function removerServicio(index) {
    const servicio = serviciosSeleccionados[index];
    
    // Remover de la lista
    serviciosSeleccionados.splice(index, 1);
    
    // Deseleccionar el item
    const servicioItem = document.querySelector(`[data-servicio-id="${servicio.service_id}"]`);
    if (servicioItem) {
      servicioItem.classList.remove('selected');
    }
    
    // Actualizar lista
    actualizarListaServicios();
    
    // Mostrar/ocultar bot√≥n siguiente
    const btnSiguiente = document.getElementById('btn-siguiente-fijo');
    if (serviciosSeleccionados.length > 0) {
      btnSiguiente.style.display = 'block';
    } else {
      btnSiguiente.style.display = 'none';
    }
  }

  // Funci√≥n para cargar servicios desde la base de datos
  async function cargarServiciosDesdeBD() {
    try {
      const result = await turnosService.getServices();
      if (result.success) {
        return result.services;
      } else {
        console.error('Error cargando servicios:', result.message);
        return [];
      }
    } catch (error) {
      console.error('Error cargando servicios:', error);
      return [];
    }
  }

  // Funci√≥n para categorizar servicios
  function categorizarServicios(servicios) {
    const vehiculos = [];
    const tapizados = [];
    
    servicios.forEach(servicio => {
      const nombre = servicio.name.toLowerCase();
      
      // Servicios de veh√≠culos
      if (nombre.includes('auto') || nombre.includes('pickup') || nombre.includes('suv') || 
          nombre.includes('motor') || nombre.includes('veh√≠culo') || nombre.includes('car')) {
        vehiculos.push(servicio);
      }
      // Servicios de tapizados
      else if (nombre.includes('sill√≥n') || nombre.includes('silla') || nombre.includes('colch√≥n') || 
               nombre.includes('alfombra') || nombre.includes('puff') || nombre.includes('respaldo') ||
               nombre.includes('tapizado')) {
        tapizados.push(servicio);
      }
    });
    
    return { vehiculos, tapizados };
  }

  // Funci√≥n para renderizar servicios
  function renderizarServicios(categoria, servicios) {
    const container = document.getElementById(`lista-servicios-${categoria}`);
    if (!container) return;
    
    container.innerHTML = '';
    
    servicios.forEach(servicio => {
      const servicioElement = document.createElement('div');
      servicioElement.className = 'servicio-item';
      servicioElement.dataset.servicioId = servicio.id;
      servicioElement.dataset.nombre = servicio.name;
      servicioElement.dataset.precio = servicio.price;
      servicioElement.dataset.duracion = servicio.duration;
      
      // Determinar icono seg√∫n el nombre del servicio
      let icono = 'fas fa-cog';
      const nombre = servicio.name.toLowerCase();
      
      if (nombre.includes('auto') || nombre.includes('car')) icono = 'fas fa-car';
      else if (nombre.includes('pickup')) icono = 'fas fa-truck-pickup';
      else if (nombre.includes('suv')) icono = 'fas fa-car-side';
      else if (nombre.includes('motor')) icono = 'fas fa-cog';
      else if (nombre.includes('sill√≥n')) icono = 'fas fa-couch';
      else if (nombre.includes('silla')) icono = 'fas fa-chair';
      else if (nombre.includes('colch√≥n')) icono = 'fas fa-bed';
      else if (nombre.includes('alfombra')) icono = 'fas fa-rug';
      else if (nombre.includes('puff')) icono = 'fas fa-couch';
      else if (nombre.includes('respaldo')) icono = 'fas fa-bed';
      
      servicioElement.innerHTML = `
        <div class="servicio-info">
          <div class="servicio-icon">
            <i class="${icono}"></i>
          </div>
          <div class="servicio-details">
            <h6>${servicio.name}</h6>
            <p>${servicio.description || 'Servicio de limpieza profesional'}</p>
          </div>
        </div>
        <div class="servicio-precio">
          $${servicio.price.toLocaleString()}
        </div>
      `;
      
      // Agregar event listener
      servicioElement.addEventListener('click', function() {
        seleccionarServicio(this);
      });
      
      container.appendChild(servicioElement);
    });
  }

  // Event listeners para las categor√≠as
  document.addEventListener('DOMContentLoaded', async function() {
    // Cargar servicios desde la base de datos
    const servicios = await cargarServiciosDesdeBD();
    const categorias = categorizarServicios(servicios);
    
    // Event listeners para categor√≠as
    document.getElementById('categoria-vehiculos').addEventListener('click', function() {
      seleccionarCategoria('vehiculos');
      renderizarServicios('vehiculos', categorias.vehiculos);
    });
    
    document.getElementById('categoria-tapizados').addEventListener('click', function() {
      seleccionarCategoria('tapizados');
      renderizarServicios('tapizados', categorias.tapizados);
    });
    
    // Ocultar bot√≥n siguiente inicialmente
    document.getElementById('btn-siguiente-fijo').style.display = 'none';
  });

  // Funci√≥n para cargar horarios disponibles (reemplaza todas las funciones duplicadas)
  async function cargarHorariosDisponibles(fecha, selectId) {
    return await turnosService.loadAvailableHours(fecha, selectId);
  }

  // Funci√≥n para crear turno en el backend (reemplaza todas las funciones duplicadas)
  async function crearTurnoEnBackend(datosTurno) {
    const validation = turnosService.validateAppointmentData(datosTurno);
    if (!validation.isValid) {
      throw new Error(validation.errors.join(', '));
    }
    
    const formattedData = turnosService.formatAppointmentData(datosTurno);
    const result = await turnosService.createAppointment(formattedData);
    
    if (!result.success) {
      throw new Error(result.message);
    }
    
    return result;
  }

  // Funci√≥n para mostrar confirmaci√≥n
  function mostrarConfirmacion(mensaje) {
    alert(mensaje);
  }



  // ===== SISTEMA DE TURNOS FINAL Y FUNCIONAL =====
  
  // Variables globales
  let step = 1;
  let categoriaSeleccionada = null;
  let serviciosSeleccionados = [];
  let turno = {
    servicios: [],
    categoria: null,
    fecha: null,
    hora: null,
    nombre: null,
    apellido: null,
    telefono: null,
    email: null,
    ubicacion: null,
    direccion: null
  };

  // Funci√≥n para seleccionar categor√≠a
  function seleccionarCategoria(categoria) {
    categoriaSeleccionada = categoria;
    
    // Ocultar selector de categor√≠as
    document.querySelector('.categoria-selector').style.display = 'none';
    
    // Mostrar servicios de la categor√≠a seleccionada
    const serviciosContainer = document.getElementById(`servicios-${categoria}`);
    if (serviciosContainer) {
      serviciosContainer.style.display = 'block';
    }
    
    // Mostrar bot√≥n siguiente
    document.getElementById('btn-siguiente-fijo').style.display = 'block';
  }

  // Funci√≥n para cambiar de categor√≠a
  function cambiarCategoria() {
    categoriaSeleccionada = null;
    serviciosSeleccionados = [];
    
    // Ocultar todos los contenedores de servicios
    document.querySelectorAll('.servicios-container').forEach(container => {
      container.style.display = 'none';
    });
    
    // Mostrar selector de categor√≠as
    document.querySelector('.categoria-selector').style.display = 'block';
    
    // Ocultar bot√≥n siguiente
    document.getElementById('btn-siguiente-fijo').style.display = 'none';
    
    // Limpiar lista de servicios seleccionados
    actualizarListaServicios();
  }

  // Funci√≥n para seleccionar servicio
  function seleccionarServicio(servicioItem) {
    const servicioId = servicioItem.dataset.servicioId;
    const nombre = servicioItem.dataset.nombre;
    const precio = parseFloat(servicioItem.dataset.precio);
    const duracion = parseInt(servicioItem.dataset.duracion);
    
    // Verificar si ya est√° seleccionado
    const yaSeleccionado = serviciosSeleccionados.find(s => s.id === servicioId);
    
    if (yaSeleccionado) {
      // Si ya est√° seleccionado, aumentar cantidad
      yaSeleccionado.cantidad++;
    } else {
      // Si no est√° seleccionado, agregarlo
      serviciosSeleccionados.push({
        id: servicioId,
        nombre: nombre,
        precio: precio,
        duracion: duracion,
        cantidad: 1,
        icono: obtenerIconoServicio(nombre)
      });
    }
    
    // Actualizar UI
    actualizarListaServicios();
    servicioItem.classList.add('selected');
    
    // Habilitar bot√≥n siguiente
    document.getElementById('btn-siguiente-fijo').disabled = false;
  }

  // Funci√≥n para remover servicio
  function removerServicio(servicioId) {
    const index = serviciosSeleccionados.findIndex(s => s.id === servicioId);
    if (index !== -1) {
      serviciosSeleccionados.splice(index, 1);
      
      // Actualizar UI
      actualizarListaServicios();
      
      // Deseleccionar en la lista
      const servicioItem = document.querySelector(`[data-servicio-id="${servicioId}"]`);
      if (servicioItem) {
        servicioItem.classList.remove('selected');
      }
      
      // Deshabilitar bot√≥n siguiente si no hay servicios
      if (serviciosSeleccionados.length === 0) {
        document.getElementById('btn-siguiente-fijo').disabled = true;
      }
    }
  }

  // Funci√≥n para actualizar lista de servicios seleccionados
  function actualizarListaServicios() {
    const container = document.getElementById('lista-servicios');
    if (!container) return;
    
    container.innerHTML = '';
    
    serviciosSeleccionados.forEach(servicio => {
      const item = document.createElement('div');
      item.className = 'servicio-seleccionado';
      item.innerHTML = `
        <div class="servicio-info">
          <i class="fas ${servicio.icono}"></i>
          <span>${servicio.nombre}</span>
        </div>
        <div class="servicio-precio">
          $${(servicio.precio * servicio.cantidad).toLocaleString()}
        </div>
        <button onclick="removerServicio('${servicio.id}')" class="btn-remover">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(item);
    });
    
    // Mostrar/ocultar contenedor
    const contenedor = document.getElementById('servicios-seleccionados');
    if (contenedor) {
      contenedor.style.display = serviciosSeleccionados.length > 0 ? 'block' : 'none';
    }
  }

  // Funci√≥n para obtener icono seg√∫n nombre del servicio
  function obtenerIconoServicio(nombre) {
    const nombreLower = nombre.toLowerCase();
    
    if (nombreLower.includes('auto') || nombreLower.includes('car')) return 'fa-car';
    if (nombreLower.includes('pickup')) return 'fa-truck-pickup';
    if (nombreLower.includes('suv')) return 'fa-car-side';
    if (nombreLower.includes('motor')) return 'fa-cog';
    if (nombreLower.includes('sill√≥n')) return 'fa-couch';
    if (nombreLower.includes('silla')) return 'fa-chair';
    if (nombreLower.includes('colch√≥n')) return 'fa-bed';
    if (nombreLower.includes('alfombra')) return 'fa-rug';
    if (nombreLower.includes('puff')) return 'fa-couch';
    
    return 'fa-cog';
  }

  // Funci√≥n para mostrar paso
  function showStep(n) {
    for (let i = 1; i <= 6; i++) {
      const stepDiv = document.getElementById('step-' + i);
      if (stepDiv) stepDiv.style.display = (i === n) ? '' : 'none';
    }
    
    // Actualizar barra de progreso
    updateWizardBar(n);
  }

  // Funci√≥n para actualizar barra de progreso
  function updateWizardBar(step) {
    const percent = ((step - 1) / 5) * 100;
    const barFill = document.getElementById('wizard-bar-fill');
    if (barFill) barFill.style.width = percent + '%';
    
    for (let i = 1; i <= 6; i++) {
      const el = document.getElementById('step-indicator-' + i);
      if (el) {
        el.classList.remove('active', 'completed');
        if (i < step) el.classList.add('completed');
        if (i === step) el.classList.add('active');
      }
    }
  }

  // Funci√≥n para cargar servicios desde la BD
  async function cargarServiciosDesdeBD() {
    try {
      const response = await fetch('/api/appointments/services');
      const data = await response.json();
      
      if (data.success && data.services) {
        const categorias = categorizarServicios(data.services);
        renderizarServicios('vehiculos', categorias.vehiculos);
        renderizarServicios('tapizados', categorias.tapizados);
      }
    } catch (error) {
      console.error('Error cargando servicios:', error);
    }
  }

  // Funci√≥n para categorizar servicios desde BD
  function categorizarServicios(servicios) {
    const vehiculos = [];
    const tapizados = [];
    
    servicios.forEach(servicio => {
      const nombre = servicio.name.toLowerCase();
      
      if (nombre.includes('auto') || nombre.includes('pickup') || nombre.includes('suv') || nombre.includes('motor')) {
        vehiculos.push(servicio);
      } else if (nombre.includes('sill√≥n') || nombre.includes('silla') || nombre.includes('colch√≥n') || nombre.includes('alfombra') || nombre.includes('puff')) {
        tapizados.push(servicio);
      }
    });
    
    return { vehiculos, tapizados };
  }

  // Funci√≥n para renderizar servicios
  function renderizarServicios(categoria, servicios) {
    const container = document.getElementById(`lista-servicios-${categoria}`);
    if (!container) return;
    
    container.innerHTML = '';
    
    servicios.forEach(servicio => {
      const servicioElement = document.createElement('div');
      servicioElement.className = 'servicio-item';
      servicioElement.dataset.servicioId = servicio.id;
      servicioElement.dataset.nombre = servicio.name;
      servicioElement.dataset.precio = servicio.price;
      servicioElement.dataset.duracion = servicio.duration;
      
      const icono = obtenerIconoServicio(servicio.name);
      
      servicioElement.innerHTML = `
        <div class="servicio-info">
          <div class="servicio-icon">
            <i class="${icono}"></i>
          </div>
          <div class="servicio-details">
            <h6>${servicio.name}</h6>
            <p>${servicio.description || 'Servicio de limpieza profesional'}</p>
          </div>
        </div>
        <div class="servicio-precio">
          $${servicio.price.toLocaleString()}
        </div>
      `;
      
      servicioElement.addEventListener('click', function() {
        seleccionarServicio(this);
      });
      
      container.appendChild(servicioElement);
    });
  }

  // Configurar el bot√≥n siguiente
  document.addEventListener('DOMContentLoaded', function() {
    const btnSiguiente = document.getElementById('btn-siguiente-fijo');
    
    btnSiguiente.onclick = function() {
      console.log('üîÑ Bot√≥n siguiente clickeado, paso actual:', step);
      
      if (step === 1) {
        // Validar que se haya seleccionado al menos un servicio
        if (!serviciosSeleccionados || serviciosSeleccionados.length === 0) {
          alert('Por favor, selecciona al menos un servicio.');
          return;
        }
        
        console.log('‚úÖ Servicios seleccionados:', serviciosSeleccionados);
        
        // Guardar los servicios seleccionados en el objeto turno
        turno.servicios = serviciosSeleccionados;
        turno.categoria = categoriaSeleccionada;
        
        step = 2;
        showStep(step);
        
      } else if (step === 2) {
        // Paso 2: Seleccionar Profesional
        step = 3;
        showStep(step);
        
      } else if (step === 3) {
        // Paso 3: Seleccionar Fecha y Hora
        const fechaInput = document.querySelector('input[type="date"]');
        const horaSelect = document.querySelector('select');
        
        if (!fechaInput || !fechaInput.value) {
          alert('Por favor, selecciona una fecha.');
          return;
        }
        
        if (!horaSelect || !horaSelect.value) {
          alert('Por favor, selecciona una hora.');
          return;
        }
        
        turno.fecha = fechaInput.value;
        turno.hora = horaSelect.value;
        
        step = 4;
        showStep(step);
        
      } else if (step === 4) {
        // Paso 4: Datos Personales
        const nombre = document.getElementById('nombre')?.value;
        const apellido = document.getElementById('apellido')?.value;
        const telefono = document.getElementById('telefono')?.value;
        
        if (!nombre || !apellido || !telefono) {
          alert('Por favor, completa todos los campos obligatorios.');
          return;
        }
        
        turno.nombre = nombre;
        turno.apellido = apellido;
        turno.telefono = telefono;
        
        step = 5;
        showStep(step);
        
      } else if (step === 5) {
        // Paso 5: Ubicaci√≥n
        const ubicacion = document.getElementById('ubicacion')?.value;
        const direccion = document.getElementById('direccion')?.value;
        
        if (!ubicacion || !direccion) {
          alert('Por favor, completa la ubicaci√≥n y direcci√≥n.');
          return;
        }
        
        turno.ubicacion = ubicacion;
        turno.direccion = direccion;
        
        step = 6;
        showStep(step);
        
      } else if (step === 6) {
        // Paso 6: Confirmaci√≥n
        console.log('üéØ Confirmando turno:', turno);
        
        // Aqu√≠ ir√≠a la l√≥gica para enviar al backend
        alert('¬°Turno confirmado! Te contactaremos pronto.');
      }
    };

    // Configurar bot√≥n anterior
    const btnAnterior = document.getElementById('btn-anterior-fijo');
    if (btnAnterior) {
      btnAnterior.onclick = function() {
        if (step > 1) {
          step--;
          showStep(step);
        }
      };
    }

    // Event listeners para categor√≠as
    const categoriaVehiculos = document.getElementById('categoria-vehiculos');
    const categoriaTapizados = document.getElementById('categoria-tapizados');
    
    if (categoriaVehiculos) {
      categoriaVehiculos.addEventListener('click', function() {
        seleccionarCategoria('vehiculos');
      });
    }
    
    if (categoriaTapizados) {
      categoriaTapizados.addEventListener('click', function() {
        seleccionarCategoria('tapizados');
      });
    }
    
    // Ocultar bot√≥n siguiente inicialmente
    if (btnSiguiente) {
      btnSiguiente.style.display = 'none';
      btnSiguiente.disabled = true;
    }

  </script>
</body>
</html> 