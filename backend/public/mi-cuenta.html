<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Cuenta - Daytona Clean Service</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/components/header.css" />
  <link rel="stylesheet" href="css/admin-panel.css" />
  <link rel="stylesheet" href="css/client-dashboard.css" />
  <link rel="stylesheet" href="css/components/forms.css">
  
  <style>
    body {
      background: #181818;
      color: #fff;
      font-family: 'Roboto', Arial, sans-serif;
      min-height: 100vh;
    }
    .wizard-step {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #fff;
      font-weight: 500;
      padding: 10px 0;
    }
    .wizard-step.active {
      color: #00d4ff;
    }
    .wizard-step.completed {
      color: #28a745;
    }
    .wizard-step.pending {
      color: #6c757d;
    }
    .wizard-step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .wizard-step.active .wizard-step-number {
      background: #00d4ff;
      color: #000;
    }
    .wizard-step.completed .wizard-step-number {
      background: #28a745;
      color: #fff;
    }
    .wizard-step.pending .wizard-step-number {
      background: #6c757d;
      color: #fff;
    }
    .wizard-step-line {
      flex: 1;
      height: 2px;
      background: #6c757d;
      margin: 0 10px;
    }
    .wizard-step.completed .wizard-step-line {
      background: #28a745;
    }
    .wizard-step.active .wizard-step-line {
      background: #00d4ff;
    }
    .wizard-step.pending .wizard-step-line {
      background: #6c757d;
    }
    .wizard-step:last-child .wizard-step-line {
      display: none;
    }
    .wizard-step-icon {
      font-size: 18px;
    }
    .wizard-step.active .wizard-step-icon {
      color: #00d4ff;
    }
    .wizard-step.completed .wizard-step-icon {
      color: #28a745;
    }
    .wizard-step.pending .wizard-step-icon {
      color: #6c757d;
    }
    .wizard-step-text {
      font-size: 14px;
      font-weight: 500;
    }
    .wizard-step.active .wizard-step-text {
      color: #00d4ff;
    }
    .wizard-step.completed .wizard-step-text {
      color: #28a745;
    }
    .wizard-step.pending .wizard-step-text {
      color: #6c757d;
    }

    /* Estilos para el panel de administraci√≥n mejorado */
    .admin-dashboard-section {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid #333;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .admin-stat-card {
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .admin-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .admin-appointments-section {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid #333;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    /* Estilos para filtros avanzados */
    .filter-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      border: 1px solid #444;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .filter-card .card-header {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid #444;
    }

    .filter-stats-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      border: 1px solid #444;
      transition: all 0.3s ease;
    }

    .filter-stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    /* Estilos para acciones masivas */
    .bulk-actions-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      border: 1px solid #ffc107;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .bulk-actions-card .card-header {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid #444;
    }

    /* Estilos para la tabla mejorada */
    .table-dark {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .table-dark thead th {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border: none;
      color: white;
      font-weight: 600;
      padding: 15px 12px;
    }

    .table-dark tbody tr {
      transition: all 0.3s ease;
      border-bottom: 1px solid #444;
    }

    .table-dark tbody tr:hover {
      background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
      transform: scale(1.01);
    }

    .table-dark tbody td {
      padding: 12px;
      vertical-align: middle;
      border: none;
    }

    /* Estilos para checkboxes personalizados */
    .form-check-input {
      width: 18px;
      height: 18px;
      border: 2px solid #00d4ff;
      background-color: transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .form-check-input:checked {
      background-color: #00d4ff;
      border-color: #00d4ff;
    }

    .form-check-input:focus {
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25);
    }

    /* Estilos para botones de acci√≥n */
    .btn-group-sm .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      border-radius: 0.2rem;
      transition: all 0.3s ease;
    }

    .btn-group-sm .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Estilos para badges de estado */
    .badge {
      font-size: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Estilos para modales personalizados */
    .modal-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border: 1px solid #444;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      border-bottom: 1px solid #444;
      border-radius: 15px 15px 0 0;
    }

    .modal-footer {
      border-top: 1px solid #444;
      border-radius: 0 0 15px 15px;
    }

    /* Estilos para formularios en modo oscuro */
    .form-control, .form-select {
      background-color: #2a2a2a !important;
      border: 1px solid #444 !important;
      color: #fff !important;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      background-color: #3a3a3a !important;
      border-color: #00d4ff !important;
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25);
      color: #fff !important;
    }

    .form-control::placeholder {
      color: #888 !important;
    }

    /* Estilos para alertas personalizadas */
    .alert {
      border-radius: 10px;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .alert-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }

    .alert-success {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
      color: white;
    }

    .alert-warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .alert-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }

    /* Animaciones */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-dashboard-section,
      .admin-appointments-section {
        padding: 15px;
        margin-bottom: 20px;
      }

      .table-responsive {
        font-size: 0.875rem;
      }

      .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div id="header-container"></div>

  <div class="client-dashboard">
    <!-- Header del Dashboard -->
    <div class="dashboard-header" id="account-header">
      <h1><i class="fas fa-user-circle me-2"></i>Mi Cuenta</h1>
      <p>Gestiona tus turnos y tu informaci√≥n personal</p>
    </div>

    <!-- Alertas -->
    <div id="alert-container"></div>

    <!-- Estad√≠sticas del Usuario -->
    <div class="stats-grid" id="user-stats">
      <div class="stat-card active">
        <div class="stat-icon">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-number" id="activeAppointmentsCount">0</div>
        <div class="stat-label">Turnos Activos</div>
      </div>
      
      <div class="stat-card completed">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-number" id="completedAppointmentsCount">0</div>
        <div class="stat-label">Servicios Completados</div>
      </div>
      
      <div class="stat-card pending">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number" id="pendingAppointmentsCount">0</div>
        <div class="stat-label">Pendientes</div>
      </div>
      
      <div class="stat-card cancelled">
        <div class="stat-icon">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-number" id="cancelledAppointmentsCount">0</div>
        <div class="stat-label">Cancelados</div>
      </div>
    </div>

    <!-- Acci√≥n R√°pida -->
    <a href="turnos.html" class="quick-action">
      <i class="fas fa-calendar-plus"></i>
      Agendar Nuevo Turno
    </a>

    <!-- Informaci√≥n del usuario -->
    <div class="dashboard-section" id="user-info-card">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-user"></i>
          Informaci√≥n Personal
        </h3>
        <div class="section-actions">
          <button class="action-btn edit" onclick="toggleEditMode()" id="toggleEditBtn">
            <i class="fas fa-edit"></i>
            Editar
          </button>
          <button class="action-btn view" onclick="saveProfileChanges()" id="saveProfileBtn" style="display: none;">
            <i class="fas fa-save"></i>
            Guardar
          </button>
          <button class="action-btn cancel" onclick="cancelEditMode()" id="cancelEditBtn" style="display: none;">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
        </div>
      </div>
      <div class="user-details" id="userDetails">
        <div class="loading">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando informaci√≥n...
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Rese√±as -->
    <div class="dashboard-section" id="reviews-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-star"></i>
          Deja tu Rese√±a
        </h3>
        <div class="section-actions">
          <button class="action-btn view" onclick="loadUserReviews()">
            <i class="fas fa-sync-alt"></i>
            Refrescar
          </button>
        </div>
      </div>
      <div class="review-content">
        <div class="review-form-container">
          <h4 class="review-form-title">
            <i class="fas fa-comment-dots"></i>
            ¬øC√≥mo fue tu experiencia con nuestros servicios?
          </h4>
          <p class="review-form-subtitle">
            Tu opini√≥n nos ayuda a mejorar y es muy importante para nosotros.
          </p>
          
          <form id="reviewForm" class="review-form">
            <div class="rating-container">
              <label class="rating-label">Calificaci√≥n:</label>
              <div class="star-rating">
                <input type="radio" name="rating" value="5" id="star5">
                <label for="star5" class="star">‚òÖ</label>
                <input type="radio" name="rating" value="4" id="star4">
                <label for="star4" class="star">‚òÖ</label>
                <input type="radio" name="rating" value="3" id="star3">
                <label for="star3" class="star">‚òÖ</label>
                <input type="radio" name="rating" value="2" id="star2">
                <label for="star2" class="star">‚òÖ</label>
                <input type="radio" name="rating" value="1" id="star1">
                <label for="star1" class="star">‚òÖ</label>
              </div>
            </div>
            
            <div class="form-group">
              <label for="reviewTitle" class="form-label">
                <i class="fas fa-heading"></i>
                T√≠tulo de tu rese√±a
              </label>
              <input type="text" id="reviewTitle" class="form-control" placeholder="Ej: Excelente servicio de limpieza" maxlength="100">
            </div>
            
            <div class="form-group">
              <label for="reviewContent" class="form-label">
                <i class="fas fa-comment"></i>
                Tu opini√≥n
              </label>
              <textarea id="reviewContent" class="form-control" rows="4" placeholder="Cu√©ntanos sobre tu experiencia, qu√© te gust√≥, qu√© podr√≠amos mejorar..."></textarea>
            </div>
            
            <div class="form-group">
              <label for="reviewService" class="form-label">
                <i class="fas fa-tools"></i>
                Servicio evaluado (opcional)
              </label>
              <select id="reviewService" class="form-control">
                <option value="">Selecciona un servicio</option>
                <option value="vehiculos">Lavado de Veh√≠culos</option>
                <option value="tapizados">Limpieza de Tapizados</option>
                <option value="detailing">Detailing</option>
                <option value="general">Servicio General</option>
              </select>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="action-btn view">
                <i class="fas fa-paper-plane"></i>
                Enviar Rese√±a
              </button>
            </div>
          </form>
        </div>
        
        <div class="user-reviews-container">
          <h4 class="reviews-title">
            <i class="fas fa-history"></i>
            Mis Rese√±as Anteriores
          </h4>
          <div id="userReviewsList">
            <div class="loading">
              <i class="fas fa-spinner fa-spin me-2"></i>Cargando rese√±as...
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Turnos Activos -->
    <div class="dashboard-section" id="turnos-activos">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-calendar-check"></i>
          Turnos Activos
        </h3>
        <div class="section-actions">
          <button class="action-btn view" onclick="refreshAppointments()">
            <i class="fas fa-sync-alt"></i>
            Refrescar
          </button>
        </div>
      </div>
      <div id="activeAppointmentsList">
        <div class="loading">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando turnos activos...
        </div>
      </div>
    </div>

    <!-- Historial de servicios -->
    <div class="dashboard-section" id="appointments-history-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-history"></i>
          Historial de Servicios
        </h3>
        <div class="section-actions">
          <button class="action-btn view" onclick="refreshAppointments()">
            <i class="fas fa-sync-alt"></i>
            Refrescar
          </button>
        </div>
      </div>
      <div id="appointmentsHistoryList">
        <div class="loading">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando historial...
        </div>
      </div>
    </div>

    <!-- PANEL DE ADMINISTRACI√ìN (Solo visible para admins) -->
    <div id="adminPanel" style="display: none;">
      <!-- Dashboard Admin -->
      <div class="admin-dashboard-section">
        <h3><i class="fas fa-chart-line me-2" style="color:#00d4ff;"></i><span style="color:#00d4ff;">Dashboard de Administraci√≥n</span></h3>
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="admin-stat-card bg-primary text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="totalAppointments">0</h4>
                  <p class="mb-0">Total Turnos</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-calendar fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-success text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="pendingAppointments">0</h4>
                  <p class="mb-0">Pendientes</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-clock fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-info text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="todayAppointments">0</h4>
                  <p class="mb-0">Hoy</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-calendar-day fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-warning text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="totalRevenue">$0</h4>
                  <p class="mb-0">Ingresos</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-dollar-sign fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesti√≥n de Turnos Admin -->
      <div class="admin-appointments-section" id="gestion-turnos">
        <h3><i class="fas fa-list me-2" style="color:#00d4ff;"></i><span style="color:#00d4ff;">Gesti√≥n de Todos los Turnos</span></h3>
        
        <!-- Filtros Avanzados -->
        <div class="card bg-dark border-secondary mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros Avanzados</h5>
            </div>
          <div class="card-body">
            <div class="row">
              <!-- Filtro por Estado -->
              <div class="col-md-2 mb-3">
                <label class="form-label text-light">Estado:</label>
                <select class="form-select bg-dark text-light border-secondary" id="statusFilter">
                  <option value="all">Todos los estados</option>
                  <option value="pending">üïê Pendientes</option>
                  <option value="confirmed">‚úÖ Confirmados</option>
                  <option value="completed">üéØ Completados</option>
                  <option value="cancelled">‚ùå Cancelados</option>
                </select>
              </div>
              
              <!-- Filtro por Fecha -->
              <div class="col-md-2 mb-3">
                <label class="form-label text-light">Fecha desde:</label>
                <input type="date" class="form-control bg-dark text-light border-secondary" id="dateFromFilter">
              </div>
              
              <div class="col-md-2 mb-3">
                <label class="form-label text-light">Fecha hasta:</label>
                <input type="date" class="form-control bg-dark text-light border-secondary" id="dateToFilter">
              </div>
              
              <!-- Filtro por Servicio -->
              <div class="col-md-2 mb-3">
                <label class="form-label text-light">Servicio:</label>
                <select class="form-select bg-dark text-light border-secondary" id="serviceFilter">
                  <option value="all">Todos los servicios</option>
                  <option value="vehiculos">üöó Veh√≠culos</option>
                  <option value="tapizados">ü™ë Tapizados</option>
                  <option value="detailing">‚ú® Detailing</option>
                </select>
              </div>
              
              <!-- Filtro por Precio -->
              <div class="col-md-2 mb-3">
                <label class="form-label text-light">Precio m√≠nimo:</label>
                <input type="number" class="form-control bg-dark text-light border-secondary" id="priceMinFilter" placeholder="$0">
              </div>
              
              <div class="col-md-2 mb-3">
                <label class="form-label text-light">Precio m√°ximo:</label>
                <input type="number" class="form-control bg-dark text-light border-secondary" id="priceMaxFilter" placeholder="$999999">
              </div>
            </div>
            
            <!-- Segunda fila de filtros -->
            <div class="row">
              <!-- B√∫squeda por texto -->
              <div class="col-md-4 mb-3">
                <label class="form-label text-light">Buscar:</label>
                <input type="text" class="form-control bg-dark text-light border-secondary" id="searchInput" placeholder="Nombre, tel√©fono, ID...">
              </div>
              
              <!-- Filtro por Log√≠stica -->
              <div class="col-md-3 mb-3">
                <label class="form-label text-light">Log√≠stica:</label>
                <select class="form-select bg-dark text-light border-secondary" id="logisticsFilter">
                  <option value="all">Todas</option>
                  <option value="domicilio">üè† A domicilio</option>
                  <option value="retiro">üöö Con retiro</option>
                  <option value="cliente">üöó Cliente trae</option>
                </select>
              </div>
              
              <!-- Ordenar por -->
              <div class="col-md-3 mb-3">
                <label class="form-label text-light">Ordenar por:</label>
                <select class="form-select bg-dark text-light border-secondary" id="sortFilter">
                  <option value="date_desc">üìÖ Fecha (m√°s reciente)</option>
                  <option value="date_asc">üìÖ Fecha (m√°s antigua)</option>
                  <option value="price_desc">üí∞ Precio (mayor)</option>
                  <option value="price_asc">üí∞ Precio (menor)</option>
                  <option value="name_asc">üë§ Nombre (A-Z)</option>
                  <option value="name_desc">üë§ Nombre (Z-A)</option>
                </select>
              </div>
              
              <!-- Botones de acci√≥n -->
              <div class="col-md-2 mb-3 d-flex align-items-end">
                <div class="d-grid gap-2 w-100">
                  <button class="btn btn-primary" onclick="applyAdvancedFilters()">
                    <i class="fas fa-search me-1"></i>Aplicar
            </button>
                  <button class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Limpiar
            </button>
          </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estad√≠sticas de Filtros -->
        <div class="row mb-4" id="filterStats">
          <div class="col-md-3">
            <div class="card bg-dark border-info">
              <div class="card-body text-center">
                <h5 class="text-info" id="filteredCount">0</h5>
                <p class="mb-0 text-light">Turnos filtrados</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-dark border-warning">
              <div class="card-body text-center">
                <h5 class="text-warning" id="pendingCount">0</h5>
                <p class="mb-0 text-light">Pendientes</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-dark border-success">
              <div class="card-body text-center">
                <h5 class="text-success" id="confirmedCount">0</h5>
                <p class="mb-0 text-light">Confirmados</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-dark border-primary">
              <div class="card-body text-center">
                <h5 class="text-primary" id="totalRevenueFiltered">$0</h5>
                <p class="mb-0 text-light">Ingresos filtrados</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de Acci√≥n Masiva -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card bg-dark border-warning">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Acciones Masivas</h6>
              </div>
              <div class="card-body">
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-success" onclick="bulkConfirm()" id="bulkConfirmBtn" disabled>
                    <i class="fas fa-check me-1"></i>Confirmar Seleccionados
                  </button>
                  <button type="button" class="btn btn-outline-danger" onclick="bulkCancel()" id="bulkCancelBtn" disabled>
                    <i class="fas fa-times me-1"></i>Cancelar Seleccionados
                  </button>
                  <button type="button" class="btn btn-outline-info" onclick="bulkReminder()" id="bulkReminderBtn" disabled>
                    <i class="fas fa-bell me-1"></i>Recordatorio Masivo
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="exportFilteredAppointments()">
                    <i class="fas fa-download me-1"></i>Exportar Filtrados
                  </button>
                  <button type="button" class="btn btn-outline-warning" onclick="testNotifications()">
                    <i class="fas fa-bell me-1"></i>Probar Notificaciones
              </button>
                </div>
                <div class="mt-2">
                  <small class="text-light">
                    <i class="fas fa-info-circle me-1"></i>
                    Selecciona turnos para habilitar acciones masivas
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de turnos mejorada -->
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>
                  <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                </th>
                <th><i class="fas fa-hashtag me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">ID</span></th>
                <th><i class="fas fa-user me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Cliente</span></th>
                <th><i class="fas fa-calendar-alt me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Fecha</span></th>
                <th><i class="fas fa-clock me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Hora</span></th>
                <th><i class="fas fa-tools me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Servicios</span></th>
                <th><i class="fas fa-dollar-sign me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Total</span></th>
                <th><span style="display: flex; align-items: center;"><i class="fas fa-flag me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Estado</span></span></th>
                <th><i class="fas fa-cogs me-1" style="color:#adb5bd;"></i><span style="font-weight:bold;color:#fff;">Acciones</span></th>
              </tr>
            </thead>
            <tbody id="adminAppointmentsTableBody">
              <tr>
                <td colspan="9" class="text-center">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando turnos...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar turno -->
  <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editAppointmentModalLabel">
            <i class="fas fa-edit me-2"></i>Editar Turno
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="editAppointmentForm">
            <input type="hidden" id="editAppointmentId" />
            
            <!-- Informaci√≥n del turno actual -->
            <div class="alert alert-info mb-3">
              <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n del Turno</h6>
              <div id="editAppointmentInfo" class="small">
                <!-- Se llenar√° din√°micamente -->
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
            <div class="mb-3">
                  <label for="editAppointmentDate" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Fecha *
                  </label>
              <input type="date" class="form-control" id="editAppointmentDate" required />
            </div>
              </div>
              <div class="col-md-6">
            <div class="mb-3">
                  <label for="editAppointmentTime" class="form-label">
                    <i class="fas fa-clock me-1"></i>Hora *
                  </label>
                  <select class="form-control" id="editAppointmentTime" required>
                    <option value="">Selecciona una hora</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                  </select>
            </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editAppointmentAddress" class="form-label">
                <i class="fas fa-map-marker-alt me-1"></i>Direcci√≥n
              </label>
              <textarea class="form-control" id="editAppointmentAddress" rows="2" placeholder="Direcci√≥n donde se realizar√° el servicio"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="editAppointmentNotes" class="form-label">
                <i class="fas fa-sticky-note me-1"></i>Notas adicionales
              </label>
              <textarea class="form-control" id="editAppointmentNotes" rows="2" placeholder="Detalles adicionales, referencias, etc."></textarea>
            </div>
            
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n para cancelar -->
  <div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="cancelConfirmModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Cancelaci√≥n
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p><strong>¬øEst√°s seguro de que quieres cancelar este turno?</strong></p>
          <div id="cancelAppointmentInfo" class="alert alert-warning">
            <!-- Se llenar√° din√°micamente -->
          </div>
          <p class="text-muted small">
            <i class="fas fa-info-circle me-1"></i>
            Esta acci√≥n no se puede deshacer. El turno ser√° marcado como cancelado.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>No, mantener
          </button>
          <button type="button" class="btn btn-danger" id="confirmCancelBtn">
            <i class="fas fa-check me-1"></i>S√≠, cancelar turno
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar perfil -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editProfileModalLabel">
            <i class="fas fa-user-edit me-2"></i>Editar Perfil
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="editProfileForm">
            <!-- Informaci√≥n b√°sica -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfileName" class="form-label">
                    <i class="fas fa-user me-1"></i>Nombre completo
                  </label>
                  <input type="text" class="form-control" id="editProfileName" disabled />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfilePhone" class="form-label">
                    <i class="fas fa-phone me-1"></i>Tel√©fono *
                  </label>
                  <input type="tel" class="form-control" id="editProfilePhone" required />
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editProfileEmail" class="form-label">
                <i class="fas fa-envelope me-1"></i>Email *
              </label>
              <input type="email" class="form-control" id="editProfileEmail" required />
            </div>

            <hr class="my-4">

            <!-- Cambio de contrase√±a -->
            <h6 class="text-primary mb-3">
              <i class="fas fa-lock me-2"></i>Cambiar Contrase√±a
            </h6>
            <p class="text-muted small mb-3">
              <i class="fas fa-info-circle me-1"></i>
              Deja los campos de contrase√±a vac√≠os si no quieres cambiarla.
            </p>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfileCurrentPassword" class="form-label">
                    <i class="fas fa-key me-1"></i>Contrase√±a actual
                  </label>
                  <input type="password" class="form-control" id="editProfileCurrentPassword" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfileNewPassword" class="form-label">
                    <i class="fas fa-lock me-1"></i>Nueva contrase√±a
                  </label>
                  <input type="password" class="form-control" id="editProfileNewPassword" />
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editProfileConfirmPassword" class="form-label">
                <i class="fas fa-check-circle me-1"></i>Confirmar nueva contrase√±a
              </label>
              <input type="password" class="form-control" id="editProfileConfirmPassword" />
            </div>

            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer-container"></div>

  <!-- Bootstrap JS (para el modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Scripts para incluir header y footer -->
  <script src="js/config.js"></script>
  <script src="js/notifications.js"></script>

  <script src="js/include-header.js"></script>
  <script src="js/include-footer.js"></script>
  
  <script>
    let currentAppointments = [];

    function hideUserSectionsForAdmin() {
      const info = document.getElementById('user-info-card');
      const activos = document.getElementById('turnos-activos');
      const historial = document.getElementById('appointments-history-section');
      if (info) info.style.display = 'none';
      if (activos) activos.style.display = 'none';
      if (historial) historial.style.display = 'none';
    }
    function showUserSectionsForNormal() {
      const info = document.getElementById('user-info-card');
      const activos = document.getElementById('turnos-activos');
      const historial = document.getElementById('appointments-history-section');
      if (info) info.style.display = 'block';
      if (activos) activos.style.display = 'block';
      if (historial) historial.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Verificar autenticaci√≥n y cargar datos
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      
      // Cargar datos del usuario
      const apiUrl = window.getApiUrl ? window.getApiUrl() : 'https://daytona-clean-service.onrender.com/api';
      
      // Verificar autenticaci√≥n y cargar datos del usuario
      fetch(`${apiUrl}/users/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const user = data.user;
          const isAdmin = user.role === 'admin';
          localStorage.setItem('userData', JSON.stringify(user));
          if (isAdmin) {
            document.getElementById('adminPanel').style.display = 'block';
            hideUserSectionsForAdmin();
            // Ocultar encabezado solo para admin
            const header = document.getElementById('account-header');
            if (header) header.style.display = 'none';
            loadAdminFeatures();
          } else {
            document.getElementById('adminPanel').style.display = 'none';
            showUserSectionsForNormal();
            // Mostrar encabezado para usuario normal
            const header = document.getElementById('account-header');
            if (header) header.style.display = 'block';
            loadAppointments();
          }
        } else {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }
      })
      .catch(() => {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      });

      // Cargar turnos y separarlos en activos e historial
      function loadAppointments() {
        fetch(`${apiUrl}/appointments/user/appointments`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            currentAppointments = data.appointments;
            
            // Separar turnos activos (pending, confirmed) del historial (solo completed)
            const activeAppointments = data.appointments.filter(a => 
              a.status === 'pending' || a.status === 'confirmed'
            );
            const historyAppointments = data.appointments.filter(a => 
              a.status === 'completed'
            );
            
            displayActiveAppointments(activeAppointments);
            displayHistoryAppointments(historyAppointments);
            updateUserStats(data.appointments);
          } else {
            document.getElementById('activeAppointmentsList').innerHTML = '<div class="alert alert-warning">No tienes turnos activos.</div>';
            document.getElementById('appointmentsHistoryList').innerHTML = '<div class="alert alert-warning">No tienes servicios completados en tu historial.</div>';
          }
        })
        .catch(() => {
          document.getElementById('activeAppointmentsList').innerHTML = '<div class="alert alert-danger">Error cargando turnos activos.</div>';
                      document.getElementById('appointmentsHistoryList').innerHTML = '<div class="alert alert-danger">Error cargando historial de servicios.</div>';
        });
      }

      // Mostrar turnos activos
      function displayActiveAppointments(appointments) {
        const activeList = document.getElementById('activeAppointmentsList');
        if (!appointments.length) {
          activeList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-calendar-times"></i>
              <h3>No tienes turnos activos</h3>
              <p>No tienes turnos pendientes o confirmados en este momento.</p>
              <a href="turnos.html" class="quick-action">
                <i class="fas fa-calendar-plus"></i>
                Agendar Nuevo Turno
              </a>
            </div>`;
          return;
        }
        
        activeList.innerHTML = appointments.map(appointment => {
          // Formatear servicios si existen
          let serviciosInfo = '';
          if (appointment.services && appointment.services.length > 0) {
            serviciosInfo = appointment.services.map(s => {
              const nombreServicio = s.nombre || s.name || s.service_name || '';
              const cantidad = s.cantidad || s.quantity || 1;
              if (!nombreServicio) return '';
              return `${nombreServicio}${cantidad > 1 ? ' x'+cantidad : ''}`;
            }).filter(Boolean).join(', ');
          } else {
            serviciosInfo = appointment.service_type || 'No especificado';
          }

          // Formatear direcci√≥n/log√≠stica mejorada
          let direccionHtml = '';
          const dir = appointment.serviceLocation || appointment.service_location || appointment.address || '';
          if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
            const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
            if (match) {
              direccionHtml = `<div class="detail-item"><i class="fas fa-map-marker-alt"></i><strong>Retiro:</strong> ${match[1].trim()}</div><div class="detail-item"><i class="fas fa-location-arrow"></i><strong>Entrega:</strong> ${match[2].trim()}</div>`;
            } else {
              direccionHtml = `<div class="detail-item"><i class="fas fa-map-marker-alt"></i><strong>Direcci√≥n:</strong> ${dir}</div>`;
            }
          } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
            direccionHtml = '<div class="detail-item"><i class="fas fa-car"></i><strong>Log√≠stica:</strong> El cliente lleva el veh√≠culo</div>';
          } else if (dir && dir.trim() && dir !== 'A confirmar') {
            direccionHtml = `<div class="detail-item"><i class="fas fa-map-marker-alt"></i><strong>Direcci√≥n:</strong> ${dir}</div>`;
          } else {
            direccionHtml = '<div class="detail-item" style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i><strong>Error:</strong> Direcci√≥n no especificada</div>';
          }

          // Formatear total
          let total = 'A confirmar';
          if (appointment.totalAmount || appointment.total_amount || appointment.total_price) {
            const t = appointment.totalAmount || appointment.total_amount || appointment.total_price;
            total = `$${parseInt(t).toLocaleString('es-AR')}`;
          } else if (appointment.services && appointment.services.length > 0) {
            const suma = appointment.services.reduce((acc, s) => acc + (parseInt(s.precio || s.price || 0) * (parseInt(s.cantidad || s.quantity || 1))), 0);
            if (suma > 0) total = `$${suma.toLocaleString('es-AR')}`;
          }

          return `
            <div class="appointment-card ${appointment.status}">
              <div class="appointment-header">
                <div class="appointment-info">
                  <div class="appointment-date">
                    <i class="fas fa-calendar-alt"></i>
                    ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}
                  </div>
                  <div class="appointment-time">
                    <i class="fas fa-clock"></i>
                    ${appointment.appointment_time || appointment.start_time || 'No especificada'}
                  </div>
                </div>
                <div class="appointment-status ${appointment.status}">
                  ${getStatusText(appointment.status)}
                </div>
              </div>
              
              <div class="appointment-details">
                <div class="detail-item">
                  <i class="fas fa-tools"></i>
                  <strong>Servicios:</strong> ${serviciosInfo}
                </div>
                <div class="detail-item">
                  <i class="fas fa-dollar-sign"></i>
                  <strong>Total:</strong> ${total}
                </div>
                ${direccionHtml}
              </div>
              
              <div class="appointment-actions">
                ${appointment.status === 'pending' || appointment.status === 'confirmed' ? `
                  <button class="action-btn edit" onclick="openEditModal(${appointment.id})" title="Editar turno">
                    <i class="fas fa-edit"></i>
                    Editar
                  </button>
                  <button class="action-btn cancel" onclick="cancelAppointment(${appointment.id})" title="Cancelar turno">
                    <i class="fas fa-times"></i>
                    Cancelar
                  </button>
                ` : appointment.status === 'cancelled' ? `
                  <span class="appointment-status cancelled">
                    <i class="fas fa-ban"></i>
                    Cancelado
                  </span>
                ` : appointment.status === 'completed' ? `
                  <span class="appointment-status confirmed">
                    <i class="fas fa-check"></i>
                    Completado
                  </span>
                ` : `
                  <span class="appointment-status">
                    <i class="fas fa-question"></i>
                    ${appointment.status}
                  </span>
                `}
              </div>
            </div>
          `;
        }).join('');
      }

      // Mostrar historial de turnos
      function displayHistoryAppointments(appointments) {
        const historyList = document.getElementById('appointmentsHistoryList');
        if (!appointments.length) {
          historyList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-history"></i>
              <h3>No hay historial de servicios</h3>
              <p>A√∫n no tienes servicios completados en tu historial.</p>
              <a href="turnos.html" class="quick-action">
                <i class="fas fa-calendar-plus"></i>
                Agendar Nuevo Turno
              </a>
            </div>`;
          return;
        }
        
        // Ordenar por fecha (m√°s reciente primero)
        const sortedAppointments = appointments.sort((a, b) => 
          new Date(b.appointment_date) - new Date(a.appointment_date)
        );
        
        historyList.innerHTML = sortedAppointments.map(appointment => {
          // Formatear servicios si existen
          let serviciosInfo = '';
          if (appointment.services && appointment.services.length > 0) {
            serviciosInfo = appointment.services.map(s => {
              const nombreServicio = s.nombre || s.name || s.service_name || 'Sin nombre';
              const cantidad = s.cantidad || s.quantity || 1;
              const precio = s.precio || s.price || '';
              return `${nombreServicio} x${cantidad}${precio ? ` ($${parseInt(precio).toLocaleString('es-AR')})` : ''}`;
            }).join(', ');
          } else {
            serviciosInfo = appointment.service_type || 'No especificado';
          }

          // Formatear direcci√≥n (buscar en notes, serviceLocation o address)
          let direccion = 'A confirmar';
          if (appointment.serviceLocation) {
            direccion = appointment.serviceLocation;
          } else if (appointment.address) {
            direccion = appointment.address;
          } else if (appointment.notes && appointment.notes.includes('Retiro:')) {
            direccion = appointment.notes;
          } else if (appointment.notes && appointment.notes.length > 0) {
            direccion = appointment.notes;
          }

          // Formatear total
          let total = 'A confirmar';
          if (appointment.totalAmount || appointment.total_amount || appointment.total_price) {
            const t = appointment.totalAmount || appointment.total_amount || appointment.total_price;
            total = `$${parseInt(t).toLocaleString('es-AR')}`;
          } else if (appointment.services && appointment.services.length > 0) {
            const suma = appointment.services.reduce((acc, s) => acc + (parseInt(s.precio || s.price || 0) * (parseInt(s.cantidad || s.quantity || 1))), 0);
            if (suma > 0) total = `$${suma.toLocaleString('es-AR')}`;
          }

          return `
            <div class="appointment-card completed">
              <div class="appointment-header">
                <div class="appointment-info">
                  <div class="appointment-date">
                    <i class="fas fa-calendar-alt"></i>
                    ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}
                  </div>
                  <div class="appointment-time">
                    <i class="fas fa-clock"></i>
                    ${appointment.appointment_time || appointment.start_time || 'No especificada'}
                  </div>
                </div>
                <div class="appointment-status confirmed">
                  <i class="fas fa-check"></i>
                  Completado
                </div>
              </div>
              
              <div class="appointment-details">
                <div class="detail-item">
                  <i class="fas fa-tools"></i>
                  <strong>Servicios:</strong> ${serviciosInfo}
                </div>
                <div class="detail-item">
                  <i class="fas fa-dollar-sign"></i>
                  <strong>Total:</strong> ${total}
                </div>
                <div class="detail-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <strong>Direcci√≥n:</strong> ${direccion}
                </div>
              </div>
              
              <div class="appointment-actions">
                <span class="appointment-status confirmed">
                  <i class="fas fa-check"></i>
                  Servicio Realizado
                </span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Funci√≥n para obtener el color del badge seg√∫n el estado
      function getStatusBadge(status) {
        switch(status) {
          case 'pending': return 'warning';
          case 'confirmed': return 'success';
          case 'completed': return 'info';
          case 'cancelled': return 'danger';
          default: return 'secondary';
        }
      }

      // Funci√≥n para obtener el texto del estado
      function getStatusText(status) {
        switch(status) {
          case 'pending': return 'Pendiente';
          case 'confirmed': return 'Confirmado';
          case 'completed': return 'Completado';
          case 'cancelled': return 'Cancelado';
          default: return status;
        }
      }

      // Abrir modal de edici√≥n
      window.openEditModal = function(appointmentId) {
        const appointment = currentAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('Turno no encontrado', 'danger');
          return;
        }
        
        // Verificar si el turno se puede editar
        if (appointment.status === 'cancelled' || appointment.status === 'completed') {
          showAlert('No se puede editar un turno cancelado o completado', 'warning');
          return;
        }
        
        // Llenar informaci√≥n del turno
        document.getElementById('editAppointmentId').value = appointment.id;
        document.getElementById('editAppointmentDate').value = appointment.appointment_date.split('T')[0];
        document.getElementById('editAppointmentTime').value = appointment.start_time || '';
        document.getElementById('editAppointmentAddress').value = appointment.service_location || '';
        document.getElementById('editAppointmentNotes').value = appointment.notes || '';
        
        // Mostrar informaci√≥n del turno actual
        // --- Servicios ---
        let serviciosInfo = '';
        if (appointment.services && appointment.services.length > 0) {
          serviciosInfo = appointment.services.map(s => {
            const nombreServicio = s.nombre || s.name || s.service_name || '';
            const cantidad = s.cantidad || s.quantity || 1;
            if (!nombreServicio) return '';
            return `${nombreServicio}${cantidad > 1 ? ' x'+cantidad : ''}`;
          }).filter(Boolean).join(', ');
        } else {
          serviciosInfo = appointment.service_type || 'No especificado';
        }

        // --- Direcci√≥n / Log√≠stica ---
        let direccionHtml = '';
        const dir = appointment.serviceLocation || appointment.service_location || appointment.address || '';
        if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
          const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
          if (match) {
            direccionHtml = `<strong>Retiro:</strong> ${match[1].trim()}<br><strong>Entrega:</strong> ${match[2].trim()}`;
          } else {
            direccionHtml = `<strong>Direcci√≥n:</strong> ${dir}`;
          }
        } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
          direccionHtml = '<strong>Log√≠stica:</strong> El cliente lleva el veh√≠culo';
        } else if (dir && dir.trim() && dir !== 'A confirmar') {
          direccionHtml = `<strong>Direcci√≥n:</strong> ${dir}`;
        } else {
          direccionHtml = '<span style="color: red;">¬°Error! Direcci√≥n no especificada</span>';
        }

        // --- Total y hora ---
        let total = 'A confirmar';
        if (appointment.totalAmount || appointment.total_amount || appointment.total_price) {
          const t = appointment.totalAmount || appointment.total_amount || appointment.total_price;
          total = `$${parseInt(t).toLocaleString('es-AR')}`;
        }
        const hora = appointment.appointment_time || appointment.start_time || 'No especificada';

        document.getElementById('editAppointmentInfo').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <strong>Servicios:</strong> ${serviciosInfo}<br>
              <strong>Total:</strong> ${total}<br>
              <strong>Estado:</strong> <span class="badge bg-${getStatusBadge(appointment.status)}">${getStatusText(appointment.status)}</span>
            </div>
            <div class="col-md-6">
              <strong>Fecha actual:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}<br>
              <strong>Hora actual:</strong> ${hora}<br>
              ${direccionHtml}
            </div>
          </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
        modal.show();
      };

      // Guardar cambios de edici√≥n
      document.getElementById('editAppointmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const id = document.getElementById('editAppointmentId').value;
        const date = document.getElementById('editAppointmentDate').value;
        const time = document.getElementById('editAppointmentTime').value;
        const address = document.getElementById('editAppointmentAddress').value;
        const notes = document.getElementById('editAppointmentNotes').value;
        
        // Validaciones
        if (!date || !time) {
          showAlert('Fecha y hora son requeridas', 'danger');
          return;
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
        submitBtn.disabled = true;
        
        fetch(`https://daytona-clean-service.onrender.com/api/appointments/users/appointments/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            appointment_date: date,
            start_time: time,
            service_location: address,
            notes: notes
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Turno actualizado exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
            modal.hide();
            loadAppointments();
          } else {
            showAlert('Error actualizando turno: ' + (data.message || ''), 'danger');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al actualizar turno', 'danger');
        })
        .finally(() => {
          // Restaurar bot√≥n
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Cancelar turno
      window.cancelAppointment = function(appointmentId) {
        const appointment = currentAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('Turno no encontrado', 'danger');
          return;
        }
        
        // Verificar si el turno se puede cancelar
        if (appointment.status === 'cancelled') {
          showAlert('Este turno ya est√° cancelado', 'warning');
          return;
        }
        
        if (appointment.status === 'completed') {
          showAlert('No se puede cancelar un turno completado', 'warning');
          return;
        }
        
        // Mostrar informaci√≥n del turno a cancelar
        const servicesInfo = appointment.services && appointment.services.length > 0 
          ? appointment.services.map(s => `${s.service_name} x${s.quantity}`).join(', ')
          : 'No especificado';
        
        document.getElementById('cancelAppointmentInfo').innerHTML = `
          <div class="mb-2">
            <strong>Fecha:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}<br>
            <strong>Hora:</strong> ${appointment.start_time || 'No especificada'}<br>
            <strong>Servicios:</strong> ${servicesInfo}<br>
            <strong>Total:</strong> $${parseInt(appointment.total_amount || 0).toLocaleString('es-AR')}
          </div>
        `;
        
        // Configurar el bot√≥n de confirmaci√≥n
        const confirmBtn = document.getElementById('confirmCancelBtn');
        confirmBtn.onclick = function() {
          // Mostrar loading
          const originalText = confirmBtn.innerHTML;
          confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cancelando...';
          confirmBtn.disabled = true;
          
          fetch(`https://daytona-clean-service.onrender.com/api/appointments/users/appointments/${appointmentId}/cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Turno cancelado exitosamente', 'success');
              const modal = bootstrap.Modal.getInstance(document.getElementById('cancelConfirmModal'));
              modal.hide();
            loadAppointments();
          } else {
            showAlert('Error cancelando turno: ' + (data.message || ''), 'danger');
          }
        })
          .catch((error) => {
            console.error('Error:', error);
            showAlert('Error de conexi√≥n al cancelar turno', 'danger');
          })
          .finally(() => {
            // Restaurar bot√≥n
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
          });
        };
        
        // Mostrar modal de confirmaci√≥n
        const modal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
        modal.show();
      };

      // Funci√≥n para mostrar alertas
      function showAlert(message, type, duration = 5000, isHtml = false) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        if (isHtml) {
          alertDiv.innerHTML = message;
        } else {
          alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
        }
        alertContainer.appendChild(alertDiv);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, duration);
      }
      
      // Funci√≥n para refrescar la lista de turnos
      window.refreshAppointments = function() {
        console.log('üîÑ Refrescando lista de turnos...');
        showAlert('<i class="fas fa-spinner fa-spin me-2"></i>Refrescando datos...', 'info');
        loadAppointments();
      };
      
      // Funci√≥n para scroll suave a secciones
      function smoothScrollTo(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
          
          // Agregar efecto de highlight si es la secci√≥n de turnos activos
          if (elementId === 'turnos-activos') {
            element.classList.add('highlight');
            setTimeout(() => {
              element.classList.remove('highlight');
            }, 2000);
          }
        }
      }

      // Manejar enlaces internos con hash
      document.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' && e.target.getAttribute('href') && e.target.getAttribute('href').startsWith('#')) {
          e.preventDefault();
          const targetId = e.target.getAttribute('href').substring(1);
          smoothScrollTo(targetId);
        }
      });

      // Si hay un hash en la URL al cargar la p√°gina, hacer scroll
      if (window.location.hash) {
        setTimeout(() => {
          const targetId = window.location.hash.substring(1);
          smoothScrollTo(targetId);
        }, 500);
      }

      // Agregar botones de refrescar al DOM
      document.addEventListener('DOMContentLoaded', function() {
        // Bot√≥n para turnos activos
        const activeSection = document.querySelector('.active-appointments-section');
        if (activeSection) {
          const refreshActiveBtn = document.createElement('button');
          refreshActiveBtn.className = 'btn btn-outline-primary btn-sm ms-2';
          refreshActiveBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refrescar';
          refreshActiveBtn.onclick = refreshAppointments;
          
          const activeTitle = activeSection.querySelector('h3');
          if (activeTitle) {
            activeTitle.appendChild(refreshActiveBtn);
          }
        }

        // Bot√≥n para historial
        const historySection = document.querySelector('.appointments-history-section');
        if (historySection) {
          const refreshHistoryBtn = document.createElement('button');
          refreshHistoryBtn.className = 'btn btn-outline-secondary btn-sm ms-2';
          refreshHistoryBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refrescar';
          refreshHistoryBtn.onclick = refreshAppointments;
          
          const historyTitle = historySection.querySelector('h3');
          if (historyTitle) {
            historyTitle.appendChild(refreshHistoryBtn);
          }
        }
      });

      // ===== FUNCIONES DEL PANEL DE ADMINISTRACI√ìN =====
      
      // Cargar funcionalidades de admin
      function loadAdminFeatures() {
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminStats();
        loadAllAppointments();
      }

      // Cargar estad√≠sticas del dashboard
      function loadAdminStats() {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            const appointments = data.appointments;
            
            // Calcular estad√≠sticas
            const total = appointments.length;
            const pending = appointments.filter(a => a.status === 'pending').length;
            const today = appointments.filter(a => {
              const today = new Date().toISOString().split('T')[0];
              return a.appointment_date === today;
            }).length;
            const revenue = appointments
              .filter(a => a.status === 'confirmed' || a.status === 'completed')
              .reduce((sum, a) => sum + parseFloat(a.total_amount || 0), 0);

            // Actualizar UI
            document.getElementById('totalAppointments').textContent = total;
            document.getElementById('pendingAppointments').textContent = pending;
            document.getElementById('todayAppointments').textContent = today;
            document.getElementById('totalRevenue').textContent = `$${revenue.toLocaleString()}`;
          }
        })
        .catch(error => {
          console.error('Error cargando estad√≠sticas:', error);
        });
      }

      // Cargar todos los turnos para admin
      function loadAllAppointments() {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            window.lastAdminAppointments = data.appointments; // Guardar para usar en el modal
            displayAdminAppointments(data.appointments);
          } else {
            document.getElementById('adminAppointmentsTableBody').innerHTML = 
              '<tr><td colspan="8" class="text-center">No se encontraron turnos</td></tr>';
          }
        })
        .catch(error => {
          console.error('Error cargando turnos:', error);
          document.getElementById('adminAppointmentsTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center text-danger">Error cargando turnos</td></tr>';
        });
      }

      // Mostrar turnos en tabla de admin
      function displayAdminAppointments(appointments) {
        const tbody = document.getElementById('adminAppointmentsTableBody');
        
        if (!appointments.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron turnos</td></tr>';
          return;
        }

        tbody.innerHTML = appointments.map(appointment => {
          // Mostrar detalles de servicios
          const servicesInfo = appointment.services && appointment.services.length > 0 
            ? appointment.services.map(s => {
                const nombre = s.nombre || s.name || s.service_name || 'Sin nombre';
                const tipo = s.tipo || s.type || '';
                const cantidad = s.cantidad || s.quantity || 1;
                return `${nombre}${tipo ? ' ('+tipo+')' : ''} x${cantidad}`;
              }).join('<br>')
            : appointment.service_type || 'No especificado';

          const total = appointment.total_amount || appointment.totalAmount || appointment.total_price
            ? `$${parseInt(appointment.total_amount || appointment.totalAmount || appointment.total_price).toLocaleString('es-AR')}`
            : 'A confirmar';

          // L√≥gica de direcci√≥n/log√≠stica profesional con iconos y color unificado
          let direccionHtml = '';
          const dir = appointment.service_location || appointment.serviceLocation || '';
          if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
            const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
            if (match) {
              direccionHtml = `
                <div><i class='fas fa-map-marker-alt me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Retiro:</span> <span style='font-weight:normal;color:#fff;'>${match[1].trim()}</span></div>
                <div><i class='fas fa-location-arrow me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Entrega:</span> <span style='font-weight:normal;color:#fff;'>${match[2].trim()}</span></div>
              `;
            } else {
              direccionHtml = `<div><i class='fas fa-map-marker-alt me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
            }
          } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
            direccionHtml = `<div><i class='fas fa-car me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Log√≠stica:</span> <span style='font-weight:normal;color:#fff;'>El cliente lleva el veh√≠culo a la instalaci√≥n</span></div>`;
          } else if (dir && dir.trim() && dir !== 'A confirmar') {
            direccionHtml = `<div><i class='fas fa-map-marker-alt me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
          } else {
            direccionHtml = `<div style='color: red; font-weight: bold;'>¬°Error! Direcci√≥n obligatoria no especificada. Contactar al administrador.</div>`;
          }

          return `
            <tr>
              <td><i class='fas fa-hashtag me-1' style='color:#00d4ff;'></i>#${appointment.id}</td>
              <td>
                <div style="margin-bottom: 6px;"><i class='fas fa-user me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Nombre:</span> <span style='font-weight:normal;color:#fff;'>${appointment.client_name || 'N/A'}</span></div>
                <div><i class='fas fa-phone me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Celular:</span> <span style='font-weight:normal;color:#fff;'>${appointment.client_phone || 'N/A'}</span></div>
                <div><i class='fas fa-envelope me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Mail:</span> <span style='font-weight:normal;color:#fff;'>${appointment.client_email || ''}</span></div>
                ${direccionHtml}
              </td>
              <td>${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}</td>
              <td>${appointment.start_time || appointment.appointment_time || 'N/A'}</td>
              <td>${servicesInfo}</td>
              <td>${total}</td>
              <td>
                <span class="badge bg-${getStatusBadge(appointment.status)}">
                  ${getStatusText(appointment.status)}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <i class="fas fa-cogs me-1" style="color:#adb5bd;"></i>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewAdminAppointment(${appointment.id})" title="Ver detalles">
                      <i class="fas fa-eye" style="color:#adb5bd;"></i>
                    </button>
                    ${appointment.status === 'pending' ? `
                      <button class="btn btn-outline-success" onclick="confirmAdminAppointment(${appointment.id})" title="Confirmar">
                        <i class="fas fa-check" style="color:#adb5bd;"></i>
                      </button>
                    ` : ''}
                    ${appointment.status === 'confirmed' ? `
                      <button class="btn btn-outline-info" onclick="sendReminderAdmin(${appointment.id})" title="Enviar Recordatorio">
                        <i class="fas fa-bell" style="color:#adb5bd;"></i>
                      </button>
                    ` : ''}
                    ${appointment.status !== 'cancelled' && appointment.status !== 'completed' ? `
                      <button class="btn btn-outline-danger" onclick="cancelAdminAppointment(${appointment.id})" title="Cancelar">
                        <i class="fas fa-times" style="color:#adb5bd;"></i>
                      </button>
                    ` : ''}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Filtrar turnos de admin
      window.filterAdminAppointments = function(filter) {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            let filteredAppointments = data.appointments;
            
            if (filter !== 'all') {
              filteredAppointments = data.appointments.filter(a => a.status === filter);
            }
            
            displayAdminAppointments(filteredAppointments);
          }
        })
        .catch(error => {
          console.error('Error filtrando turnos:', error);
        });
      };

      // Buscar turnos de admin
      window.searchAdminAppointments = function() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            const filteredAppointments = data.appointments.filter(appointment => 
              appointment.client_name?.toLowerCase().includes(searchTerm) ||
              appointment.client_phone?.includes(searchTerm) ||
              appointment.id.toString().includes(searchTerm)
            );
            
            displayAdminAppointments(filteredAppointments);
          }
        })
        .catch(error => {
          console.error('Error buscando turnos:', error);
        });
      };

      // Ver detalles de turno (admin)
      window.viewAdminAppointment = function(appointmentId) {
        const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('No se encontr√≥ el turno', 'danger');
          return;
        }
        const servicesInfo = appointment.services && appointment.services.length > 0 
          ? appointment.services.map(s => {
              const nombre = s.nombre || s.name || s.service_name || 'Sin nombre';
              const tipo = s.tipo || s.type || '';
              const cantidad = s.cantidad || s.quantity || 1;
              const precio = s.precio || s.price || '';
              return `${nombre}${tipo ? ' ('+tipo+')' : ''} x${cantidad}${precio ? ` ($${parseInt(precio).toLocaleString('es-AR')})` : ''}`;
            }).join('<br>')
          : appointment.service_type || 'No especificado';

        // L√≥gica para mostrar direcci√≥n/retira/entrega profesional
        let direccionHtml = '';
        const dir = appointment.service_location || appointment.serviceLocation || '';
        if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
          const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
          if (match) {
            direccionHtml = `
              <div><i class='fas fa-map-marker-alt me-1'></i><span style='font-weight:bold;color:#fff;'>Retiro:</span> <span style='font-weight:normal;color:#fff;'>${match[1].trim()}</span></div>
              <div><i class='fas fa-location-arrow me-1'></i><span style='font-weight:bold;color:#fff;'>Entrega:</span> <span style='font-weight:normal;color:#fff;'>${match[2].trim()}</span></div>
            `;
          } else {
            direccionHtml = `<div><i class='fas fa-map-marker-alt me-1'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
          }
        } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
          direccionHtml = `<div><i class='fas fa-car me-1'></i><span style='font-weight:bold;color:#fff;'>Log√≠stica:</span> <span style='font-weight:normal;color:#fff;'>El cliente lleva el veh√≠culo a la instalaci√≥n</span></div>`;
        } else if (dir && dir.trim() && dir !== 'A confirmar') {
          direccionHtml = `<div><i class='fas fa-map-marker-alt me-1'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
        } else {
          direccionHtml = `<div style='color: red; font-weight: bold;'>¬°Error! Direcci√≥n obligatoria no especificada. Contactar al administrador.</div>`;
        }

        const total = appointment.total_amount || appointment.totalAmount || appointment.total_price
          ? `$${parseInt(appointment.total_amount || appointment.totalAmount || appointment.total_price).toLocaleString('es-AR')}`
          : 'A confirmar';

        const html = `
          <div class="mb-2"><strong>ID:</strong> #${appointment.id}</div>
          <div class="mb-2"><strong>Cliente:</strong> ${appointment.client_name || 'N/A'}<br>
            <small style="color: #fff;">Celular: ${appointment.client_phone || 'N/A'}</small><br>
            <small style="color: #fff;">Mail: ${appointment.client_email || ''}</small><br>
            ${direccionHtml}
          </div>
          <div class="mb-2"><strong>Fecha:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}</div>
          <div class="mb-2"><strong>Hora:</strong> ${appointment.start_time || appointment.appointment_time || 'N/A'}</div>
          <div class="mb-2"><strong>Servicios:</strong><br>${servicesInfo}</div>
          <div class="mb-2"><strong>Total:</strong> ${total}</div>
          <div class="mb-2"><strong>Estado:</strong> <span class="badge bg-${getStatusBadge(appointment.status)}">${getStatusText(appointment.status)}</span></div>
        `;
        showAlert(html, 'info', 0, true);
      };

      // Confirmar turno (admin)
      window.confirmAdminAppointment = function(appointmentId) {
        const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('No se encontr√≥ el turno', 'danger');
          return;
        }

        // Crear modal de confirmaci√≥n profesional
        const modalHtml = `
          <div class="modal fade" id="confirmAppointmentModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content bg-dark text-light">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Confirmar Turno
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6><i class="fas fa-user me-2"></i>Informaci√≥n del Cliente</h6>
                      <p><strong>Nombre:</strong> ${appointment.client_name || 'N/A'}</p>
                      <p><strong>Tel√©fono:</strong> ${appointment.client_phone || 'N/A'}</p>
                      <p><strong>Email:</strong> ${appointment.client_email || 'No especificado'}</p>
                    </div>
                    <div class="col-md-6">
                      <h6><i class="fas fa-calendar me-2"></i>Detalles del Turno</h6>
                      <p><strong>Fecha:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}</p>
                      <p><strong>Hora:</strong> ${appointment.start_time || appointment.appointment_time || 'N/A'}</p>
                      <p><strong>Total:</strong> $${parseInt(appointment.total_amount || appointment.totalAmount || appointment.total_price || 0).toLocaleString('es-AR')}</p>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-12">
                      <h6><i class="fas fa-tools me-2"></i>Servicios</h6>
                      <div class="alert alert-info">
                        ${appointment.services && appointment.services.length > 0 
                          ? appointment.services.map(s => {
                              const nombre = s.nombre || s.name || s.service_name || 'Sin nombre';
                              const cantidad = s.cantidad || s.quantity || 1;
                              return `<div>‚Ä¢ ${nombre} x${cantidad}</div>`;
                            }).join('')
                          : appointment.service_type || 'No especificado'
                        }
                      </div>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-12">
                      <h6><i class="fas fa-map-marker-alt me-2"></i>Direcci√≥n/Log√≠stica</h6>
                      <div class="alert alert-warning">
                        ${appointment.service_location || appointment.serviceLocation || 'No especificada'}
                      </div>
                    </div>
                  </div>
                  <div class="alert alert-success">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Al confirmar este turno:</strong>
                    <ul class="mb-0 mt-2">
                      <li>Se enviar√° una notificaci√≥n autom√°tica al cliente por WhatsApp</li>
                      <li>El estado cambiar√° a "Confirmado"</li>
                      <li>Se registrar√° la acci√≥n en el sistema</li>
                    </ul>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                  </button>
                  <button type="button" class="btn btn-success" onclick="executeConfirmAppointment(${appointmentId})">
                    <i class="fas fa-check me-2"></i>Confirmar Turno
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        // Remover modal anterior si existe
        const existingModal = document.getElementById('confirmAppointmentModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Agregar modal al DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('confirmAppointmentModal'));
        modal.show();
      };

      // Ejecutar confirmaci√≥n de turno
      window.executeConfirmAppointment = function(appointmentId) {
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmAppointmentModal'));
        modal.hide();

        // Mostrar loading
        showAlert('<i class="fas fa-spinner fa-spin me-2"></i>Confirmando turno...', 'info');

          fetch(`https://daytona-clean-service.onrender.com/api/appointments/admin/${appointmentId}/status`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'confirmed' })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
            showAlert('‚úÖ Turno confirmado exitosamente. Se envi√≥ notificaci√≥n al cliente.', 'success');
              
              // Mostrar notificaci√≥n web si est√° disponible
              if (window.showAppointmentConfirmation) {
                const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
                if (appointment) {
                  window.showAppointmentConfirmation(appointment);
                }
              }
              
              loadAllAppointments();
              loadAdminStats();
            } else {
            showAlert('‚ùå Error confirmando turno: ' + (data.message || ''), 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
          showAlert('‚ùå Error de conexi√≥n al confirmar turno', 'danger');
          });
      };

      // Cancelar turno (admin)
      window.cancelAdminAppointment = function(appointmentId) {
        const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('No se encontr√≥ el turno', 'danger');
          return;
        }

        // Crear modal de cancelaci√≥n profesional
        const modalHtml = `
          <div class="modal fade" id="cancelAppointmentModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content bg-dark text-light">
                <div class="modal-header bg-danger text-white">
                  <h5 class="modal-title">
                    <i class="fas fa-times-circle me-2"></i>Cancelar Turno
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¬øEst√°s seguro de que quieres cancelar este turno?</strong>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <h6><i class="fas fa-user me-2"></i>Cliente</h6>
                      <p><strong>Nombre:</strong> ${appointment.client_name || 'N/A'}</p>
                      <p><strong>Tel√©fono:</strong> ${appointment.client_phone || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                      <h6><i class="fas fa-calendar me-2"></i>Turno</h6>
                      <p><strong>Fecha:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}</p>
                      <p><strong>Hora:</strong> ${appointment.start_time || appointment.appointment_time || 'N/A'}</p>
                    </div>
                  </div>
                  <div class="form-group mt-3">
                    <label for="cancelReason" class="form-label">Motivo de cancelaci√≥n (opcional):</label>
                    <textarea class="form-control bg-dark text-light border-secondary" id="cancelReason" rows="3" placeholder="Ej: Cliente solicit√≥ reprogramar, horario no disponible..."></textarea>
                  </div>
                  <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Al cancelar este turno:</strong>
                    <ul class="mb-0 mt-2">
                      <li>Se enviar√° una notificaci√≥n autom√°tica al cliente por WhatsApp</li>
                      <li>El estado cambiar√° a "Cancelado"</li>
                      <li>Se registrar√° la acci√≥n en el sistema</li>
                    </ul>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                  </button>
                  <button type="button" class="btn btn-danger" onclick="executeCancelAppointment(${appointmentId})">
                    <i class="fas fa-times me-2"></i>Cancelar Turno
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        // Remover modal anterior si existe
        const existingModal = document.getElementById('cancelAppointmentModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Agregar modal al DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('cancelAppointmentModal'));
        modal.show();
      };

      // Ejecutar cancelaci√≥n de turno
      window.executeCancelAppointment = function(appointmentId) {
        const reason = document.getElementById('cancelReason')?.value || 'Cancelado por el administrador';
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelAppointmentModal'));
        modal.hide();

        // Mostrar loading
        showAlert('<i class="fas fa-spinner fa-spin me-2"></i>Cancelando turno...', 'info');

          fetch(`https://daytona-clean-service.onrender.com/api/appointments/admin/${appointmentId}/cancel`, {
            method: 'PUT',
            headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
            showAlert('‚úÖ Turno cancelado exitosamente. Se envi√≥ notificaci√≥n al cliente.', 'success');
              
              // Mostrar notificaci√≥n web si est√° disponible
              if (window.showAppointmentCancellation) {
                const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
                if (appointment) {
                window.showAppointmentCancellation(appointment, reason);
                }
              }
              
              loadAllAppointments();
              loadAdminStats();
            } else {
            showAlert('‚ùå Error cancelando turno: ' + (data.message || ''), 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
          showAlert('‚ùå Error de conexi√≥n al cancelar turno', 'danger');
          });
      };

      // Enviar recordatorio (admin)
      window.sendReminderAdmin = function(appointmentId) {
        if (confirm('¬øEnviar recordatorio de turno al cliente?')) {
          fetch(`https://daytona-clean-service.onrender.com/api/appointments/admin/${appointmentId}/reminder`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showAlert('Recordatorio enviado exitosamente', 'success');
              
              // Mostrar notificaci√≥n web si est√° disponible
              if (window.showAppointmentReminder) {
                const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
                if (appointment) {
                  window.showAppointmentReminder(appointment);
                }
              }
              
              loadAllAppointments();
            } else {
              showAlert('Error enviando recordatorio: ' + (data.message || ''), 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showAlert('Error de conexi√≥n al enviar recordatorio', 'danger');
          });
        }
      };

      // Exportar turnos
      window.exportAppointments = function() {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            // Crear CSV
            const csvContent = createCSV(data.appointments);
            downloadCSV(csvContent, 'turnos_export.csv');
            showAlert('Exportaci√≥n completada', 'success');
          }
        })
        .catch(error => {
          console.error('Error exportando:', error);
          showAlert('Error al exportar', 'danger');
        });
      };

      // Probar sistema de notificaciones
      window.testNotifications = function() {
        const phone = prompt('Ingresa un n√∫mero de tel√©fono para probar (opcional):');
        
        fetch('https://daytona-clean-service.onrender.com/api/notifications/test', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Prueba de notificaciones enviada exitosamente', 'success');
            
            // Mostrar notificaciones web de prueba
            if (window.showNotification) {
              window.showNotification('‚úÖ Notificaci√≥n de confirmaci√≥n de prueba', 'confirmation', 5000);
              setTimeout(() => {
                window.showNotification('‚ùå Notificaci√≥n de cancelaci√≥n de prueba', 'cancellation', 5000);
              }, 2000);
              setTimeout(() => {
                window.showNotification('‚è∞ Recordatorio de prueba', 'reminder', 5000);
              }, 4000);
            }
          } else {
            showAlert('Error en prueba de notificaciones: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al probar notificaciones', 'danger');
        });
      };

      // Crear contenido CSV
      function createCSV(appointments) {
        const headers = [
          'ID',
          'Cliente',
          'Tel√©fono',
          'Email',
          'Fecha',
          'Hora',
          'Servicios',
          'Total',
          'Estado',
          'Direcci√≥n',
          'Fecha Creaci√≥n'
        ];

        const rows = appointments.map(appointment => [
          appointment.id,
          appointment.client_name || '',
          appointment.client_phone || '',
          appointment.client_email || '',
          appointment.appointment_date,
          appointment.start_time || appointment.appointment_time || '',
          appointment.service_type || '',
          appointment.total_amount || appointment.totalAmount || appointment.total_price || '',
          appointment.status,
          appointment.service_location || appointment.serviceLocation || '',
          appointment.created_at
        ]);

        const csvContent = [headers, ...rows]
          .map(row => row.map(cell => `"${cell}"`).join(','))
          .join('\n');

        return csvContent;
      }

      // Descargar CSV
      function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // ===== FUNCIONES PARA EDITAR PERFIL =====
      
      // Abrir modal de edici√≥n de perfil
      window.openEditProfileModal = function() {
        // Llenar el formulario con los datos actuales del usuario
        const user = JSON.parse(localStorage.getItem('userData') || '{}');
        
        // Asegurar que el nombre se cargue correctamente
        document.getElementById('editProfileName').value = user.name || 'No disponible';
        document.getElementById('editProfileEmail').value = user.email || '';
        document.getElementById('editProfilePhone').value = user.phone || '';
        
        // Limpiar campos de contrase√±a
        document.getElementById('editProfileCurrentPassword').value = '';
        document.getElementById('editProfileNewPassword').value = '';
        document.getElementById('editProfileConfirmPassword').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        modal.show();
      };

      // Manejar env√≠o del formulario de edici√≥n de perfil
      document.getElementById('editProfileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('editProfileName').value.trim();
        const email = document.getElementById('editProfileEmail').value.trim();
        const phone = document.getElementById('editProfilePhone').value.trim();
        const currentPassword = document.getElementById('editProfileCurrentPassword').value;
        const newPassword = document.getElementById('editProfileNewPassword').value;
        const confirmPassword = document.getElementById('editProfileConfirmPassword').value;
        
        // Validaciones b√°sicas
        if (!email || !phone) {
          showAlert('Email y tel√©fono son campos obligatorios', 'danger');
          return;
        }
        
        if (email && !isValidEmail(email)) {
          showAlert('Por favor ingresa un email v√°lido', 'danger');
          return;
        }
        
        // Validar contrase√±as si se van a cambiar
        if (newPassword || currentPassword || confirmPassword) {
          if (!currentPassword) {
            showAlert('Debes ingresar tu contrase√±a actual para cambiarla', 'danger');
            return;
          }
          
          if (!newPassword) {
            showAlert('Debes ingresar una nueva contrase√±a', 'danger');
            return;
          }
          
          if (newPassword.length < 6) {
            showAlert('La nueva contrase√±a debe tener al menos 6 caracteres', 'danger');
            return;
          }
          
          if (newPassword !== confirmPassword) {
            showAlert('Las contrase√±as no coinciden', 'danger');
            return;
          }
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
        submitBtn.disabled = true;
        
        // Preparar datos para enviar
        const updateData = {
          email,
          phone
        };
        
        if (newPassword) {
          updateData.currentPassword = currentPassword;
          updateData.newPassword = newPassword;
        }
        
        // Enviar actualizaci√≥n
        fetch('https://daytona-clean-service.onrender.com/api/users/profile', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Perfil actualizado exitosamente', 'success');
            
            // Actualizar datos en localStorage
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            userData.email = email;
            userData.phone = phone;
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // Actualizar la informaci√≥n mostrada en la p√°gina
            updateUserInfoDisplay(userData);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
          } else {
            showAlert('Error actualizando perfil: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al actualizar perfil', 'danger');
        })
        .finally(() => {
          // Restaurar bot√≥n
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Funci√≥n para validar email
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Funci√≥n para actualizar las estad√≠sticas del usuario
      function updateUserStats(appointments) {
        const active = appointments.filter(a => a.status === 'pending' || a.status === 'confirmed').length;
        const completed = appointments.filter(a => a.status === 'completed').length;
        const pending = appointments.filter(a => a.status === 'pending').length;
        const cancelled = appointments.filter(a => a.status === 'cancelled').length;
        
        document.getElementById('activeAppointmentsCount').textContent = active;
        document.getElementById('completedAppointmentsCount').textContent = completed;
        document.getElementById('pendingAppointmentsCount').textContent = pending;
        document.getElementById('cancelledAppointmentsCount').textContent = cancelled;
      }

      // Funci√≥n para actualizar la informaci√≥n del usuario en la p√°gina
      function updateUserInfoDisplay(user) {
        const isAdmin = user.role === 'admin';
        
        document.getElementById('userDetails').innerHTML = `
          <div class="user-detail-item" data-field="name">
            <div class="user-detail-header">
              <i class="fas fa-user"></i>
              Nombre
            </div>
            <div class="user-detail-value" id="userNameValue">${user.name}</div>
            <input type="text" class="user-detail-input" id="userNameInput" value="${user.name}" style="display: none;">
          </div>
          
          <div class="user-detail-item" data-field="email">
            <div class="user-detail-header">
              <i class="fas fa-envelope"></i>
              Email
            </div>
            <div class="user-detail-value" id="userEmailValue">${user.email}</div>
            <input type="email" class="user-detail-input" id="userEmailInput" value="${user.email}" style="display: none;">
          </div>
          
          <div class="user-detail-item" data-field="phone">
            <div class="user-detail-header">
              <i class="fas fa-phone"></i>
              Tel√©fono
            </div>
            <div class="user-detail-value" id="userPhoneValue">${user.phone || 'No especificado'}</div>
            <input type="tel" class="user-detail-input" id="userPhoneInput" value="${user.phone || ''}" style="display: none;">
          </div>
          
          ${isAdmin ? `
          <div class="user-detail-item">
            <div class="user-detail-header">
              <i class="fas fa-shield-alt" style="color: #ff6b35;"></i>
              Rol
            </div>
            <div class="user-detail-value">
              <span class="appointment-status confirmed">Administrador</span>
            </div>
          </div>
          ` : ''}
        `;
      }

      // Variables para el modo de edici√≥n
      let isEditMode = false;
      let originalUserData = {};

      // Funci√≥n para alternar modo de edici√≥n
      window.toggleEditMode = function() {
        if (isEditMode) {
          saveProfileChanges();
        } else {
          enterEditMode();
        }
      };

      // Funci√≥n para entrar en modo de edici√≥n
      function enterEditMode() {
        isEditMode = true;
        originalUserData = JSON.parse(localStorage.getItem('userData') || '{}');
        
        // Mostrar botones de guardar y cancelar
        document.getElementById('toggleEditBtn').style.display = 'none';
        document.getElementById('saveProfileBtn').style.display = 'inline-flex';
        document.getElementById('cancelEditBtn').style.display = 'inline-flex';
        
        // Mostrar inputs y ocultar valores
        const detailItems = document.querySelectorAll('.user-detail-item[data-field]');
        detailItems.forEach(item => {
          const field = item.dataset.field;
          const valueDiv = item.querySelector('.user-detail-value');
          const input = item.querySelector('.user-detail-input');
          
          if (valueDiv && input) {
            valueDiv.style.display = 'none';
            input.style.display = 'block';
            item.classList.add('editing');
          }
        });
      }

      // Funci√≥n para cancelar edici√≥n
      window.cancelEditMode = function() {
        isEditMode = false;
        
        // Restaurar botones
        document.getElementById('toggleEditBtn').style.display = 'inline-flex';
        document.getElementById('saveProfileBtn').style.display = 'none';
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        // Restaurar valores originales
        const detailItems = document.querySelectorAll('.user-detail-item[data-field]');
        detailItems.forEach(item => {
          const field = item.dataset.field;
          const valueDiv = item.querySelector('.user-detail-value');
          const input = item.querySelector('.user-detail-input');
          
          if (valueDiv && input) {
            valueDiv.style.display = 'block';
            input.style.display = 'none';
            item.classList.remove('editing');
            
            // Restaurar valor original
            const originalValue = originalUserData[field] || '';
            input.value = originalValue;
            valueDiv.textContent = originalValue || 'No especificado';
          }
        });
      }

      // Funci√≥n para guardar cambios del perfil
      window.saveProfileChanges = function() {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const newData = {
          name: document.getElementById('userNameInput').value.trim(),
          email: document.getElementById('userEmailInput').value.trim(),
          phone: document.getElementById('userPhoneInput').value.trim()
        };
        
        // Validaciones
        if (!newData.email) {
          showAlert('El email es obligatorio', 'danger');
          return;
        }
        
        if (newData.email && !isValidEmail(newData.email)) {
          showAlert('Por favor ingresa un email v√°lido', 'danger');
          return;
        }
        
        // Mostrar loading
        const saveBtn = document.getElementById('saveProfileBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        saveBtn.disabled = true;
        
        // Enviar actualizaci√≥n
        fetch('https://daytona-clean-service.onrender.com/api/users/profile', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Perfil actualizado exitosamente', 'success');
            
            // Actualizar datos en localStorage
            const updatedUserData = { ...userData, ...newData };
            localStorage.setItem('userData', JSON.stringify(updatedUserData));
            
            // Salir del modo de edici√≥n
            exitEditMode();
            
            // Actualizar la informaci√≥n mostrada
            updateUserInfoDisplay(updatedUserData);
          } else {
            showAlert('Error actualizando perfil: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al actualizar perfil', 'danger');
        })
        .finally(() => {
          // Restaurar bot√≥n
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        });
      };

      // Funci√≥n para salir del modo de edici√≥n
      function exitEditMode() {
        isEditMode = false;
        
        // Restaurar botones
        document.getElementById('toggleEditBtn').style.display = 'inline-flex';
        document.getElementById('saveProfileBtn').style.display = 'none';
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        // Ocultar inputs y mostrar valores
        const detailItems = document.querySelectorAll('.user-detail-item[data-field]');
        detailItems.forEach(item => {
          const valueDiv = item.querySelector('.user-detail-value');
          const input = item.querySelector('.user-detail-input');
          
          if (valueDiv && input) {
            valueDiv.style.display = 'block';
            input.style.display = 'none';
            item.classList.remove('editing');
            
            // Actualizar valor mostrado
            valueDiv.textContent = input.value || 'No especificado';
          }
        });
      }

      // ===== FUNCIONES PARA RESE√ëAS =====
      
      // Funci√≥n para cargar rese√±as del usuario
      window.loadUserReviews = function() {
        fetch('https://daytona-clean-service.onrender.com/api/reviews/user', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayUserReviews(data.reviews || []);
          } else {
            document.getElementById('userReviewsList').innerHTML = `
              <div class="empty-state">
                <i class="fas fa-comment-slash"></i>
                <h3>No tienes rese√±as</h3>
                <p>A√∫n no has dejado ninguna rese√±a.</p>
              </div>`;
          }
        })
        .catch(error => {
          console.error('Error cargando rese√±as:', error);
          document.getElementById('userReviewsList').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error cargando rese√±as</h3>
              <p>No se pudieron cargar tus rese√±as.</p>
            </div>`;
        });
      };

      // Funci√≥n para mostrar rese√±as del usuario
      function displayUserReviews(reviews) {
        const reviewsList = document.getElementById('userReviewsList');
        
        if (!reviews.length) {
          reviewsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-comment-slash"></i>
              <h3>No tienes rese√±as</h3>
              <p>A√∫n no has dejado ninguna rese√±a.</p>
            </div>`;
          return;
        }
        
        reviewsList.innerHTML = reviews.map(review => {
          const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
          const statusClass = review.status || 'pending';
          const statusText = review.status === 'approved' ? 'Aprobada' : 
                           review.status === 'rejected' ? 'Rechazada' : 'Pendiente';
          
          return `
            <div class="review-item">
              <div class="review-header">
                <div>
                  <div class="review-title">${review.title}</div>
                  <div class="review-rating">${stars}</div>
                </div>
                <div>
                  <div class="review-date">${new Date(review.created_at).toLocaleDateString('es-AR')}</div>
                  <div class="review-status ${statusClass}">${statusText}</div>
                </div>
              </div>
              <div class="review-content-text">${review.content}</div>
              ${review.service_type ? `<div class="review-service">Servicio: ${review.service_type}</div>` : ''}
            </div>
          `;
        }).join('');
      }

      // Funci√≥n para manejar el env√≠o de rese√±as
      document.getElementById('reviewForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const rating = document.querySelector('input[name="rating"]:checked');
        const title = document.getElementById('reviewTitle').value.trim();
        const content = document.getElementById('reviewContent').value.trim();
        const service = document.getElementById('reviewService').value;
        
        // Validaciones
        if (!rating) {
          showAlert('Por favor selecciona una calificaci√≥n', 'warning');
          return;
        }
        
        if (!title) {
          showAlert('Por favor ingresa un t√≠tulo para tu rese√±a', 'warning');
          return;
        }
        
        if (!content) {
          showAlert('Por favor ingresa tu opini√≥n', 'warning');
          return;
        }
        
        if (content.length < 10) {
          showAlert('Tu opini√≥n debe tener al menos 10 caracteres', 'warning');
          return;
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        submitBtn.disabled = true;
        
        // Enviar rese√±a
        fetch('https://daytona-clean-service.onrender.com/api/reviews', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            rating: parseInt(rating.value),
            title: title,
            content: content,
            service_type: service || null
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Rese√±a enviada exitosamente. Ser√° revisada por nuestro equipo.', 'success');
            
            // Limpiar formulario
            this.reset();
            
            // Recargar rese√±as
            loadUserReviews();
          } else {
            showAlert('Error enviando rese√±a: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al enviar rese√±a', 'danger');
        })
        .finally(() => {
          // Restaurar bot√≥n
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Cargar rese√±as al cargar la p√°gina
      if (!isAdmin) {
        loadUserReviews();
      } else {
        // Ocultar secci√≥n de rese√±as para administradores
        document.getElementById('reviews-section').style.display = 'none';
      }
    });

    // Scroll autom√°tico a #gestion-turnos si est√° en el hash y el panel admin aparece
    document.addEventListener('DOMContentLoaded', function() {
      if (window.location.hash === '#gestion-turnos') {
        const scrollToGestion = () => {
          const adminPanel = document.getElementById('adminPanel');
          const gestion = document.getElementById('gestion-turnos');
          if (adminPanel && adminPanel.style.display !== 'none' && gestion) {
            gestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return true;
          }
          return false;
        };
        // Intentar scroll varias veces por si el panel aparece despu√©s
        let intentos = 0;
        const intervalo = setInterval(() => {
          if (scrollToGestion() || ++intentos > 20) {
            clearInterval(intervalo);
          }
        }, 150);
      }
    });

    function mostrarDireccionAdmin(direccion) {
      if (!direccion || direccion === 'A confirmar') return 'A confirmar';
      if (direccion.toLowerCase().includes('lleva el veh√≠culo')) {
        return '<strong>Log√≠stica:</strong> El cliente lleva el veh√≠culo';
      }
      if (direccion.includes('Retiro:') && direccion.includes('Entrega:')) {
        const match = direccion.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
        if (match) {
          return `<strong>Retiro:</strong> ${match[1].trim()}<br><strong>Entrega:</strong> ${match[2].trim()}`;
        }
      }
      // Por defecto, para tapizados u otros servicios
      return `<strong>Direcci√≥n:</strong> ${direccion}`;
    }
  </script>
</body>
</html>