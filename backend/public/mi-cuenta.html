<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Cuenta - Daytona Clean Service</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components/header.css">
  <link rel="stylesheet" href="css/components/forms.css">
  
  <style>
    .account-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      padding-top: 120px; /* Agregar espacio para el header fijo */
      background: #1a1a1a;
      min-height: 100vh;
      color: #fff;
    }
    
    .account-header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem 0;
      border-bottom: 2px solid #333;
    }
    
    .account-header h1 {
      color: #00d4ff;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .user-info-card, .appointments-section {
      background: #232323;
      padding: 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      border: 1px solid #333;
    }
    
    .user-info-card h3, .active-appointments-section h3, .appointments-history-section h3 {
      color: #00d4ff;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #00d4ff;
      padding-bottom: 0.8rem;
      font-weight: 600;
    }
    
    .user-details {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #2a2a2a;
      border-radius: 5px;
      border-left: 4px solid #00d4ff;
    }
    
    .detail-item i {
      color: #00d4ff;
      width: 20px;
    }
    
    .appointment-card {
      background: #2a2a2a;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #333;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .appointment-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      border-color: #00d4ff;
    }
    
    .appointment-card .btn {
      margin: 0.25rem;
    }
    
    .loading {
      text-align: center;
      color: #888;
      padding: 2rem;
    }
    
    .alert {
      border-radius: 8px;
      border: none;
    }
    
    .alert-warning {
      background: #332701;
      color: #ffc107;
      border-left: 4px solid #ffc107;
    }
    
    .alert-danger {
      background: #331a1a;
      color: #dc3545;
      border-left: 4px solid #dc3545;
    }
    
    .alert-success {
      background: #1a331a;
      color: #28a745;
      border-left: 4px solid #28a745;
    }
    
    /* Modal personalizado */
    .modal-content {
      background: #232323 !important;
      color: #fff !important;
      border: 1px solid #333;
    }
    
    .modal-header {
      border-bottom: 1px solid #333;
    }
    
    .modal-title {
      color: #00d4ff;
    }
    
    .btn-close {
      filter: invert(1);
    }
    
    .form-control {
      background: #2a2a2a !important;
      border: 1px solid #333 !important;
      color: #fff !important;
    }
    
    .form-control:focus {
      background: #2a2a2a !important;
      border-color: #00d4ff !important;
      color: #fff !important;
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
    }
    
    .form-label {
      color: #fff;
    }
    
    .btn-primary {
      background: #00d4ff;
      border-color: #00d4ff;
    }
    
    .btn-primary:hover {
      background: #00b8e6;
      border-color: #00b8e6;
    }
    
    .btn-danger {
      background: #dc3545;
      border-color: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
      border-color: #c82333;
    }
    
    /* Responsive para m√≥viles */
    @media (max-width: 768px) {
      .action-buttons-container {
        flex-direction: row;
        justify-content: center;
        margin-top: 15px;
      }
      
      .action-btn,
      .status-badge {
        max-width: 120px;
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .appointment-card .row {
        flex-direction: column;
      }
      
      .appointment-card .col-md-4 {
        margin-top: 15px;
      }
    }
    
    /* Estilos para los botones de acci√≥n */
    .action-buttons-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      justify-content: center;
      align-items: flex-end;
    }
    
    .action-btn {
      width: 100%;
      max-width: 140px;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      text-decoration: none;
      color: white;
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
    
    .edit-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #00b8e6 100%);
    }
    
    .edit-btn:hover {
      background: linear-gradient(135deg, #00b8e6 0%, #0099cc 100%);
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .cancel-btn:hover {
      background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
    }
    
    /* Estilos para los badges de estado */
    .status-badge {
      width: 100%;
      max-width: 140px;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .status-badge.cancelled {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .status-badge.completed {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .status-badge.unknown {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    }
    
    /* Efecto de highlight para secci√≥n activa */
    .active-appointments-section.highlight {
      animation: highlightSection 2s ease-in-out;
    }
    
    @keyframes highlightSection {
      0% { box-shadow: var(--shadow-primary); }
      50% { 
        box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        border-color: #00d4ff;
      }
      100% { box-shadow: var(--shadow-primary); }
    }

    /* Estilos para el panel de administraci√≥n */
    .admin-dashboard-section,
    .admin-appointments-section {
      background: #232323;
      padding: 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      border: 1px solid #333;
    }

    .admin-dashboard-section h3,
    .admin-appointments-section h3 {
      color: #00d4ff;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #00d4ff;
      padding-bottom: 0.8rem;
      font-weight: 600;
    }

    .admin-stat-card {
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }

    .admin-stat-card:hover {
      transform: translateY(-2px);
    }

    .admin-stat-card h4 {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .admin-badge {
      border-left-color: #ff6b35 !important;
    }

    .admin-badge i {
      color: #ff6b35 !important;
    }

    .table-dark {
      background: #2a2a2a;
      color: #fff;
    }

    .table-dark th {
      background: #1a1a1a;
      border-color: #333;
      color: #ff6b35;
    }

    .table-dark td {
      border-color: #333;
    }

    .btn-group .btn {
      border-color: #333;
    }

    .btn-group .btn:hover {
      background-color: #ff6b35;
      border-color: #ff6b35;
    }

    .btn-outline-secondary {
      border-color: #333;
      color: #fff;
    }

    .btn-outline-secondary:hover {
      background-color: #ff6b35;
      border-color: #ff6b35;
      color: #fff;
    }

    /* Estilos para campos deshabilitados */
    .form-control:disabled {
      background: #2a2a2a !important;
      border: 1px solid #333 !important;
      color: #888 !important;
      cursor: not-allowed;
    }

    .form-control:disabled:focus {
      background: #2a2a2a !important;
      border-color: #333 !important;
      box-shadow: none !important;
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div id="header-container"></div>

  <div class="account-container">
    <div class="account-header" id="account-header">
      <h1><i class="fas fa-user-circle me-2"></i>Mi Cuenta</h1>
      <p>Gestiona tus turnos y tu informaci√≥n personal</p>
    </div>
    

    
    <!-- Alertas -->
    <div id="alert-container"></div>
    
    <!-- Informaci√≥n del usuario -->
    <div class="user-info-card" id="user-info-card">
      <h3><i class="fas fa-user me-2"></i>Informaci√≥n Personal</h3>
      <div class="text-end mb-3">
        <button class="btn btn-outline-primary btn-sm" onclick="openEditProfileModal()">
          <i class="fas fa-edit me-1"></i>Editar Perfil
        </button>
      </div>
      <div class="user-details" id="userDetails">
        <div class="loading">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando informaci√≥n...
        </div>
      </div>
    </div>
    
    <!-- Turnos Activos -->
    <div class="active-appointments-section" id="turnos-activos">
      <h3><i class="fas fa-calendar-check me-2"></i>Gesti√≥n de Turnos Activos</h3>
      <div id="activeAppointmentsList">
        <div class="loading">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando turnos activos...
        </div>
      </div>
    </div>

    <!-- Historial de servicios -->
    <div class="appointments-history-section" id="appointments-history-section">
      <h3><i class="fas fa-history me-2"></i>Historial de Servicios</h3>
      <div id="appointmentsHistoryList">
        <div class="loading">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando historial...
        </div>
      </div>
    </div>

    <!-- PANEL DE ADMINISTRACI√ìN (Solo visible para admins) -->
    <div id="adminPanel" style="display: none;">
      <!-- Dashboard Admin -->
      <div class="admin-dashboard-section">
        <h3><i class="fas fa-chart-line me-2" style="color:#00d4ff;"></i><span style="color:#00d4ff;">Dashboard de Administraci√≥n</span></h3>
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="admin-stat-card bg-primary text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="totalAppointments">0</h4>
                  <p class="mb-0">Total Turnos</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-calendar fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-success text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="pendingAppointments">0</h4>
                  <p class="mb-0">Pendientes</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-clock fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-info text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="todayAppointments">0</h4>
                  <p class="mb-0">Hoy</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-calendar-day fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-warning text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="totalRevenue">$0</h4>
                  <p class="mb-0">Ingresos</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-dollar-sign fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesti√≥n de Turnos Admin -->
      <div class="admin-appointments-section" id="gestion-turnos">
        <h3><i class="fas fa-list me-2" style="color:#00d4ff;"></i><span style="color:#00d4ff;">Gesti√≥n de Todos los Turnos</span></h3>
        
        <!-- Filtros y b√∫squeda -->
        <div class="row mb-4">
          <div class="col-md-8">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary" onclick="filterAdminAppointments('all')">Todos</button>
              <button type="button" class="btn btn-outline-warning" onclick="filterAdminAppointments('pending')">Pendientes</button>
              <button type="button" class="btn btn-outline-success" onclick="filterAdminAppointments('confirmed')">Confirmados</button>
              <button type="button" class="btn btn-outline-danger" onclick="filterAdminAppointments('cancelled')">Cancelados</button>
            </div>
            <button type="button" class="btn btn-outline-secondary ms-3" onclick="exportAppointments()">
              <i class="fas fa-download me-2"></i>Exportar
            </button>
            <button type="button" class="btn btn-outline-info ms-3" onclick="testNotifications()">
              <i class="fas fa-bell me-2"></i>Probar Notificaciones
            </button>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Buscar turnos...">
              <button class="btn btn-outline-secondary" type="button" onclick="searchAdminAppointments()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Tabla de turnos -->
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th><i class="fas fa-hashtag me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">ID</span></th>
                <th><i class="fas fa-user me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Cliente</span></th>
                <th><i class="fas fa-calendar-alt me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Fecha</span></th>
                <th><i class="fas fa-clock me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Hora</span></th>
                <th><i class="fas fa-tools me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Servicios</span></th>
                <th><i class="fas fa-dollar-sign me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Total</span></th>
                <th><span style="display: flex; align-items: center;"><i class="fas fa-flag me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Estado</span></span></th>
                <th><i class="fas fa-cogs me-1" style="color:#adb5bd;"></i><span style="font-weight:bold;color:#fff;">Acciones</span></th>
              </tr>
            </thead>
            <tbody id="adminAppointmentsTableBody">
              <tr>
                <td colspan="8" class="text-center">
          <i class="fas fa-spinner fa-spin me-2"></i>Cargando turnos...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Botones de debug -->
      <div class="text-center mb-3">
        <button class="btn btn-outline-info me-2" onclick="toggleReviewsSection()">
          <i class="fas fa-star me-2"></i>Mostrar/Ocultar Panel de Rese√±as
        </button>
        <button class="btn btn-outline-warning" onclick="debugToken()">
          <i class="fas fa-bug me-2"></i>Debug Token
        </button>
      </div>

      <!-- Gesti√≥n de Rese√±as Admin -->
      <div class="admin-appointments-section" id="gestion-resenas" style="display: block;">
        <h3><i class="fas fa-star me-2" style="color:#00d4ff;"></i><span style="color:#00d4ff;">Gesti√≥n de Rese√±as de Clientes</span></h3>
        
        <!-- Estad√≠sticas de rese√±as -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="admin-stat-card bg-primary text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="totalReviews">0</h4>
                  <p class="mb-0">Total Rese√±as</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-star fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-warning text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="pendingReviews">0</h4>
                  <p class="mb-0">Pendientes</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-clock fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-success text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="averageRating">0.0</h4>
                  <p class="mb-0">Promedio</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-star-half-alt fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="admin-stat-card bg-info text-white">
              <div class="d-flex justify-content-between">
                <div>
                  <h4 id="fiveStarReviews">0</h4>
                  <p class="mb-0">5 Estrellas</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-star fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtros de rese√±as -->
        <div class="row mb-4">
          <div class="col-md-8">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary" onclick="filterAdminReviews('all')">Todas</button>
              <button type="button" class="btn btn-outline-warning" onclick="filterAdminReviews('pending')">Pendientes</button>
              <button type="button" class="btn btn-outline-success" onclick="filterAdminReviews('approved')">Aprobadas</button>
              <button type="button" class="btn btn-outline-danger" onclick="filterAdminReviews('rejected')">Rechazadas</button>
            </div>
            <button type="button" class="btn btn-outline-secondary ms-3" onclick="exportReviews()">
              <i class="fas fa-download me-2"></i>Exportar Rese√±as
            </button>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchReviewsInput" placeholder="Buscar rese√±as...">
              <button class="btn btn-outline-secondary" type="button" onclick="searchAdminReviews()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Tabla de rese√±as -->
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th><i class="fas fa-hashtag me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">ID</span></th>
                <th><i class="fas fa-user me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Cliente</span></th>
                <th><i class="fas fa-tools me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Servicio</span></th>
                <th><i class="fas fa-star me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Calificaci√≥n</span></th>
                <th><i class="fas fa-comment me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Comentario</span></th>
                <th><i class="fas fa-calendar me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Fecha</span></th>
                <th><i class="fas fa-flag me-1" style="color:#00d4ff;"></i><span style="font-weight:bold;color:#fff;">Estado</span></th>
                <th><i class="fas fa-cogs me-1" style="color:#adb5bd;"></i><span style="font-weight:bold;color:#fff;">Acciones</span></th>
              </tr>
            </thead>
            <tbody id="adminReviewsTableBody">
              <tr>
                <td colspan="8" class="text-center">
                  <i class="fas fa-spinner fa-spin me-2"></i>Cargando rese√±as...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar turno -->
  <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editAppointmentModalLabel">
            <i class="fas fa-edit me-2"></i>Editar Turno
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="editAppointmentForm">
            <input type="hidden" id="editAppointmentId" />
            
            <!-- Informaci√≥n del turno actual -->
            <div class="alert alert-info mb-3">
              <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n del Turno</h6>
              <div id="editAppointmentInfo" class="small">
                <!-- Se llenar√° din√°micamente -->
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
            <div class="mb-3">
                  <label for="editAppointmentDate" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Fecha *
                  </label>
              <input type="date" class="form-control" id="editAppointmentDate" required />
            </div>
              </div>
              <div class="col-md-6">
            <div class="mb-3">
                  <label for="editAppointmentTime" class="form-label">
                    <i class="fas fa-clock me-1"></i>Hora *
                  </label>
                  <select class="form-control" id="editAppointmentTime" required>
                    <option value="">Selecciona una hora</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                  </select>
            </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editAppointmentAddress" class="form-label">
                <i class="fas fa-map-marker-alt me-1"></i>Direcci√≥n
              </label>
              <textarea class="form-control" id="editAppointmentAddress" rows="2" placeholder="Direcci√≥n donde se realizar√° el servicio"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="editAppointmentNotes" class="form-label">
                <i class="fas fa-sticky-note me-1"></i>Notas adicionales
              </label>
              <textarea class="form-control" id="editAppointmentNotes" rows="2" placeholder="Detalles adicionales, referencias, etc."></textarea>
            </div>
            
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n para cancelar -->
  <div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="cancelConfirmModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Cancelaci√≥n
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p><strong>¬øEst√°s seguro de que quieres cancelar este turno?</strong></p>
          <div id="cancelAppointmentInfo" class="alert alert-warning">
            <!-- Se llenar√° din√°micamente -->
          </div>
          <p class="text-muted small">
            <i class="fas fa-info-circle me-1"></i>
            Esta acci√≥n no se puede deshacer. El turno ser√° marcado como cancelado.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>No, mantener
          </button>
          <button type="button" class="btn btn-danger" id="confirmCancelBtn">
            <i class="fas fa-check me-1"></i>S√≠, cancelar turno
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar perfil -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editProfileModalLabel">
            <i class="fas fa-user-edit me-2"></i>Editar Perfil
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="editProfileForm">
            <!-- Informaci√≥n b√°sica -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfileName" class="form-label">
                    <i class="fas fa-user me-1"></i>Nombre completo
                  </label>
                  <input type="text" class="form-control" id="editProfileName" disabled />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfilePhone" class="form-label">
                    <i class="fas fa-phone me-1"></i>Tel√©fono *
                  </label>
                  <input type="tel" class="form-control" id="editProfilePhone" required />
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editProfileEmail" class="form-label">
                <i class="fas fa-envelope me-1"></i>Email *
              </label>
              <input type="email" class="form-control" id="editProfileEmail" required />
            </div>

            <hr class="my-4">

            <!-- Cambio de contrase√±a -->
            <h6 class="text-primary mb-3">
              <i class="fas fa-lock me-2"></i>Cambiar Contrase√±a
            </h6>
            <p class="text-muted small mb-3">
              <i class="fas fa-info-circle me-1"></i>
              Deja los campos de contrase√±a vac√≠os si no quieres cambiarla.
            </p>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfileCurrentPassword" class="form-label">
                    <i class="fas fa-key me-1"></i>Contrase√±a actual
                  </label>
                  <input type="password" class="form-control" id="editProfileCurrentPassword" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editProfileNewPassword" class="form-label">
                    <i class="fas fa-lock me-1"></i>Nueva contrase√±a
                  </label>
                  <input type="password" class="form-control" id="editProfileNewPassword" />
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editProfileConfirmPassword" class="form-label">
                <i class="fas fa-check-circle me-1"></i>Confirmar nueva contrase√±a
              </label>
              <input type="password" class="form-control" id="editProfileConfirmPassword" />
            </div>

            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer-container"></div>

  <!-- Bootstrap JS (para el modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Scripts para incluir header y footer -->
  <script src="js/config.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/mi-cuenta.js"></script>
  <script src="js/include-header.js"></script>
  <script src="js/include-footer.js"></script>

  <script>
    let currentAppointments = [];

    function hideUserSectionsForAdmin() {
      const info = document.getElementById('user-info-card');
      const activos = document.getElementById('turnos-activos');
      const historial = document.getElementById('appointments-history-section');
      if (info) info.style.display = 'none';
      if (activos) activos.style.display = 'none';
      if (historial) historial.style.display = 'none';
    }
    function showUserSectionsForNormal() {
      const info = document.getElementById('user-info-card');
      const activos = document.getElementById('turnos-activos');
      const historial = document.getElementById('appointments-history-section');
      if (info) info.style.display = 'block';
      if (activos) activos.style.display = 'block';
      if (historial) historial.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Verificar autenticaci√≥n y cargar datos
      const token = localStorage.getItem('token');
      console.log('üîç Token encontrado:', token ? 'S√≠' : 'No');
      console.log('üîë Token completo:', token);
      
      if (!token) {
        console.log('‚ùå No hay token, redirigiendo a login');
        window.location.href = 'login.html';
        return;
      }
      
      // Cargar datos del usuario
      const apiUrl = window.getApiUrl ? window.getApiUrl() : 'https://daytona-clean-service.onrender.com/api';
      console.log('üåê Haciendo petici√≥n a:', `${apiUrl}/users/me`);
      
      console.log('üåê Headers de la petici√≥n:', {
        'Authorization': `Bearer ${token}`
      });
      
      fetch(`${apiUrl}/users/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => {
        console.log('üì° Respuesta del servidor:', res.status, res.statusText);
        return res.json();
      })
      .then(data => {
        console.log('üìä Datos recibidos:', data);
        
        if (data.success) {
          const user = data.user;
          const isAdmin = user.role === 'admin';
          console.log('üë§ Usuario:', user.name, 'Rol:', user.role, 'Es admin:', isAdmin);
          
          localStorage.setItem('userData', JSON.stringify(user));
          
          if (isAdmin) {
            console.log('üîß Cargando panel de admin...');
            document.getElementById('adminPanel').style.display = 'block';
            hideUserSectionsForAdmin();
            // Ocultar encabezado solo para admin
            const header = document.getElementById('account-header');
            if (header) header.style.display = 'none';
            loadAdminFeatures();
          } else {
            console.log('üë§ Cargando panel de usuario normal...');
            document.getElementById('adminPanel').style.display = 'none';
            showUserSectionsForNormal();
            // Mostrar encabezado para usuario normal
            const header = document.getElementById('account-header');
            if (header) header.style.display = 'block';
            loadAppointments();
          }
        } else {
          console.log('‚ùå Error en respuesta:', data.message);
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }
      })
      .catch((error) => {
        console.error('‚ùå Error en petici√≥n:', error);
        console.error('‚ùå Detalles del error:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      });

      // Cargar turnos y separarlos en activos e historial
      function loadAppointments() {
        fetch(`${apiUrl}/appointments/user/appointments`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            currentAppointments = data.appointments;
            
            // Separar turnos activos (pending, confirmed) del historial (solo completed)
            const activeAppointments = data.appointments.filter(a => 
              a.status === 'pending' || a.status === 'confirmed'
            );
            const historyAppointments = data.appointments.filter(a => 
              a.status === 'completed'
            );
            
            displayActiveAppointments(activeAppointments);
            displayHistoryAppointments(historyAppointments);
          } else {
            document.getElementById('activeAppointmentsList').innerHTML = '<div class="alert alert-warning">No tienes turnos activos.</div>';
            document.getElementById('appointmentsHistoryList').innerHTML = '<div class="alert alert-warning">No tienes servicios completados en tu historial.</div>';
          }
        })
        .catch(() => {
          document.getElementById('activeAppointmentsList').innerHTML = '<div class="alert alert-danger">Error cargando turnos activos.</div>';
                      document.getElementById('appointmentsHistoryList').innerHTML = '<div class="alert alert-danger">Error cargando historial de servicios.</div>';
        });
      }

      // Mostrar turnos activos
      function displayActiveAppointments(appointments) {
        const activeList = document.getElementById('activeAppointmentsList');
        if (!appointments.length) {
          activeList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No tienes turnos activos en este momento.</div>';
          return;
        }
        activeList.innerHTML = appointments.map(appointment => {
          // Formatear servicios si existen
          let serviciosInfo = '';
          if (appointment.services && appointment.services.length > 0) {
            serviciosInfo = appointment.services.map(s => {
              const nombreServicio = s.nombre || s.name || s.service_name || '';
              const cantidad = s.cantidad || s.quantity || 1;
              if (!nombreServicio) return '';
              return `${nombreServicio}${cantidad > 1 ? ' x'+cantidad : ''}`;
            }).filter(Boolean).join(', ');
          } else {
            serviciosInfo = appointment.service_type || 'No especificado';
          }

          // Formatear direcci√≥n/log√≠stica mejorada
          let direccionHtml = '';
          const dir = appointment.serviceLocation || appointment.service_location || appointment.address || '';
          if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
            const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
            if (match) {
              direccionHtml = `<strong>Retiro:</strong> ${match[1].trim()}<br><strong>Entrega:</strong> ${match[2].trim()}`;
            } else {
              direccionHtml = `<strong>Direcci√≥n:</strong> ${dir}`;
            }
          } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
            direccionHtml = '<strong>Log√≠stica:</strong> El cliente lleva el veh√≠culo';
          } else if (dir && dir.trim() && dir !== 'A confirmar') {
            direccionHtml = `<strong>Direcci√≥n:</strong> ${dir}`;
          } else {
            direccionHtml = '<span style="color: red; font-weight: bold;">¬°Error! Direcci√≥n obligatoria no especificada. Contactar al administrador.</span>';
          }

          // Formatear total
          let total = 'A confirmar';
          if (appointment.totalAmount || appointment.total_amount || appointment.total_price) {
            const t = appointment.totalAmount || appointment.total_amount || appointment.total_price;
            total = `$${parseInt(t).toLocaleString('es-AR')}`;
          } else if (appointment.services && appointment.services.length > 0) {
            const suma = appointment.services.reduce((acc, s) => acc + (parseInt(s.precio || s.price || 0) * (parseInt(s.cantidad || s.quantity || 1))), 0);
            if (suma > 0) total = `$${suma.toLocaleString('es-AR')}`;
          }

          return `
          <div class="appointment-card mb-3">
              <div class="row">
                <div class="col-md-8">
                  <div class="mb-2">
                    <strong><i class="fas fa-calendar-alt me-2" style="color: #00d4ff;"></i>Fecha:</strong> 
                    ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}
                    <span class="ms-3">
                      <strong><i class="fas fa-clock me-2" style="color: #00d4ff;"></i>Hora:</strong> 
                      ${appointment.appointment_time || appointment.start_time || 'No especificada'}
                    </span>
                  </div>
                  <div class="mb-2">
                    <strong><i class="fas fa-tools me-2" style="color: #00d4ff;"></i>Servicios:</strong> 
                    <span class="text-info">${serviciosInfo}</span>
                  </div>
                  <div class="mb-2">
                    <i class="fas fa-map-marker-alt me-2" style="color: #00d4ff;"></i>${direccionHtml}
                  </div>
                  <div class="mb-2">
                    <strong><i class="fas fa-dollar-sign me-2" style="color: #00d4ff;"></i>Total:</strong> 
                    <span class="text-success fw-bold">${total}</span>
                  </div>
            <div>
                    <strong><i class="fas fa-info-circle me-2" style="color: #00d4ff;"></i>Estado:</strong> 
                    <span class="badge bg-${getStatusBadge(appointment.status)}">${getStatusText(appointment.status)}</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="action-buttons-container">
                    ${appointment.status === 'pending' || appointment.status === 'confirmed' ? `
                      <button class="action-btn edit-btn" onclick="openEditModal(${appointment.id})" title="Editar turno">
                        <i class="fas fa-edit"></i>
                        <span>Editar</span>
                      </button>
                      <button class="action-btn cancel-btn" onclick="cancelAppointment(${appointment.id})" title="Cancelar turno">
                        <i class="fas fa-times"></i>
                        <span>Cancelar</span>
                      </button>
                    ` : appointment.status === 'cancelled' ? `
                      <div class="status-badge cancelled">
                        <i class="fas fa-ban"></i>
                        <span>Cancelado</span>
                      </div>
                    ` : appointment.status === 'completed' ? `
                      <div class="status-badge completed">
                        <i class="fas fa-check"></i>
                        <span>Completado</span>
                      </div>
                    ` : `
                      <div class="status-badge unknown">
                        <i class="fas fa-question"></i>
                        <span>${appointment.status}</span>
                      </div>
                    `}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Mostrar historial de turnos
      function displayHistoryAppointments(appointments) {
        const historyList = document.getElementById('appointmentsHistoryList');
        if (!appointments.length) {
          historyList.innerHTML = '<div class="alert alert-secondary"><i class="fas fa-info-circle me-2"></i>No tienes servicios completados en tu historial.</div>';
          return;
        }
        
        // Ordenar por fecha (m√°s reciente primero)
        const sortedAppointments = appointments.sort((a, b) => 
          new Date(b.appointment_date) - new Date(a.appointment_date)
        );
        
        historyList.innerHTML = sortedAppointments.map(appointment => {
          // Formatear servicios si existen
          let serviciosInfo = '';
          if (appointment.services && appointment.services.length > 0) {
            serviciosInfo = appointment.services.map(s => {
              const nombreServicio = s.nombre || s.name || s.service_name || 'Sin nombre';
              const cantidad = s.cantidad || s.quantity || 1;
              const precio = s.precio || s.price || '';
              return `${nombreServicio} x${cantidad}${precio ? ` ($${parseInt(precio).toLocaleString('es-AR')})` : ''}`;
            }).join(', ');
          } else {
            serviciosInfo = appointment.service_type || 'No especificado';
          }

          // Formatear direcci√≥n (buscar en notes, serviceLocation o address)
          let direccion = 'A confirmar';
          if (appointment.serviceLocation) {
            direccion = appointment.serviceLocation;
          } else if (appointment.address) {
            direccion = appointment.address;
          } else if (appointment.notes && appointment.notes.includes('Retiro:')) {
            direccion = appointment.notes;
          } else if (appointment.notes && appointment.notes.length > 0) {
            direccion = appointment.notes;
          }

          // Formatear total
          let total = 'A confirmar';
          if (appointment.totalAmount || appointment.total_amount || appointment.total_price) {
            const t = appointment.totalAmount || appointment.total_amount || appointment.total_price;
            total = `$${parseInt(t).toLocaleString('es-AR')}`;
          } else if (appointment.services && appointment.services.length > 0) {
            const suma = appointment.services.reduce((acc, s) => acc + (parseInt(s.precio || s.price || 0) * (parseInt(s.cantidad || s.quantity || 1))), 0);
            if (suma > 0) total = `$${suma.toLocaleString('es-AR')}`;
          }

          return `
            <div class="appointment-card mb-3 border-success">
              <div class="row">
                <div class="col-md-8">
                                    <div class="mb-2">
                    <strong><i class="fas fa-calendar-alt me-2" style="color: #00d4ff;"></i>Fecha:</strong> 
                    ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}
                    <span class="ms-3">
                      <strong><i class="fas fa-clock me-2" style="color: #00d4ff;"></i>Hora:</strong> 
                      ${appointment.appointment_time || appointment.start_time || 'No especificada'}
                    </span>
                  </div>
                  <div class="mb-2">
                    <strong><i class="fas fa-tools me-2" style="color: #00d4ff;"></i>Servicios:</strong> 
                    <span class="text-info">${serviciosInfo}</span>
                  </div>
                  <div class="mb-2">
                    <strong><i class="fas fa-map-marker-alt me-2" style="color: #00d4ff;"></i>Direcci√≥n:</strong> 
                    <span style="color: #fff;">${direccion}</span>
                  </div>
                  <div class="mb-2">
                    <strong><i class="fas fa-dollar-sign me-2" style="color: #00d4ff;"></i>Total:</strong> 
                    <span class="text-success fw-bold">${total}</span>
            </div>
            <div>
                    <strong><i class="fas fa-check-circle me-2" style="color: #00d4ff;"></i>Estado:</strong> 
                    <span class="badge bg-success">
                      <i class="fas fa-check me-1"></i>Completado
                    </span>
            </div>
          </div>
                <div class="col-md-4 text-end">
                  <div class="d-flex flex-column gap-2">
                    <span class="badge bg-success">
                      <i class="fas fa-check me-1"></i>Servicio Realizado
                    </span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Funci√≥n para obtener el color del badge seg√∫n el estado
      function getStatusBadge(status) {
        switch(status) {
          case 'pending': return 'warning';
          case 'confirmed': return 'success';
          case 'completed': return 'info';
          case 'cancelled': return 'danger';
          default: return 'secondary';
        }
      }

      // Funci√≥n para obtener el texto del estado
      function getStatusText(status) {
        switch(status) {
          case 'pending': return 'Pendiente';
          case 'confirmed': return 'Confirmado';
          case 'completed': return 'Completado';
          case 'cancelled': return 'Cancelado';
          default: return status;
        }
      }

      // Abrir modal de edici√≥n
      window.openEditModal = function(appointmentId) {
        const appointment = currentAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('Turno no encontrado', 'danger');
          return;
        }
        
        // Verificar si el turno se puede editar
        if (appointment.status === 'cancelled' || appointment.status === 'completed') {
          showAlert('No se puede editar un turno cancelado o completado', 'warning');
          return;
        }
        
        // Llenar informaci√≥n del turno
        document.getElementById('editAppointmentId').value = appointment.id;
        document.getElementById('editAppointmentDate').value = appointment.appointment_date.split('T')[0];
        document.getElementById('editAppointmentTime').value = appointment.start_time || '';
        document.getElementById('editAppointmentAddress').value = appointment.service_location || '';
        document.getElementById('editAppointmentNotes').value = appointment.notes || '';
        
        // Mostrar informaci√≥n del turno actual
        // --- Servicios ---
        let serviciosInfo = '';
        if (appointment.services && appointment.services.length > 0) {
          serviciosInfo = appointment.services.map(s => {
            const nombreServicio = s.nombre || s.name || s.service_name || '';
            const cantidad = s.cantidad || s.quantity || 1;
            if (!nombreServicio) return '';
            return `${nombreServicio}${cantidad > 1 ? ' x'+cantidad : ''}`;
          }).filter(Boolean).join(', ');
        } else {
          serviciosInfo = appointment.service_type || 'No especificado';
        }

        // --- Direcci√≥n / Log√≠stica ---
        let direccionHtml = '';
        const dir = appointment.serviceLocation || appointment.service_location || appointment.address || '';
        if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
          const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
          if (match) {
            direccionHtml = `<strong>Retiro:</strong> ${match[1].trim()}<br><strong>Entrega:</strong> ${match[2].trim()}`;
          } else {
            direccionHtml = `<strong>Direcci√≥n:</strong> ${dir}`;
          }
        } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
          direccionHtml = '<strong>Log√≠stica:</strong> El cliente lleva el veh√≠culo';
        } else if (dir && dir.trim() && dir !== 'A confirmar') {
          direccionHtml = `<strong>Direcci√≥n:</strong> ${dir}`;
        } else {
          direccionHtml = '<span style="color: red;">¬°Error! Direcci√≥n no especificada</span>';
        }

        // --- Total y hora ---
        let total = 'A confirmar';
        if (appointment.totalAmount || appointment.total_amount || appointment.total_price) {
          const t = appointment.totalAmount || appointment.total_amount || appointment.total_price;
          total = `$${parseInt(t).toLocaleString('es-AR')}`;
        }
        const hora = appointment.appointment_time || appointment.start_time || 'No especificada';

        document.getElementById('editAppointmentInfo').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <strong>Servicios:</strong> ${serviciosInfo}<br>
              <strong>Total:</strong> ${total}<br>
              <strong>Estado:</strong> <span class="badge bg-${getStatusBadge(appointment.status)}">${getStatusText(appointment.status)}</span>
            </div>
            <div class="col-md-6">
              <strong>Fecha actual:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}<br>
              <strong>Hora actual:</strong> ${hora}<br>
              ${direccionHtml}
            </div>
          </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
        modal.show();
      };

      // Guardar cambios de edici√≥n
      document.getElementById('editAppointmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const id = document.getElementById('editAppointmentId').value;
        const date = document.getElementById('editAppointmentDate').value;
        const time = document.getElementById('editAppointmentTime').value;
        const address = document.getElementById('editAppointmentAddress').value;
        const notes = document.getElementById('editAppointmentNotes').value;
        
        // Validaciones
        if (!date || !time) {
          showAlert('Fecha y hora son requeridas', 'danger');
          return;
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
        submitBtn.disabled = true;
        
        fetch(`https://daytona-clean-service.onrender.com/api/appointments/users/appointments/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            appointment_date: date,
            start_time: time,
            service_location: address,
            notes: notes
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Turno actualizado exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
            modal.hide();
            loadAppointments();
          } else {
            showAlert('Error actualizando turno: ' + (data.message || ''), 'danger');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al actualizar turno', 'danger');
        })
        .finally(() => {
          // Restaurar bot√≥n
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Cancelar turno
      window.cancelAppointment = function(appointmentId) {
        const appointment = currentAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('Turno no encontrado', 'danger');
          return;
        }
        
        // Verificar si el turno se puede cancelar
        if (appointment.status === 'cancelled') {
          showAlert('Este turno ya est√° cancelado', 'warning');
          return;
        }
        
        if (appointment.status === 'completed') {
          showAlert('No se puede cancelar un turno completado', 'warning');
          return;
        }
        
        // Mostrar informaci√≥n del turno a cancelar
        const servicesInfo = appointment.services && appointment.services.length > 0 
          ? appointment.services.map(s => `${s.service_name} x${s.quantity}`).join(', ')
          : 'No especificado';
        
        document.getElementById('cancelAppointmentInfo').innerHTML = `
          <div class="mb-2">
            <strong>Fecha:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}<br>
            <strong>Hora:</strong> ${appointment.start_time || 'No especificada'}<br>
            <strong>Servicios:</strong> ${servicesInfo}<br>
            <strong>Total:</strong> $${parseInt(appointment.total_amount || 0).toLocaleString('es-AR')}
          </div>
        `;
        
        // Configurar el bot√≥n de confirmaci√≥n
        const confirmBtn = document.getElementById('confirmCancelBtn');
        confirmBtn.onclick = function() {
          // Mostrar loading
          const originalText = confirmBtn.innerHTML;
          confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cancelando...';
          confirmBtn.disabled = true;
          
          fetch(`https://daytona-clean-service.onrender.com/api/appointments/users/appointments/${appointmentId}/cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Turno cancelado exitosamente', 'success');
              const modal = bootstrap.Modal.getInstance(document.getElementById('cancelConfirmModal'));
              modal.hide();
            loadAppointments();
          } else {
            showAlert('Error cancelando turno: ' + (data.message || ''), 'danger');
          }
        })
          .catch((error) => {
            console.error('Error:', error);
            showAlert('Error de conexi√≥n al cancelar turno', 'danger');
          })
          .finally(() => {
            // Restaurar bot√≥n
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
          });
        };
        
        // Mostrar modal de confirmaci√≥n
        const modal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
        modal.show();
      };

      // Funci√≥n para mostrar alertas
      function showAlert(message, type, duration = 5000, isHtml = false) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        if (isHtml) {
          alertDiv.innerHTML = message;
        } else {
          alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
        }
        alertContainer.appendChild(alertDiv);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, duration);
      }
      
      // Funci√≥n para refrescar la lista de turnos
      window.refreshAppointments = function() {
        console.log('üîÑ Refrescando lista de turnos...');
        loadAppointments();
      };
      
      // Funci√≥n para scroll suave a secciones
      function smoothScrollTo(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
          
          // Agregar efecto de highlight si es la secci√≥n de turnos activos
          if (elementId === 'turnos-activos') {
            element.classList.add('highlight');
            setTimeout(() => {
              element.classList.remove('highlight');
            }, 2000);
          }
        }
      }

      // Manejar enlaces internos con hash
      document.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' && e.target.getAttribute('href') && e.target.getAttribute('href').startsWith('#')) {
          e.preventDefault();
          const targetId = e.target.getAttribute('href').substring(1);
          smoothScrollTo(targetId);
        }
      });

      // Si hay un hash en la URL al cargar la p√°gina, hacer scroll
      if (window.location.hash) {
        setTimeout(() => {
          const targetId = window.location.hash.substring(1);
          smoothScrollTo(targetId);
        }, 500);
      }

      // Agregar botones de refrescar al DOM
      document.addEventListener('DOMContentLoaded', function() {
        // Bot√≥n para turnos activos
        const activeSection = document.querySelector('.active-appointments-section');
        if (activeSection) {
          const refreshActiveBtn = document.createElement('button');
          refreshActiveBtn.className = 'btn btn-outline-primary btn-sm ms-2';
          refreshActiveBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refrescar';
          refreshActiveBtn.onclick = refreshAppointments;
          
          const activeTitle = activeSection.querySelector('h3');
          if (activeTitle) {
            activeTitle.appendChild(refreshActiveBtn);
          }
        }

        // Bot√≥n para historial
        const historySection = document.querySelector('.appointments-history-section');
        if (historySection) {
          const refreshHistoryBtn = document.createElement('button');
          refreshHistoryBtn.className = 'btn btn-outline-secondary btn-sm ms-2';
          refreshHistoryBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refrescar';
          refreshHistoryBtn.onclick = refreshAppointments;
          
          const historyTitle = historySection.querySelector('h3');
          if (historyTitle) {
            historyTitle.appendChild(refreshHistoryBtn);
          }
        }
      });

      // ===== FUNCIONES DEL PANEL DE ADMINISTRACI√ìN =====
      
      // Cargar funcionalidades de admin
      function loadAdminFeatures() {
        console.log('üîÑ Cargando funcionalidades de admin...');
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminStats();
        loadAllAppointments();
        loadAdminReviews(); // Cargar rese√±as tambi√©n
        console.log('‚úÖ Funcionalidades de admin cargadas');
      }

      // Cargar estad√≠sticas del dashboard
      function loadAdminStats() {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            const appointments = data.appointments;
            
            // Calcular estad√≠sticas
            const total = appointments.length;
            const pending = appointments.filter(a => a.status === 'pending').length;
            const today = appointments.filter(a => {
              const today = new Date().toISOString().split('T')[0];
              return a.appointment_date === today;
            }).length;
            const revenue = appointments
              .filter(a => a.status === 'confirmed' || a.status === 'completed')
              .reduce((sum, a) => sum + parseFloat(a.total_amount || 0), 0);

            // Actualizar UI
            document.getElementById('totalAppointments').textContent = total;
            document.getElementById('pendingAppointments').textContent = pending;
            document.getElementById('todayAppointments').textContent = today;
            document.getElementById('totalRevenue').textContent = `$${revenue.toLocaleString()}`;
          }
        })
        .catch(error => {
          console.error('Error cargando estad√≠sticas:', error);
        });
      }

      // Cargar todos los turnos para admin
      function loadAllAppointments() {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            window.lastAdminAppointments = data.appointments; // Guardar para usar en el modal
            displayAdminAppointments(data.appointments);
          } else {
            document.getElementById('adminAppointmentsTableBody').innerHTML = 
              '<tr><td colspan="8" class="text-center">No se encontraron turnos</td></tr>';
          }
        })
        .catch(error => {
          console.error('Error cargando turnos:', error);
          document.getElementById('adminAppointmentsTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center text-danger">Error cargando turnos</td></tr>';
        });
      }

      // Mostrar turnos en tabla de admin
      function displayAdminAppointments(appointments) {
        const tbody = document.getElementById('adminAppointmentsTableBody');
        
        if (!appointments.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron turnos</td></tr>';
          return;
        }

        tbody.innerHTML = appointments.map(appointment => {
          // Mostrar detalles de servicios
          const servicesInfo = appointment.services && appointment.services.length > 0 
            ? appointment.services.map(s => {
                const nombre = s.nombre || s.name || s.service_name || 'Sin nombre';
                const tipo = s.tipo || s.type || '';
                const cantidad = s.cantidad || s.quantity || 1;
                return `${nombre}${tipo ? ' ('+tipo+')' : ''} x${cantidad}`;
              }).join('<br>')
            : appointment.service_type || 'No especificado';

          const total = appointment.total_amount || appointment.totalAmount || appointment.total_price
            ? `$${parseInt(appointment.total_amount || appointment.totalAmount || appointment.total_price).toLocaleString('es-AR')}`
            : 'A confirmar';

          // L√≥gica de direcci√≥n/log√≠stica profesional con iconos y color unificado
          let direccionHtml = '';
          const dir = appointment.service_location || appointment.serviceLocation || '';
          if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
            const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
            if (match) {
              direccionHtml = `
                <div><i class='fas fa-map-marker-alt me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Retiro:</span> <span style='font-weight:normal;color:#fff;'>${match[1].trim()}</span></div>
                <div><i class='fas fa-location-arrow me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Entrega:</span> <span style='font-weight:normal;color:#fff;'>${match[2].trim()}</span></div>
              `;
            } else {
              direccionHtml = `<div><i class='fas fa-map-marker-alt me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
            }
          } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
            direccionHtml = `<div><i class='fas fa-car me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Log√≠stica:</span> <span style='font-weight:normal;color:#fff;'>El cliente lleva el veh√≠culo a la instalaci√≥n</span></div>`;
          } else if (dir && dir.trim() && dir !== 'A confirmar') {
            direccionHtml = `<div><i class='fas fa-map-marker-alt me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
          } else {
            direccionHtml = `<div style='color: red; font-weight: bold;'>¬°Error! Direcci√≥n obligatoria no especificada. Contactar al administrador.</div>`;
          }

          return `
            <tr>
              <td><i class='fas fa-hashtag me-1' style='color:#00d4ff;'></i>#${appointment.id}</td>
              <td>
                <div style="margin-bottom: 6px;"><i class='fas fa-user me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Nombre:</span> <span style='font-weight:normal;color:#fff;'>${appointment.client_name || 'N/A'}</span></div>
                <div><i class='fas fa-phone me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Celular:</span> <span style='font-weight:normal;color:#fff;'>${appointment.client_phone || 'N/A'}</span></div>
                <div><i class='fas fa-envelope me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Mail:</span> <span style='font-weight:normal;color:#fff;'>${appointment.client_email || ''}</span></div>
                ${direccionHtml}
              </td>
              <td>${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}</td>
              <td>${appointment.start_time || appointment.appointment_time || 'N/A'}</td>
              <td>${servicesInfo}</td>
              <td>${total}</td>
              <td>
                <span class="badge bg-${getStatusBadge(appointment.status)}">
                  ${getStatusText(appointment.status)}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <i class="fas fa-cogs me-1" style="color:#adb5bd;"></i>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewAdminAppointment(${appointment.id})" title="Ver detalles">
                      <i class="fas fa-eye" style="color:#adb5bd;"></i>
                    </button>
                    ${appointment.status === 'pending' ? `
                      <button class="btn btn-outline-success" onclick="confirmAdminAppointment(${appointment.id})" title="Confirmar">
                        <i class="fas fa-check" style="color:#adb5bd;"></i>
                      </button>
                    ` : ''}
                    ${appointment.status === 'confirmed' ? `
                      <button class="btn btn-outline-info" onclick="sendReminderAdmin(${appointment.id})" title="Enviar Recordatorio">
                        <i class="fas fa-bell" style="color:#adb5bd;"></i>
                      </button>
                    ` : ''}
                    ${appointment.status !== 'cancelled' && appointment.status !== 'completed' ? `
                      <button class="btn btn-outline-danger" onclick="cancelAdminAppointment(${appointment.id})" title="Cancelar">
                        <i class="fas fa-times" style="color:#adb5bd;"></i>
                      </button>
                    ` : ''}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Filtrar turnos de admin
      window.filterAdminAppointments = function(filter) {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            let filteredAppointments = data.appointments;
            
            if (filter !== 'all') {
              filteredAppointments = data.appointments.filter(a => a.status === filter);
            }
            
            displayAdminAppointments(filteredAppointments);
          }
        })
        .catch(error => {
          console.error('Error filtrando turnos:', error);
        });
      };

      // Buscar turnos de admin
      window.searchAdminAppointments = function() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            const filteredAppointments = data.appointments.filter(appointment => 
              appointment.client_name?.toLowerCase().includes(searchTerm) ||
              appointment.client_phone?.includes(searchTerm) ||
              appointment.id.toString().includes(searchTerm)
            );
            
            displayAdminAppointments(filteredAppointments);
          }
        })
        .catch(error => {
          console.error('Error buscando turnos:', error);
        });
      };

      // Ver detalles de turno (admin)
      window.viewAdminAppointment = function(appointmentId) {
        const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
        if (!appointment) {
          showAlert('No se encontr√≥ el turno', 'danger');
          return;
        }
        const servicesInfo = appointment.services && appointment.services.length > 0 
          ? appointment.services.map(s => {
              const nombre = s.nombre || s.name || s.service_name || 'Sin nombre';
              const tipo = s.tipo || s.type || '';
              const cantidad = s.cantidad || s.quantity || 1;
              const precio = s.precio || s.price || '';
              return `${nombre}${tipo ? ' ('+tipo+')' : ''} x${cantidad}${precio ? ` ($${parseInt(precio).toLocaleString('es-AR')})` : ''}`;
            }).join('<br>')
          : appointment.service_type || 'No especificado';

        // L√≥gica para mostrar direcci√≥n/retira/entrega profesional
        let direccionHtml = '';
        const dir = appointment.service_location || appointment.serviceLocation || '';
        if (dir.includes('Retiro:') && dir.includes('Entrega:')) {
          const match = dir.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
          if (match) {
            direccionHtml = `
              <div><i class='fas fa-map-marker-alt me-1'></i><span style='font-weight:bold;color:#fff;'>Retiro:</span> <span style='font-weight:normal;color:#fff;'>${match[1].trim()}</span></div>
              <div><i class='fas fa-location-arrow me-1'></i><span style='font-weight:bold;color:#fff;'>Entrega:</span> <span style='font-weight:normal;color:#fff;'>${match[2].trim()}</span></div>
            `;
          } else {
            direccionHtml = `<div><i class='fas fa-map-marker-alt me-1'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
          }
        } else if (dir && dir.toLowerCase().includes('lleva el veh√≠culo')) {
          direccionHtml = `<div><i class='fas fa-car me-1'></i><span style='font-weight:bold;color:#fff;'>Log√≠stica:</span> <span style='font-weight:normal;color:#fff;'>El cliente lleva el veh√≠culo a la instalaci√≥n</span></div>`;
        } else if (dir && dir.trim() && dir !== 'A confirmar') {
          direccionHtml = `<div><i class='fas fa-map-marker-alt me-1'></i><span style='font-weight:bold;color:#fff;'>Direcci√≥n:</span> <span style='font-weight:normal;color:#fff;'>${dir}</span></div>`;
        } else {
          direccionHtml = `<div style='color: red; font-weight: bold;'>¬°Error! Direcci√≥n obligatoria no especificada. Contactar al administrador.</div>`;
        }

        const total = appointment.total_amount || appointment.totalAmount || appointment.total_price
          ? `$${parseInt(appointment.total_amount || appointment.totalAmount || appointment.total_price).toLocaleString('es-AR')}`
          : 'A confirmar';

        const html = `
          <div class="mb-2"><strong>ID:</strong> #${appointment.id}</div>
          <div class="mb-2"><strong>Cliente:</strong> ${appointment.client_name || 'N/A'}<br>
            <small style="color: #fff;">Celular: ${appointment.client_phone || 'N/A'}</small><br>
            <small style="color: #fff;">Mail: ${appointment.client_email || ''}</small><br>
            ${direccionHtml}
          </div>
          <div class="mb-2"><strong>Fecha:</strong> ${new Date(appointment.appointment_date).toLocaleDateString('es-AR')}</div>
          <div class="mb-2"><strong>Hora:</strong> ${appointment.start_time || appointment.appointment_time || 'N/A'}</div>
          <div class="mb-2"><strong>Servicios:</strong><br>${servicesInfo}</div>
          <div class="mb-2"><strong>Total:</strong> ${total}</div>
          <div class="mb-2"><strong>Estado:</strong> <span class="badge bg-${getStatusBadge(appointment.status)}">${getStatusText(appointment.status)}</span></div>
        `;
        showAlert(html, 'info', 0, true);
      };

      // Confirmar turno (admin)
      window.confirmAdminAppointment = function(appointmentId) {
        if (confirm('¬øConfirmar este turno?')) {
          fetch(`https://daytona-clean-service.onrender.com/api/appointments/admin/${appointmentId}/status`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'confirmed' })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showAlert('Turno confirmado exitosamente', 'success');
              
              // Mostrar notificaci√≥n web si est√° disponible
              if (window.showAppointmentConfirmation) {
                const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
                if (appointment) {
                  window.showAppointmentConfirmation(appointment);
                }
              }
              
              loadAllAppointments();
              loadAdminStats();
            } else {
              showAlert('Error confirmando turno: ' + (data.message || ''), 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showAlert('Error de conexi√≥n al confirmar turno', 'danger');
          });
        }
      };

      // Cancelar turno (admin)
      window.cancelAdminAppointment = function(appointmentId) {
        if (confirm('¬øCancelar este turno?')) {
          fetch(`https://daytona-clean-service.onrender.com/api/appointments/admin/${appointmentId}/cancel`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showAlert('Turno cancelado exitosamente', 'success');
              
              // Mostrar notificaci√≥n web si est√° disponible
              if (window.showAppointmentCancellation) {
                const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
                if (appointment) {
                  window.showAppointmentCancellation(appointment, 'Cancelado por el administrador');
                }
              }
              
              loadAllAppointments();
              loadAdminStats();
            } else {
              showAlert('Error cancelando turno: ' + (data.message || ''), 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showAlert('Error de conexi√≥n al cancelar turno', 'danger');
          });
        }
      };

      // Enviar recordatorio (admin)
      window.sendReminderAdmin = function(appointmentId) {
        if (confirm('¬øEnviar recordatorio de turno al cliente?')) {
          fetch(`https://daytona-clean-service.onrender.com/api/appointments/admin/${appointmentId}/reminder`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showAlert('Recordatorio enviado exitosamente', 'success');
              
              // Mostrar notificaci√≥n web si est√° disponible
              if (window.showAppointmentReminder) {
                const appointment = window.lastAdminAppointments?.find(a => a.id === appointmentId);
                if (appointment) {
                  window.showAppointmentReminder(appointment);
                }
              }
              
              loadAllAppointments();
            } else {
              showAlert('Error enviando recordatorio: ' + (data.message || ''), 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showAlert('Error de conexi√≥n al enviar recordatorio', 'danger');
          });
        }
      };

      // Exportar turnos
      window.exportAppointments = function() {
        fetch('https://daytona-clean-service.onrender.com/api/appointments/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.appointments) {
            // Crear CSV
            const csvContent = createCSV(data.appointments);
            downloadCSV(csvContent, 'turnos_export.csv');
            showAlert('Exportaci√≥n completada', 'success');
          }
        })
        .catch(error => {
          console.error('Error exportando:', error);
          showAlert('Error al exportar', 'danger');
        });
      };

      // Probar sistema de notificaciones
      window.testNotifications = function() {
        const phone = prompt('Ingresa un n√∫mero de tel√©fono para probar (opcional):');
        
        fetch('https://daytona-clean-service.onrender.com/api/notifications/test', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Prueba de notificaciones enviada exitosamente', 'success');
            
            // Mostrar notificaciones web de prueba
            if (window.showNotification) {
              window.showNotification('‚úÖ Notificaci√≥n de confirmaci√≥n de prueba', 'confirmation', 5000);
              setTimeout(() => {
                window.showNotification('‚ùå Notificaci√≥n de cancelaci√≥n de prueba', 'cancellation', 5000);
              }, 2000);
              setTimeout(() => {
                window.showNotification('‚è∞ Notificaci√≥n de recordatorio de prueba', 'reminder', 5000);
              }, 4000);
            }
          } else {
            showAlert('Error en prueba de notificaciones: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error probando notificaciones:', error);
          showAlert('Error de conexi√≥n al probar notificaciones', 'danger');
        });
      };

      // Crear contenido CSV
      function createCSV(appointments) {
        const headers = ['ID', 'Cliente', 'Tel√©fono', 'Fecha', 'Hora', 'Servicios', 'Total', 'Estado'];
        const rows = appointments.map(a => [
          a.id,
          a.client_name || 'N/A',
          a.client_phone || 'N/A',
          new Date(a.appointment_date).toLocaleDateString('es-AR'),
          a.start_time || 'N/A',
          a.services ? a.services.map(s => `${s.service_name} x${s.quantity}`).join(', ') : 'N/A',
          a.total_amount ? `$${parseInt(a.total_amount).toLocaleString()}` : 'N/A',
          getStatusText(a.status)
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
      }

      // Descargar CSV
      function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // ===== FUNCIONES PARA EDITAR PERFIL =====
      
      // Abrir modal de edici√≥n de perfil
      window.openEditProfileModal = function() {
        // Llenar el formulario con los datos actuales del usuario
        const user = JSON.parse(localStorage.getItem('userData') || '{}');
        
        // Asegurar que el nombre se cargue correctamente
        document.getElementById('editProfileName').value = user.name || 'No disponible';
        document.getElementById('editProfileEmail').value = user.email || '';
        document.getElementById('editProfilePhone').value = user.phone || '';
        
        // Limpiar campos de contrase√±a
        document.getElementById('editProfileCurrentPassword').value = '';
        document.getElementById('editProfileNewPassword').value = '';
        document.getElementById('editProfileConfirmPassword').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        modal.show();
      };

      // Manejar env√≠o del formulario de edici√≥n de perfil
      document.getElementById('editProfileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('editProfileName').value.trim();
        const email = document.getElementById('editProfileEmail').value.trim();
        const phone = document.getElementById('editProfilePhone').value.trim();
        const currentPassword = document.getElementById('editProfileCurrentPassword').value;
        const newPassword = document.getElementById('editProfileNewPassword').value;
        const confirmPassword = document.getElementById('editProfileConfirmPassword').value;
        
        // Validaciones b√°sicas
        if (!email || !phone) {
          showAlert('Email y tel√©fono son campos obligatorios', 'danger');
          return;
        }
        
        if (email && !isValidEmail(email)) {
          showAlert('Por favor ingresa un email v√°lido', 'danger');
          return;
        }
        
        // Validar contrase√±as si se van a cambiar
        if (newPassword || currentPassword || confirmPassword) {
          if (!currentPassword) {
            showAlert('Debes ingresar tu contrase√±a actual para cambiarla', 'danger');
            return;
          }
          
          if (!newPassword) {
            showAlert('Debes ingresar una nueva contrase√±a', 'danger');
            return;
          }
          
          if (newPassword.length < 6) {
            showAlert('La nueva contrase√±a debe tener al menos 6 caracteres', 'danger');
            return;
          }
          
          if (newPassword !== confirmPassword) {
            showAlert('Las contrase√±as no coinciden', 'danger');
            return;
          }
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
        submitBtn.disabled = true;
        
        // Preparar datos para enviar
        const updateData = {
          email,
          phone
        };
        
        if (newPassword) {
          updateData.currentPassword = currentPassword;
          updateData.newPassword = newPassword;
        }
        
        // Enviar actualizaci√≥n
        fetch('https://daytona-clean-service.onrender.com/api/users/profile', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Perfil actualizado exitosamente', 'success');
            
            // Actualizar datos en localStorage
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            userData.email = email;
            userData.phone = phone;
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // Actualizar la informaci√≥n mostrada en la p√°gina
            updateUserInfoDisplay(userData);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
          } else {
            showAlert('Error actualizando perfil: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al actualizar perfil', 'danger');
        })
        .finally(() => {
          // Restaurar bot√≥n
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Funci√≥n para validar email
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Funci√≥n para actualizar la informaci√≥n del usuario en la p√°gina
      function updateUserInfoDisplay(user) {
        const isAdmin = user.role === 'admin';
        
        document.getElementById('userDetails').innerHTML = `
          <div class="detail-item">
            <i class="fas fa-user"></i>
            <span><strong>Nombre:</strong> ${user.name}</span>
          </div>
          <div class="detail-item">
            <i class="fas fa-envelope"></i>
            <span><strong>Email:</strong> ${user.email}</span>
          </div>
          <div class="detail-item">
            <i class="fas fa-phone"></i>
            <span><strong>Tel√©fono:</strong> ${user.phone}</span>
          </div>
          ${isAdmin ? `
          <div class="detail-item admin-badge">
            <i class="fas fa-shield-alt" style="color: #ff6b35;"></i>
            <span><strong>Rol:</strong> <span class="badge bg-warning">Administrador</span></span>
          </div>
          ` : ''}
        `;
      }
    });

    // Scroll autom√°tico a #gestion-turnos si est√° en el hash y el panel admin aparece
    document.addEventListener('DOMContentLoaded', function() {
      if (window.location.hash === '#gestion-turnos') {
        const scrollToGestion = () => {
          const adminPanel = document.getElementById('adminPanel');
          const gestion = document.getElementById('gestion-turnos');
          if (adminPanel && adminPanel.style.display !== 'none' && gestion) {
            gestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return true;
          }
          return false;
        };
        // Intentar scroll varias veces por si el panel aparece despu√©s
        let intentos = 0;
        const intervalo = setInterval(() => {
          if (scrollToGestion() || ++intentos > 20) {
            clearInterval(intervalo);
          }
        }, 150);
      }
    });

    function mostrarDireccionAdmin(direccion) {
      if (!direccion || direccion === 'A confirmar') return 'A confirmar';
      if (direccion.toLowerCase().includes('lleva el veh√≠culo')) {
        return '<strong>Log√≠stica:</strong> El cliente lleva el veh√≠culo';
      }
      if (direccion.includes('Retiro:') && direccion.includes('Entrega:')) {
        const match = direccion.match(/Retiro:([^|]*)\| Entrega:([^|]*)/);
        if (match) {
          return `<strong>Retiro:</strong> ${match[1].trim()}<br><strong>Entrega:</strong> ${match[2].trim()}`;
        }
      }
      // Por defecto, para tapizados u otros servicios
      return `<strong>Direcci√≥n:</strong> ${direccion}`;
    }

    // ===== FUNCIONES DE GESTI√ìN DE RESE√ëAS =====
    
    let currentReviews = [];

    // Cargar funcionalidades de rese√±as para admin
    function loadAdminReviews() {
      console.log('üîÑ Cargando rese√±as de admin...');
      loadReviewsStats();
      loadAllReviews();
      console.log('‚úÖ Rese√±as de admin cargadas');
    }

    // Cargar estad√≠sticas de rese√±as
    function loadReviewsStats() {
      console.log('üîÑ Cargando estad√≠sticas de rese√±as...');
      fetch('https://daytona-clean-service.onrender.com/api/reviews/admin/stats', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        console.log('üìä Estad√≠sticas de rese√±as recibidas:', data);
        if (data.success && data.stats) {
          const stats = data.stats;
          document.getElementById('totalReviews').textContent = stats.total_reviews || 0;
          document.getElementById('pendingReviews').textContent = stats.pending_reviews || 0;
          document.getElementById('averageRating').textContent = (stats.average_rating || 0).toFixed(1);
          document.getElementById('fiveStarReviews').textContent = stats.five_star_count || 0;
          console.log('‚úÖ Estad√≠sticas de rese√±as actualizadas');
        }
      })
      .catch(error => {
        console.error('‚ùå Error cargando estad√≠sticas de rese√±as:', error);
      });
    }

    // Cargar todas las rese√±as para admin
    function loadAllReviews() {
      console.log('üîÑ Cargando todas las rese√±as...');
      fetch('https://daytona-clean-service.onrender.com/api/reviews/admin/all', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        console.log('üìù Rese√±as recibidas:', data);
        if (data.success && data.reviews) {
          currentReviews = data.reviews;
          displayAdminReviews(data.reviews);
          console.log('‚úÖ Rese√±as cargadas y mostradas');
        } else {
          document.getElementById('adminReviewsTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center">No se encontraron rese√±as</td></tr>';
          console.log('‚ÑπÔ∏è No se encontraron rese√±as');
        }
      })
      .catch(error => {
        console.error('‚ùå Error cargando rese√±as:', error);
        document.getElementById('adminReviewsTableBody').innerHTML = 
          '<tr><td colspan="8" class="text-center text-danger">Error cargando rese√±as</td></tr>';
      });
    }

    // Mostrar rese√±as en tabla de admin
    function displayAdminReviews(reviews) {
      const tbody = document.getElementById('adminReviewsTableBody');
      
      if (!reviews.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron rese√±as</td></tr>';
        return;
      }

      tbody.innerHTML = reviews.map(review => {
        const serviceType = getServiceTypeName(review.service_type);
        const ratingStars = '‚≠ê'.repeat(review.rating);
        const statusBadge = getReviewStatusBadge(review.is_approved);
        const comment = review.comment ? (review.comment.length > 50 ? review.comment.substring(0, 50) + '...' : review.comment) : 'Sin comentario';

        return `
          <tr>
            <td><i class='fas fa-hashtag me-1' style='color:#00d4ff;'></i>#${review.id}</td>
            <td>
              <div style="margin-bottom: 6px;"><i class='fas fa-user me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Nombre:</span> <span style='font-weight:normal;color:#fff;'>${review.user_name || 'N/A'}</span></div>
              <div><i class='fas fa-calendar me-1' style='color:#00d4ff;'></i><span style='font-weight:bold;color:#fff;'>Servicio:</span> <span style='font-weight:normal;color:#fff;'>${new Date(review.appointment_date).toLocaleDateString('es-AR')}</span></div>
            </td>
            <td>
              <div><i class='fas fa-tools me-1' style='color:#00d4ff;'></i><span style='font-weight:normal;color:#fff;'>${serviceType}</span></div>
              <small style="color: #888;">${review.service_type}</small>
            </td>
            <td>
              <div style="font-size: 14px; color: #ffd700;">${ratingStars}</div>
              <small style="color: #888;">${review.rating}/5</small>
            </td>
            <td>
              <div style="max-width: 200px; word-wrap: break-word;">${comment}</div>
              ${review.comment && review.comment.length > 50 ? `
                <button class="btn btn-sm btn-outline-info mt-1" onclick="viewFullComment(${review.id})">
                  <i class="fas fa-eye"></i> Ver completo
                </button>
              ` : ''}
            </td>
            <td>${new Date(review.created_at).toLocaleDateString('es-AR')}</td>
            <td>${statusBadge}</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <i class="fas fa-cogs me-1" style="color:#adb5bd;"></i>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" onclick="viewAdminReview(${review.id})" title="Ver detalles">
                    <i class="fas fa-eye" style="color:#adb5bd;"></i>
                  </button>
                  ${review.is_approved === null ? `
                    <button class="btn btn-outline-success" onclick="approveReview(${review.id})" title="Aprobar">
                      <i class="fas fa-check" style="color:#adb5bd;"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="rejectReview(${review.id})" title="Rechazar">
                      <i class="fas fa-times" style="color:#adb5bd;"></i>
                    </button>
                  ` : review.is_approved ? `
                    <button class="btn btn-outline-warning" onclick="rejectReview(${review.id})" title="Rechazar">
                      <i class="fas fa-ban" style="color:#adb5bd;"></i>
                    </button>
                  ` : `
                    <button class="btn btn-outline-success" onclick="approveReview(${review.id})" title="Aprobar">
                      <i class="fas fa-check" style="color:#adb5bd;"></i>
                    </button>
                  `}
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Obtener nombre del tipo de servicio
    function getServiceTypeName(serviceType) {
      const serviceNames = {
        'limpieza-auto': 'Limpieza de Auto',
        'limpieza-pickup': 'Limpieza de Pickup',
        'limpieza-suv': 'Limpieza de SUV',
        'limpieza-detallada-auto': 'Limpieza Detallada Auto',
        'limpieza-detallada-suv': 'Limpieza Detallada SUV',
        'limpieza-detallada-pickup': 'Limpieza Detallada Pickup',
        'restauracion-motor': 'Restauraci√≥n de Motor'
      };
      return serviceNames[serviceType] || serviceType;
    }

    // Obtener badge de estado de rese√±a
    function getReviewStatusBadge(isApproved) {
      if (isApproved === null) {
        return '<span class="badge bg-warning">Pendiente</span>';
      } else if (isApproved) {
        return '<span class="badge bg-success">Aprobada</span>';
      } else {
        return '<span class="badge bg-danger">Rechazada</span>';
      }
    }

    // Filtrar rese√±as de admin
    window.filterAdminReviews = function(filter) {
      if (!currentReviews.length) return;
      
      let filteredReviews = currentReviews;
      
      if (filter !== 'all') {
        filteredReviews = currentReviews.filter(review => {
          if (filter === 'pending') return review.is_approved === null;
          if (filter === 'approved') return review.is_approved === true;
          if (filter === 'rejected') return review.is_approved === false;
          return true;
        });
      }
      
      displayAdminReviews(filteredReviews);
    };

    // Buscar rese√±as de admin
    window.searchAdminReviews = function() {
      const searchTerm = document.getElementById('searchReviewsInput').value.toLowerCase();
      
      if (!currentReviews.length) return;
      
      const filteredReviews = currentReviews.filter(review => 
        review.user_name?.toLowerCase().includes(searchTerm) ||
        review.service_type?.toLowerCase().includes(searchTerm) ||
        review.comment?.toLowerCase().includes(searchTerm) ||
        review.id.toString().includes(searchTerm)
      );
      
      displayAdminReviews(filteredReviews);
    };

    // Ver detalles de rese√±a (admin)
    window.viewAdminReview = function(reviewId) {
      const review = currentReviews?.find(r => r.id === reviewId);
      if (!review) {
        showAlert('No se encontr√≥ la rese√±a', 'danger');
        return;
      }

      const serviceType = getServiceTypeName(review.service_type);
      const ratingStars = '‚≠ê'.repeat(review.rating);
      const statusBadge = getReviewStatusBadge(review.is_approved);

      const html = `
        <div class="mb-2"><strong>ID:</strong> #${review.id}</div>
        <div class="mb-2"><strong>Cliente:</strong> ${review.user_name || 'N/A'}</div>
        <div class="mb-2"><strong>Servicio:</strong> ${serviceType}</div>
        <div class="mb-2"><strong>Fecha del servicio:</strong> ${new Date(review.appointment_date).toLocaleDateString('es-AR')}</div>
        <div class="mb-2"><strong>Calificaci√≥n:</strong> ${ratingStars} (${review.rating}/5)</div>
        <div class="mb-2"><strong>Comentario:</strong> ${review.comment || 'Sin comentario'}</div>
        <div class="mb-2"><strong>Fecha de rese√±a:</strong> ${new Date(review.created_at).toLocaleDateString('es-AR')}</div>
        <div class="mb-2"><strong>Estado:</strong> ${statusBadge}</div>
      `;
      showAlert(html, 'info', 0, true);
    };

    // Ver comentario completo
    window.viewFullComment = function(reviewId) {
      const review = currentReviews?.find(r => r.id === reviewId);
      if (!review) {
        showAlert('No se encontr√≥ la rese√±a', 'danger');
        return;
      }

      const html = `
        <div class="mb-2"><strong>Comentario completo:</strong></div>
        <div class="alert alert-info">${review.comment}</div>
      `;
      showAlert(html, 'info', 0, true);
    };

    // Aprobar rese√±a
    window.approveReview = function(reviewId) {
      if (confirm('¬øAprobar esta rese√±a?')) {
        fetch(`https://daytona-clean-service.onrender.com/api/reviews/admin/${reviewId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isApproved: true })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert('Rese√±a aprobada exitosamente', 'success');
            loadAllReviews();
            loadReviewsStats();
          } else {
            showAlert('Error aprobando rese√±a: ' + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error de conexi√≥n al aprobar rese√±a', 'danger');
        });
      }
    };

    // Rechazar rese√±a
    window.rejectReview = function(reviewId) {
      const action = currentReviews?.find(r => r.id === reviewId)?.is_approved ? 'rechazar' : 'rechazar';
      if (confirm(`¬ø${action.charAt(0).toUpperCase() + action.slice(1)} esta rese√±a?`)) {
        fetch(`https://daytona-clean-service.onrender.com/api/reviews/admin/${reviewId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isApproved: false })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert(`Rese√±a ${action}da exitosamente`, 'success');
            loadAllReviews();
            loadReviewsStats();
          } else {
            showAlert(`Error ${action}ndo rese√±a: ` + (data.message || ''), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert(`Error de conexi√≥n al ${action} rese√±a`, 'danger');
        });
      }
    };

    // Exportar rese√±as
    window.exportReviews = function() {
      fetch('https://daytona-clean-service.onrender.com/api/reviews/admin/all', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.reviews) {
          // Crear CSV
          const csvContent = createReviewsCSV(data.reviews);
          downloadCSV(csvContent, 'rese√±as_export.csv');
          showAlert('Exportaci√≥n de rese√±as completada', 'success');
        }
      })
      .catch(error => {
        console.error('Error exportando rese√±as:', error);
        showAlert('Error al exportar rese√±as', 'danger');
      });
    };

    // Crear contenido CSV para rese√±as
    function createReviewsCSV(reviews) {
      const headers = ['ID', 'Cliente', 'Servicio', 'Calificaci√≥n', 'Comentario', 'Fecha Rese√±a', 'Estado'];
      const rows = reviews.map(r => [
        r.id,
        r.user_name || 'N/A',
        getServiceTypeName(r.service_type),
        r.rating,
        r.comment || 'Sin comentario',
        new Date(r.created_at).toLocaleDateString('es-AR'),
        r.is_approved === null ? 'Pendiente' : r.is_approved ? 'Aprobada' : 'Rechazada'
      ]);
      
      return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    // Funci√≥n para debuggear el token
    window.debugToken = function() {
      const token = localStorage.getItem('token');
      console.log('üîç DEBUG TOKEN:');
      console.log('Token existe:', !!token);
      console.log('Token completo:', token);
      console.log('Token length:', token ? token.length : 0);
      
      if (token) {
        try {
          // Intentar decodificar el token (sin verificar firma)
          const payload = JSON.parse(atob(token.split('.')[1]));
          console.log('Token payload:', payload);
          console.log('Token exp:', new Date(payload.exp * 1000));
          console.log('Token iat:', new Date(payload.iat * 1000));
          console.log('Token expirado:', Date.now() > payload.exp * 1000);
        } catch (e) {
          console.log('Error decodificando token:', e);
        }
      }
    };

    // Funci√≥n para mostrar/ocultar secci√≥n de rese√±as
    window.toggleReviewsSection = function() {
      const reviewsSection = document.getElementById('gestion-resenas');
      if (reviewsSection) {
        const isVisible = reviewsSection.style.display !== 'none';
        reviewsSection.style.display = isVisible ? 'none' : 'block';
        console.log('üîÑ Secci√≥n de rese√±as:', isVisible ? 'ocultada' : 'mostrada');
        
        if (!isVisible) {
          // Recargar rese√±as cuando se muestra
          loadAdminReviews();
        }
      } else {
        console.error('‚ùå No se encontr√≥ la secci√≥n de rese√±as');
      }
    };

    // Actualizar la funci√≥n loadAdminFeatures para incluir rese√±as
    const originalLoadAdminFeatures = window.loadAdminFeatures;
    window.loadAdminFeatures = function() {
      if (originalLoadAdminFeatures) {
        originalLoadAdminFeatures();
      }
      loadAdminReviews();
    };
  </script>
</body>
</html>